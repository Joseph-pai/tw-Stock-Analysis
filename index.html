<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ç£è‚¡å¸‚çµ‚æ¥µå°ˆæ¥­åˆ†æå™¨ - Joseph PAI 2025 (Final Fix v21)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> 
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; font-family: 'Microsoft JhengHei',sans-serif; }
        .container { max-width: 1350px; }
        .card { background: rgba(255,255,255,0.12); backdrop-filter: blur(12px); border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .score-big { font-size: 6.5rem; font-weight: 900; text-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        .badge-pos { background: #28a745; }
        .badge-neg { background: #dc3545; }
        .weight-input { width: 80px; text-align: center; font-weight: bold; background:#fff; color:#333; }
        .summary { background: rgba(0,0,0,0.4); padding: 30px; border-radius: 15px; margin: 30px 0; }
        footer { margin-top: 80px; padding: 30px; text-align: center; color: rgba(255,255,255,0.8); }
        .debug-log { max-height: 500px; overflow-y: auto; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; padding: 15px; border-radius: 8px; }
        .token-status { font-weight: bold; }
        .data-source { font-size: 0.8rem; color: #ffc107; margin-top: 10px; }
        .date-range-input { width: 120px; }
        .manual-input { width: 100%; text-align: center; font-size: 1rem; }
        .explanation { background: white; color: black; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .explanation h6 { color: #8B0000; margin-bottom: 5px; font-weight: bold; }
        .manual-input-cell { padding: 5px !important; width: 100px; }
        .manual-label { font-size: 1rem; color: #ffc107; font-weight: bold; }
        .table-header-red { background-color: #8B0000; color: white; }
        .period-select { width: 110px; font-size: 0.9rem; cursor: pointer; }
        /* ç§»é™¤åŸå…ˆçš„å¡ç‰‡æ¨£å¼ */
        .financial-period-controls { padding: 10px 0; border-radius: 5px; margin-bottom: 15px; border-top: 1px solid rgba(255,255,255,0.2); }
        .basis-box { background: rgba(0,0,0,0.3); border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px; }
        td, th { vertical-align: middle; }
    </style>
</head>
<body>
<div class="container py-5">

    <h1 class="text-center mb-2">å°ç£è‚¡å¸‚çµ‚æ¥µå°ˆæ¥­åˆ†æå™¨</h1>
    <p class="text-center text-white-50 mb-5">Joseph PAI 2025 11/25 å°ˆæ¥­è©•åˆ†è©³è§£ç‰ˆ â€¢ Netlify Functions</p>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text">FinMind Tokenï¼ˆé¸å¡«ï¼‰</span>
                <input type="text" id="tokenInput" class="form-control bg-white text-dark" placeholder="è²¼ä¸Š Token æˆ–ç•™ç©ºä½¿ç”¨å…¬é–‹è³‡æ–™">
                <button class="btn btn-warning fw-bold" id="saveToken">å„²å­˜</button>
            </div>
            <small class="text-white-50">å…è²»è¨»å†Š â†’ <a href="https://finmindtrade.com/analysis/#/account/register" target="_blank" class="text-warning">FinMindï¼ˆ30ç§’ï¼‰</a> ï½œ æˆ–ç›´æ¥ä½¿ç”¨è­‰äº¤æ‰€+è§€æ¸¬ç«™å…¬é–‹è³‡æ–™</small>
            <div id="tokenStatus" class="token-status mt-2"></div>
        </div>
    </div>
    
    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <form id="analyzeForm">
                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-white-50">é¸æ“‡é¡è‚¡</label>
                        <select id="stockCategory" class="form-select">
                            <option value="all">å…¨éƒ¨é¡è‚¡</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white-50">é¸æ“‡è‚¡ç¥¨</label>
                        <select id="stockSelect" class="form-select" required>
                            <option value="">è«‹å…ˆé¸æ“‡é¡è‚¡</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-2 mb-3 financial-period-controls">
                    <div class="col-auto">
                         <label for="yearSelectFinancial" class="form-label text-white-50 small">è²¡å ±å¹´åº¦</label>
                        <select class="form-select" id="yearSelectFinancial">
                            </select>
                    </div>
                    <div class="col-auto">
                        <label for="quarterSelectFinancial" class="form-label text-white-50 small">è²¡å ±å­£åº¦</label>
                        <select class="form-select" id="quarterSelectFinancial">
                            <option value="Q1">Q1</option>
                            <option value="Q2">Q2</option>
                            <option value="Q3">Q3</option>
                            <option value="Q4">Q4</option>
                        </select>
                    </div>
                    <div class="col-auto d-flex align-items-end">
                         <button class="btn btn-sm btn-info text-dark fw-bold" type="button" id="autoLoadFinancialsButton" style="height: 38px;">
                            <i class="fas fa-sync-alt"></i> è¼‰å…¥ä¸¦åŒæ­¥æœ€æ–°è²¡å ±
                        </button>
                    </div>
                    <div class="col-12">
                        <small class="text-white-50 mt-2">æ­¤é¸æ“‡ç”¨æ–¼ç²å–ä¸¦è¨ˆç®—æœ€æ–°çš„ ROE, EPS, **å­£ç‡Ÿæ”¶å¢ç‡** ç­‰æ•¸æ“šã€‚</small>
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-auto">
                        <label class="text-white-50 small">åƒ¹æ ¼åˆ†ææ™‚é–“ç¯„åœï¼š</label>
                    </div>
                    <div class="col-auto">
                        <select id="dateRange" class="form-select form-select-sm date-range-input">
                            <option value="30">æœ€è¿‘30å¤©</option>
                            <option value="60" selected>æœ€è¿‘60å¤©</option>
                            <option value="90">æœ€è¿‘90å¤©</option>
                            <option value="180">æœ€è¿‘åŠå¹´</option>
                            <option value="365">æœ€è¿‘ä¸€å¹´</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small">æˆ–è‡ªè¨‚ï¼š</span>
                    </div>
                    <div class="col-auto">
                        <input type="date" id="startDate" class="form-control form-control-sm date-range-input" placeholder="é–‹å§‹æ—¥æœŸ">
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small">åˆ°</span>
                    </div>
                    <div class="col-auto">
                        <input type="date" id="endDate" class="form-control form-control-sm date-range-input" placeholder="çµæŸæ—¥æœŸ">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-warning text-dark fw-bold" type="submit">ç«‹å³å°ˆæ¥­åˆ†æ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="text-center mb-4">
        <button class="btn btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#debugLog">
            é¡¯ç¤º/éš±è— é™¤éŒ¯æ—¥èªŒ
        </button>
    </div>

    <div class="collapse" id="debugLog">
        <div class="card mb-4">
            <div class="card-body p-3">
                <pre id="logContent" class="debug-log"></pre>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('logContent').textContent = '';">æ¸…é™¤æ—¥èªŒ</button>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center my-5" style="display:none;">
        <div class="spinner-border text-warning" style="width:6rem;height:6rem;"></div>
        <h3 class="mt-4">æ­£åœ¨æŠ“å–æœ€æ–°è³‡æ–™ (å¤šç¶­åº¦åˆ†æä¸­)â€¦</h3>
    </div>

    <div id="result" style="display:none;"></div>

</div> <footer>Â© 2025 Joseph PAI. All Rights Reserved. | è³‡æ–™ä¾†æºï¼šå°ç£è­‰åˆ¸äº¤æ˜“æ‰€ + FinMind + Yahoo Finance</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ================= åˆå§‹åŒ–èˆ‡å…¨åŸŸè®Šæ•¸ (ç•¥) =================
    let TOKEN = '';
    try { TOKEN = localStorage.getItem('joseph_pai_token_2025') || ''; } catch(e) {}

    let financialCache = {
        eps: { quarter: 'N/A', year: 'N/A' },
        roe: { quarter: 'N/A', year: 'N/A' },
        revenueGrowth: { month: 'N/A', quarter: 'N/A', year: 'N/A' },
        profitMargin: { quarter: 'N/A', year: 'N/A' }
    };

    const twseIndustryMap = {
        "01": "æ°´æ³¥å·¥æ¥­", "02": "é£Ÿå“å·¥æ¥­", "03": "å¡‘è† å·¥æ¥­", "04": "ç´¡ç¹”çº–ç¶­", "05": "é›»æ©Ÿæ©Ÿæ¢°",
        "06": "é›»å™¨é›»çºœ", "07": "åŒ–å­¸ç”ŸæŠ€é†«ç™‚", "08": "ç»ç’ƒé™¶ç“·", "09": "é€ ç´™å·¥æ¥­", "10": "é‹¼éµå·¥æ¥­",
        "11": "æ©¡è† å·¥æ¥­", "12": "æ±½è»Šå·¥æ¥­", "13": "é›»å­å·¥æ¥­", "14": "å»ºæç‡Ÿé€ ", "15": "èˆªé‹æ¥­",
        "16": "è§€å…‰äº‹æ¥­", "17": "é‡‘èä¿éšª", "18": "è²¿æ˜“ç™¾è²¨", "19": "ç¶œåˆ", "20": "å…¶ä»–",
        "21": "åŒ–å­¸å·¥æ¥­", "22": "ç”ŸæŠ€é†«ç™‚æ¥­", "23": "æ²¹é›»ç‡ƒæ°£æ¥­", "24": "åŠå°é«”æ¥­", "25": "é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­",
        "26": "å…‰é›»æ¥­", "27": "é€šä¿¡ç¶²è·¯æ¥­", "28": "é›»å­é›¶çµ„ä»¶æ¥­", "29": "é›»å­é€šè·¯æ¥­", "30": "è³‡è¨Šæœå‹™æ¥­",
        "31": "å…¶ä»–é›»å­æ¥­", "32": "æ–‡åŒ–å‰µæ„æ¥­", "33": "è¾²æ¥­ç§‘æŠ€æ¥­", "34": "é›»å­å•†å‹™æ¥­",
        "35": "ç¶ èƒ½ç’°ä¿", "36": "æ•¸ä½é›²ç«¯", "37": "é‹å‹•ä¼‘é–’", "38": "å±…å®¶ç”Ÿæ´»", "91": "å­˜è¨—æ†‘è­‰"
    };

    document.getElementById('tokenInput').value = TOKEN;
    document.getElementById('tokenStatus').innerHTML = TOKEN ? '<span style="color:#28a745">Token å·²å¾è¨˜éŒ„ä¸­è¼‰å…¥ (ä¸‹æ¬¡å…è¼¸å…¥)</span>' : '<span style="color:#ffc107">æœªè¨­å®š Tokenï¼Œå°‡ä½¿ç”¨å…¬é–‹è³‡æ–™</span>';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('endDate').value = today;
    
    const dateRangeEl = document.getElementById('dateRange');
    dateRangeEl.onchange = function() {
        const days = parseInt(this.value);
        const end = new Date();
        const start = new Date(end.getTime() - days * 24 * 60 * 60 * 1000);
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
    };
    dateRangeEl.dispatchEvent(new Event('change'));

    let stockData = [];
    let industryCategories = new Set();
    window.weights = { basic:35, technical:25, market:20, news:10, risk:10 };

    window.log = function(msg) {
        const logEl = document.getElementById('logContent');
        if (logEl) {
            logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        console.log(msg);
    }

    // ================= æ ¸å¿ƒ API å‡½æ•¸ (ç•¥) =================
    // ... (fetchFinmind, fetchYahooWithProxy, fetchTWSEPrice, fetchFullTWSEFinancials, fetchYahooFinanceFinancials ä¿æŒä¸è®Š)
    
    async function fetchFinmind(dataset, dataId = '', startDate = '', retries = 3) {
        if (!TOKEN && dataset !== 'TaiwanStockInfo') return null;
        let url = `/.netlify/functions/fetch-finmind?dataset=${dataset}`;
        if (dataId) url += `&data_id=${dataId}`;
        if (startDate) url += `&start_date=${startDate}`;
        if (TOKEN) url += `&token=${TOKEN}`;
        
        for (let attempt = 1; attempt <= retries; attempt++) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    if (attempt < retries) { await new Promise(r => setTimeout(r, 1000 * attempt)); continue; }
                    return null;
                }
                const data = await response.json();
                if (data.status === 200 && data.data) return data;
            } catch (err) { if (attempt < retries) await new Promise(r => setTimeout(r, 1000 * attempt)); }
        }
        return null;
    }

    async function fetchYahooWithProxy(symbol, logName) {
        log(`${logName} è«‹æ±‚ä¸­ (é€é Netlify Price Function ä»£ç†)...`);
        try {
            const response = await fetch(`/.netlify/functions/fetch-price?id=${symbol}`);
            if (!response.ok) {
                log(`${logName} ä»£ç†å¤±æ•—: ${response.status}`);
                return null;
            }
            const data = await response.json(); 
            if (data && data.chart?.result?.[0]) {
                log(`${logName} æˆåŠŸï¼`);
                return data;
            }
            log(`${logName} å¤±æ•—: æ ¼å¼éŒ¯èª¤`);
            return null;
        } catch (err) {
            log(`${logName} å¤±æ•—: ${err.message}`);
            return null;
        }
    }

    async function fetchTWSEPrice(stockId) {
        try {
            const response = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY?stockNo=${stockId}`);
            if (!response.ok) return null;
            const data = await response.json();
            return (data && Array.isArray(data) && data.length > 0) ? data : null;
        } catch (err) { return null; }
    }


    async function fetchFullTWSEFinancials(stockId) {
        log(`è­‰äº¤æ‰€è²¡å ± å¹´å ±/ç´¯ç©æ•¸æ“šè«‹æ±‚ä¸­... (${stockId})`);
        
        financialCache.eps.year = 'N/A';
        financialCache.roe.year = 'N/A';
        financialCache.profitMargin.year = 'N/A';
        financialCache.revenueGrowth.year = 'N/A';

        try {
            const [reportRes, ratioRes, monthlyRes] = await Promise.all([
                fetch(`/.netlify/functions/fetch-twse?type=quarterly`), 
                fetch(`/.netlify/functions/fetch-twse?type=annual`),    
                fetch(`/.netlify/functions/fetch-twse?type=monthly`)    
            ]);

            if (!reportRes.ok || !ratioRes.ok || !monthlyRes.ok) {
                log(`è­‰äº¤æ‰€ä»£ç†è«‹æ±‚å¤±æ•—`);
                return null;
            }

            const reportData = await reportRes.json();
            const ratioData = await ratioRes.json(); 
            const monthlyData = await monthlyRes.json(); 

            const findStocks = (data) => data ? data.filter(item => (String(item.Code) === stockId || String(item.å…¬å¸ä»£è™Ÿ) === stockId)) : [];
            
            const findValue = (obj, keywords) => {
                if (!obj) return null;
                const keys = Object.keys(obj);
                for (const kw of keywords) {
                    const match = keys.find(k => k.includes(kw));
                    if (match) {
                        const val = obj[match];
                        if (val !== null && val !== undefined && val !== '' && !isNaN(parseFloat(String(val).replace(/,/g, '')))) {
                            return val;
                        }
                    }
                }
                return null;
            };

            const stockReportList = findStocks(reportData);
            const stockRatioList = findStocks(ratioData); 
            const stockMonthly = findStocks(monthlyData)[0]; 

            const findValueInList = (list, keywords) => {
                for (const item of list) {
                    const val = findValue(item, keywords);
                    if (val) return val;
                }
                return null;
            };

            if (stockReportList.length > 0 || stockRatioList.length > 0 || stockMonthly) {
                // EPS (å¹´)
                financialCache.eps.year = findValueInList(stockReportList, ['åŸºæœ¬æ¯è‚¡ç›ˆé¤˜', 'EPS', 'æ¯è‚¡ç›ˆé¤˜']) || 'N/A';
                
                // ROE (å¹´)
                financialCache.roe.year = findValueInList(stockRatioList, ['æ¬Šç›Šå ±é…¬ç‡', 'ROE', 'è‚¡æ±æ¬Šç›Šå ±é…¬ç‡', 'ç´”ç›Šç‡']) || 'N/A';

                // æ¯›åˆ©ç‡ (å¹´)
                financialCache.profitMargin.year = findValueInList(stockRatioList, ['æ¯›åˆ©ç‡', 'ç‡Ÿæ¥­æ¯›åˆ©ç‡']) || 'N/A';
                
                // === ç´¯è¨ˆç‡Ÿæ”¶æˆé•·ç‡ (å¹´) ===
                let calculatedGrowth = 'N/A';
                
                const currentCumRaw = findValueInList(stockReportList, ['ç´¯è¨ˆç‡Ÿæ¥­æ”¶å…¥-ç•¶æœˆç´¯è¨ˆç‡Ÿæ”¶', 'æœ¬æœŸç´¯è¨ˆç‡Ÿæ¥­æ”¶å…¥']);
                const prevCumRaw = findValueInList(stockReportList, ['ç´¯è¨ˆç‡Ÿæ¥­æ”¶å…¥-å»å¹´ç´¯è¨ˆç‡Ÿæ”¶', 'ç´¯è¨ˆç‡Ÿæ¥­æ”¶å…¥-å»å¹´åŒæœŸç´¯è¨ˆç‡Ÿæ”¶', 'å»å¹´åŒæœŸç´¯è¨ˆç‡Ÿæ¥­æ”¶å…¥']);

                if (currentCumRaw && prevCumRaw) {
                    const current = parseFloat(String(currentCumRaw).replace(/,/g, ''));
                    const previous = parseFloat(String(prevCumRaw).replace(/,/g, ''));
                    
                    if (!isNaN(current) && !isNaN(previous) && previous !== 0) {
                        calculatedGrowth = (((current - previous) / previous) * 100).toFixed(2);
                        log(`*** ç´¯è¨ˆç‡Ÿæ”¶(å¹´)ï¼šä½¿ç”¨ t187ap05_L æ‰‹å‹•è¨ˆç®—: ${calculatedGrowth}%`);
                    }
                } else if (stockMonthly) {
                    const mCurr = findValue(stockMonthly, ['ç´¯è¨ˆç‡Ÿæ¥­æ”¶å…¥-ç•¶æœˆç´¯è¨ˆç‡Ÿæ”¶', 'ç•¶æœˆç´¯è¨ˆç‡Ÿæ”¶']);
                    const mPrev = findValue(stockMonthly, ['ç´¯è¨ˆç‡Ÿæ¥­æ”¶å…¥-å»å¹´ç´¯è¨ˆç‡Ÿæ”¶', 'å»å¹´ç´¯è¨ˆç‡Ÿæ”¶']);
                    if (mCurr && mPrev) {
                        const current = parseFloat(String(mCurr).replace(/,/g, ''));
                        const previous = parseFloat(String(mPrev).replace(/,/g, ''));
                        if (!isNaN(current) && !isNaN(previous) && previous !== 0) {
                            calculatedGrowth = (((current - previous) / previous) * 100).toFixed(2);
                            log(`*** ç´¯è¨ˆç‡Ÿæ”¶(å¹´)ï¼šä½¿ç”¨æœˆç‡Ÿæ”¶æ‰‹å‹•è¨ˆç®—: ${calculatedGrowth}%`);
                        }
                    }
                }
                
                financialCache.revenueGrowth.year = calculatedGrowth;

                // æœˆç‡Ÿæ”¶èˆ‡å­£ç‡Ÿæ”¶ (çŸ­æœŸæ•¸æ“š) - ç”±æ–°çš„å‡½æ•¸è¦†è“‹æˆ–è£œå……
                if (stockMonthly) {
                     financialCache.revenueGrowth.month = findValue(stockMonthly, ['ç‡Ÿæ¥­æ”¶å…¥-å»å¹´åŒæœˆå¢æ¸›(%)', 'å»å¹´åŒæœˆå¢æ¸›', 'å¢æ¸›ç™¾åˆ†æ¯”']) || 'N/A';
                     financialCache.revenueGrowth.quarter = findValue(stockMonthly, ['ç‡Ÿæ¥­æ”¶å…¥-ä¸Šæœˆæ¯”è¼ƒå¢æ¸›(%)', 'ä¸Šæœˆæ¯”è¼ƒå¢æ¸›']) || 'N/A';
                }

                log(`TWSE (å¹´) æ•¸æ“šæ›´æ–°: EPS=${financialCache.eps.year}, ROE=${financialCache.roe.year}, ç´¯è¨ˆç‡Ÿæ”¶æˆé•·=${financialCache.revenueGrowth.year}%`);
                return { source: 'TWSE (Multi-period)', ...financialCache }; 
            } else {
                log(`TWSE ä»£ç†æˆåŠŸä½†æœªæ‰¾åˆ° ${stockId} è³‡æ–™`);
                return null;
            }
        } catch (err) {
            log(`è­‰äº¤æ‰€æ•¸æ“šè™•ç†å¤±æ•—: ${err.message}`);
            return null;
        }
    }

    async function fetchYahooFinanceFinancials(stockId) {
        try {
            const response = await fetch(`/.netlify/functions/fetch-financials?id=${stockId}`);
            if (!response.ok) return null;
            const result = await response.json(); 
            if (result && !result.error) {
                financialCache.eps.year = result.defaultKeyStatistics?.trailingEps?.raw || 'N/A';
                financialCache.roe.year = result.financialData?.returnOnEquity?.raw ? result.financialData.returnOnEquity.raw * 100 : 'N/A';
                if (financialCache.revenueGrowth.year === 'N/A') {
                    financialCache.revenueGrowth.year = result.financialData?.revenueGrowth?.raw ? (result.financialData.revenueGrowth.raw * 100).toFixed(2) : 'N/A';
                }
                financialCache.profitMargin.year = result.financialData?.grossMargins?.raw ? result.financialData.grossMargins.raw * 100 : 'N/A';
                return { source: 'Yahoo Finance' };
            }
            return null;
        } catch (err) { return null; }
    }


    // ================= [ä¿®æ­£] A+B æ–¹æ¡ˆæ ¸å¿ƒé‚è¼¯ (è§£æ±º N/A å•é¡Œçš„å‰ç«¯å‘¼å«) =================

    // [ä¿®æ­£] è² è²¬å¾ Netlify å‡½æ•¸ç²å–ç‰¹å®šæœŸé–“çš„è²¡å ±æ•¸æ“šä¸¦æ›´æ–°ç·©å­˜
    async function fetchAndCacheSpecificFinancials(stockId, year, quarter) {
        log(`æ­£åœ¨ç²å–ä¸¦è¨ˆç®— [${stockId}] ${year}${quarter} è²¡å ±æ•¸æ“š (fetch-twse.js)...`);
        
        const loadingIndicator = document.getElementById('loading');
        if (loadingIndicator.style.display === 'none') {
             loadingIndicator.style.display = 'block';
        }

        try {
            // é—œéµï¼šå‘¼å«ä¿®æ”¹å¾Œçš„ fetch-twse.js
            const twseApiUrl = `/.netlify/functions/fetch-twse?type=quarterly_specific&stockCode=${stockId}&year=${year}&quarter=${quarter}`;
            const response = await fetch(twseApiUrl);

            if (!response.ok) throw new Error(`TWSE è²¡å ± API è«‹æ±‚å¤±æ•—: ${response.statusText}`);
            
            const processedData = await response.json(); 
            
            // âš ï¸ æª¢æŸ¥å¾Œç«¯æ˜¯å¦è¿”å›éŒ¯èª¤æ—¥èªŒ
            if (processedData.error) {
                log(`âš ï¸ å¾Œç«¯è¨ˆç®—éŒ¯èª¤: ${processedData.error}`);
                log(`å¾Œç«¯è©³ç´°è¨Šæ¯: ${processedData.detail || 'ç„¡'}`);
                return false;
            }

            if (processedData && processedData.data) {
                const data = processedData.data;
                
                // æª¢æŸ¥æ˜¯å¦æˆåŠŸç²å–æ•¸æ“š
                if(data.QuarterlyRevenueGrowth === 'N/A' && data.EPS === 'N/A') {
                    log('TWSE ä»£ç†æˆåŠŸï¼Œä½†è©²æœŸé–“ç„¡æ•¸æ“šæˆ–è¨ˆç®—å¤±æ•—ã€‚');
                    // å³ä½¿å¤±æ•—ï¼Œä¹Ÿè¦æ›´æ–°N/Aï¼Œé¿å…ä½¿ç”¨èˆŠçš„ç·©å­˜
                    financialCache.eps.quarter = 'N/A';
                    financialCache.roe.quarter = 'N/A';
                    financialCache.revenueGrowth.quarter = 'N/A'; 
                    financialCache.profitMargin.quarter = 'N/A';
                    updateFinancialUI();
                    return false;
                }
                
                // æ›´æ–° financialCache çš„å­£åº¦æ•¸æ“š
                financialCache.eps.quarter = data.EPS !== undefined ? data.EPS : 'N/A';
                financialCache.roe.quarter = data.ROE !== undefined ? data.ROE : 'N/A';
                financialCache.revenueGrowth.quarter = data.QuarterlyRevenueGrowth !== undefined ? data.QuarterlyRevenueGrowth : 'N/A'; 
                financialCache.profitMargin.quarter = data.GrossMarginRate !== undefined ? data.GrossMarginRate : 'N/A';
                
                financialCache.revenueGrowth.month = data.MonthlyRevenueGrowth !== undefined ? data.MonthlyRevenueGrowth : 'N/A';
                if (data.AnnualRevenueGrowth !== undefined) {
                    financialCache.revenueGrowth.year = data.AnnualRevenueGrowth;
                }

                log(`[${stockId}] ${year}${quarter} è²¡å ±æ•¸æ“š (å«å­£ç‡Ÿæ”¶å¢ç‡) æ›´æ–°æˆåŠŸã€‚`);
                updateFinancialUI(); 
                calculateBasicScoreFromManualInput(); 

                return true;
            } else {
                log('TWSE ä»£ç†æˆåŠŸä½†æœªæ‰¾åˆ°è¨ˆç®—å¾Œçš„è³‡æ–™ã€‚');
                return false;
            }
        } catch (err) {
            log(`å­£è²¡å ±æ•¸æ“šç²å–å¤±æ•—: ${err.message}`);
            return false;
        } finally {
             if (document.getElementById('analyzeForm').dataset.isSubmitting !== 'true') {
                 loadingIndicator.style.display = 'none';
             }
        }
    }


    // [ä¿®æ­£] A/B è§¸ç™¼èª¿ç”¨çš„ä¸»å‡½æ•¸ (è§¸ç™¼ç²å–èˆ‡æ›´æ–°)
    const loadQuarterlyFinancials = async () => {
        const stockCodeSelect = document.getElementById('stockSelect');
        const stockCode = stockCodeSelect ? stockCodeSelect.value.trim() : ''; 
        const year = document.getElementById('yearSelectFinancial').value;
        const quarter = document.getElementById('quarterSelectFinancial').value;
        
        if (!stockCode || !year || !quarter) {
            log("è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼ä¸¦é¸æ“‡å®Œæ•´çš„æœŸé–“ï¼Œæ‰èƒ½è¼‰å…¥è²¡å ±æ•¸æ“šã€‚");
            return;
        }
        
        document.getElementById('manualEps').value = '';
        document.getElementById('manualRoe').value = '';
        document.getElementById('manualRevenueGrowth').value = '';
        document.getElementById('manualProfitMargin').value = '';

        await fetchAndCacheSpecificFinancials(stockCode, year, quarter);
    }
    
    // ... (loadStockData, updateCategorySelect, updateStockSelect, saveToken, setupFinancialChangeListeners ç­‰å‡½æ•¸ä¿æŒä¸è®Š)

    async function loadStockData() {
        let isLoaded = false;
        
        if (TOKEN) {
            try {
                const finInfo = await fetchFinmind('TaiwanStockInfo');
                if (finInfo?.data && finInfo.data.length > 0) {
                    stockData = finInfo.data;
                    isLoaded = true;
                    log(`FinMind æˆåŠŸè¼‰å…¥ ${stockData.length} ç­†è‚¡ç¥¨è³‡æ–™`);
                }
            } catch (err) { console.error(err); }
        }

        if (!isLoaded) {
            log('åˆ‡æ›è‡³ TWSE è­‰äº¤æ‰€ä¾†æºç²å–è‚¡ç¥¨æ¸…å–®...');
            try {
                const response = await fetch('/.netlify/functions/fetch-twse?type=stocks');
                if (response.ok) {
                    const twseData = await response.json();
                    stockData = twseData.map(item => {
                        let category = item['ç”¢æ¥­åˆ¥'] || 'å…¶ä»–';
                        if (twseIndustryMap[category]) category = twseIndustryMap[category];
                        return {
                            stock_id: item.Code || item['å…¬å¸ä»£è™Ÿ'],
                            stock_name: item.Name || item['å…¬å¸ç°¡ç¨±'] || item['å…¬å¸åç¨±'],
                            industry_category: category
                        };
                    }).filter(s => s.stock_id && s.stock_name);
                    
                    const uniqueStocks = new Map();
                    stockData.forEach(s => uniqueStocks.set(s.stock_id, s));
                    stockData = Array.from(uniqueStocks.values());

                    if (stockData.length > 0) {
                        isLoaded = true;
                        log(`TWSE å‚™æ´æˆåŠŸè¼‰å…¥ ${stockData.length} ç­†è‚¡ç¥¨è³‡æ–™`);
                    }
                }
            } catch (err) { log(`TWSE å‚™æ´è¼‰å…¥å¤±æ•—: ${err.message}`); }
        }

        if (isLoaded) {
            industryCategories = new Set(stockData.map(stock => stock.industry_category).filter(Boolean));
            updateCategorySelect();
        } else {
            log('âŒ ç„¡æ³•è¼‰å…¥è‚¡ç¥¨æ¸…å–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
        }
    }

    function updateCategorySelect() {
        const categorySelect = document.getElementById('stockCategory');
        categorySelect.innerHTML = '<option value="all">å…¨éƒ¨é¡è‚¡</option>';
        industryCategories.forEach(category => {
            if (category) {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            }
        });
        updateStockSelect();
    }

    function updateStockSelect() {
        const category = document.getElementById('stockCategory').value;
        const stockSelect = document.getElementById('stockSelect');
        stockSelect.innerHTML = '';
        let filteredStocks = stockData;
        if (category !== 'all') filteredStocks = stockData.filter(stock => stock.industry_category === category);
        filteredStocks.sort((a, b) => a.stock_id.localeCompare(b.stock_id));
        filteredStocks.forEach(stock => {
            const option = document.createElement('option');
            option.value = stock.stock_id;
            option.textContent = `${stock.stock_id} ${stock.stock_name}`;
            stockSelect.appendChild(option);
        });
        if (filteredStocks.length === 0) stockSelect.appendChild(new Option('è©²é¡è‚¡ç„¡è‚¡ç¥¨è³‡æ–™', ''));
        
        if (stockSelect.value) {
             loadQuarterlyFinancials();
        }
    }
    document.getElementById('stockCategory').addEventListener('change', updateStockSelect);


    // ================= UI æ›´æ–°èˆ‡è©•åˆ†è¨ˆç®— (ç•¥) =================
    // ... (æ‰€æœ‰è¨ˆç®—ã€UIæ›´æ–°ã€ç›£è½å™¨ç­‰å‡½æ•¸ä¿æŒä¸è®Š)

    function initYearSelectFinancial() {
        const currentYear = new Date().getFullYear();
        const yearSelect = document.getElementById('yearSelectFinancial');
        if (!yearSelect) return;
        
        for (let i = 0; i < 5; i++) {
            const year = currentYear - i;
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }
        
        const currentMonth = new Date().getMonth() + 1; 
        const currentQuarter = Math.ceil(currentMonth / 3);
        
        let initialYear = currentYear;
        if (currentQuarter <= 2 && currentYear > 2000) { 
             initialYear = currentYear - 1;
        } else if (currentYear <= 2000) {
             initialYear = currentYear;
        }
        
        yearSelect.value = initialYear;
        const quarterSelect = document.getElementById('quarterSelectFinancial');
        if(quarterSelect) {
             let initialQuarter = 'Q4'; 
             if (currentQuarter > 0) {
                 initialQuarter = `Q${Math.max(1, currentQuarter - 1)}`;
             }
             quarterSelect.value = initialQuarter;
        }
    }
    
    function setupFinancialChangeListeners() {
        const stockSelect = document.getElementById('stockSelect');
        const yearSelect = document.getElementById('yearSelectFinancial');
        const quarterSelect = document.getElementById('quarterSelectFinancial');
        const autoLoadButton = document.getElementById('autoLoadFinancialsButton'); 
        
        if (stockSelect && yearSelect && quarterSelect && autoLoadButton) {
            stockSelect.addEventListener('change', loadQuarterlyFinancials); 
            yearSelect.addEventListener('change', loadQuarterlyFinancials);
            quarterSelect.addEventListener('change', loadQuarterlyFinancials);
            autoLoadButton.addEventListener('click', loadQuarterlyFinancials); 
            log("A æ–¹æ¡ˆ (è²¡å ±æœŸé–“è‡ªå‹•/æ‰‹å‹•æ›´æ–°) ç›£è½å™¨å·²å•Ÿç”¨ã€‚");
        }
    }
    

    function updateFinancialUI() {
        const getVal = (sel, key) => {
            const el = document.querySelector(`.period-select[data-type="${sel}"]`);
            if (!el) return 0;
            const period = el.value;
            
            let dataKey = 'year'; 
            if (period === 'å­£') dataKey = 'quarter';
            if (period === 'æœˆ') dataKey = 'month';
            if (period === 'å¹´' || period === 'å¹´(ç´¯è¨ˆ)') dataKey = 'year';

            const val = financialCache[key][dataKey];
            return (val === 'N/A' || val === undefined) ? 'N/A' : parseFloat(val);
        };

        const setUI = (id, val, suffix) => {
            const displayEl = document.getElementById(id);
            const displayVal = (val === 'N/A') ? 'N/A' : `${val.toFixed(2)}${suffix}`;
            if (displayEl) displayEl.textContent = displayVal;
        };

        const eps = getVal('eps', 'eps');
        setUI('displayEps', eps, ' å…ƒ');

        const roe = getVal('roe', 'roe');
        setUI('displayRoe', roe, '%');

        const rev = getVal('revenue', 'revenueGrowth');
        setUI('displayRevenue', rev, '%');

        const margin = getVal('margin', 'profitMargin');
        setUI('displayMargin', margin, '%');

        calculateBasicScoreFromManualInput();
    }

    function setupPeriodChangeListeners() {
        document.querySelectorAll('.period-select').forEach(select => {
            select.addEventListener('change', updateFinancialUI);
        });
    }
    
    function setupManualInputListeners() {
        document.querySelectorAll('.manual-input').forEach(input => {
            input.addEventListener('change', calculateBasicScoreFromManualInput);
        });
    }
    
    window.calculateBasicScoreFromManualInput = function() {
        // ... (calculation logic)
        const getNum = (id, sel, key) => {
            const manualVal = parseFloat(document.getElementById(id)?.value);
            if (!isNaN(manualVal)) return manualVal;

            const el = document.querySelector(`.period-select[data-type="${sel}"]`);
            if (!el) return NaN;
            const period = el.value;
            let dataKey = 'year';
            if (period === 'å­£') dataKey = 'quarter';
            if (period === 'æœˆ') dataKey = 'month';
            if (period === 'å¹´(ç´¯è¨ˆ)') dataKey = 'year';
            
            const cacheVal = financialCache[key][dataKey];
            return (cacheVal === 'N/A' || cacheVal === undefined) ? NaN : parseFloat(cacheVal);
        };

        const epsInput = getNum('manualEps', 'eps', 'eps');
        const roeInput = getNum('manualRoe', 'roe', 'roe');
        const revenueGrowthInput = getNum('manualRevenueGrowth', 'revenue', 'revenueGrowth');
        const profitMarginInput = getNum('manualProfitMargin', 'margin', 'profitMargin');
        
        let basicScore = 0;
        let reasons = [];
        
        if (!isNaN(epsInput)) {
            if (epsInput >= 8) { basicScore += 30; reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 8 (+30)`); }
            else if (epsInput >= 5) { basicScore += 25; reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 5 (+25)`); }
            else if (epsInput >= 3) { basicScore += 18; reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 3 (+18)`); }
            else if (epsInput >= 0) { basicScore += 5; reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 0 (+5)`); }
            else { basicScore -= 15; reasons.push(`EPS ${epsInput.toFixed(2)} < 0 (-15)`); }
        } else { reasons.push('EPS ç„¡æ•¸æ“š'); }

        if (!isNaN(roeInput)) {
            if (roeInput >= 15) { basicScore += 30; reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¥ 15% (+30)`); }
            else if (roeInput >= 10) { basicScore += 20; reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¥ 10% (+20)`); }
            else if (roeInput >= 5) { basicScore += 10; reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¥ 5% (+10)`); }
            else if (roeInput > 0) { basicScore += 5; reasons.push(`ROE ${roeInput.toFixed(2)}% > 0% (+5)`); }
            else { basicScore -= 10; reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¤ 0% (-10)`); }
        } else { reasons.push('ROE ç„¡æ•¸æ“š'); }

        if (!isNaN(revenueGrowthInput)) {
            if (revenueGrowthInput >= 30) { basicScore += 30; reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% â‰¥ 30% (+30)`); }
            else if (revenueGrowthInput >= 10) { basicScore += 20; reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% â‰¥ 10% (+20)`); }
            else if (revenueGrowthInput > 0) { basicScore += 10; reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% > 0% (+10)`); }
            else { basicScore -= 10; reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% â‰¤ 0% (-10)`); }
        } else { reasons.push('ç‡Ÿæ”¶å¢ç‡ ç„¡æ•¸æ“š'); }

        if (!isNaN(profitMarginInput)) {
            if (profitMarginInput >= 50) { basicScore += 10; reasons.push(`æ¯›åˆ© ${profitMarginInput.toFixed(2)}% â‰¥ 50% (+10)`); }
            else if (profitMarginInput >= 20) { basicScore += 5; reasons.push(`æ¯›åˆ© ${profitMarginInput.toFixed(2)}% â‰¥ 20% (+5)`); }
            else { reasons.push(`æ¯›åˆ© ${profitMarginInput.toFixed(2)}% < 20% (0)`); }
        } else { reasons.push('æ¯›åˆ© ç„¡æ•¸æ“š'); }
        
        const weight = weights.basic || 35;
        const finalBasicScore = Math.max(-weight, Math.min(weight, Math.round(basicScore / 100 * weight)));
        
        const basicScoreEl = document.getElementById('score_basic');
        if (basicScoreEl) {
            basicScoreEl.textContent = `${finalBasicScore >= 0 ? '+' : ''}${finalBasicScore}`;
            basicScoreEl.className = `badge ${finalBasicScore>=0?'badge-pos':'badge-neg'} fs-5`;
        }
        
        const descEl = document.querySelector('#scoreTable tbody tr:nth-child(1) td:nth-child(4)');
        if (descEl) descEl.innerHTML = `<small>${reasons.join('<br>')}</small>`;
        
        updateTotalScore();
    };


    document.getElementById('analyzeForm').onsubmit = async e => {
        e.preventDefault();
        const symbol = document.getElementById('stockSelect').value.trim();
        if (!symbol) { alert('è«‹é¸æ“‡è‚¡ç¥¨'); return; }
        
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        log(`=== åˆ†æé–‹å§‹ï¼š${symbol} ===`);
        document.getElementById('loading').style.display = 'block';
        document.getElementById('result').style.display = 'none';
        document.getElementById('logContent').textContent = '';
        
        document.getElementById('analyzeForm').dataset.isSubmitting = 'true';

        try {
            let name = symbol;
            let industry = 'æœªçŸ¥';
            if (stockData.length > 0) {
                const stock = stockData.find(s => s.stock_id === symbol);
                if (stock) { name = stock.stock_name; industry = stock.industry_category; }
            }

            let priceDataFinal = await fetchYahooWithProxy(`${symbol}.TW`, 'è‚¡åƒ¹');
            if (!priceDataFinal && !TOKEN) { 
                const twsePrice = await fetchTWSEPrice(symbol);
                if (twsePrice) {
                     priceDataFinal = { chart: { result: [{ timestamp: twsePrice.map(d => { const p=d.Date.split('/'); return new Date(`${+p[0]+1911}-${p[1]}-${p[2]}`).getTime()/1000; }), indicators: { quote: [{ close: twsePrice.map(d => parseFloat(d.Close.replace(/,/g, ''))) }] } }] } };
                }
            }
            if (!priceDataFinal) throw new Error('ç„¡æ³•å–å¾—è‚¡åƒ¹è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦');

            // 1. ä½¿ç”¨æœŸé–“é¸æ“‡å™¨æŠ“å–æœ€æ–°çš„å­£åº¦è²¡å ±æ•¸æ“š (A+Bæ–¹æ¡ˆçš„æ ¸å¿ƒ)
            const financialYear = document.getElementById('yearSelectFinancial').value;
            const financialQuarter = document.getElementById('quarterSelectFinancial').value;
            await fetchAndCacheSpecificFinancials(symbol, financialYear, financialQuarter); 
            
            // 2. ç²å–å¹´å ±æ•¸æ“š (ä½œç‚ºåŸºæœ¬é¢è©•åˆ†çš„å‚™ç”¨å’Œè£œå……)
            let financialData = await fetchFullTWSEFinancials(symbol); 
            if (!financialData || financialCache.eps.year === 'N/A' || financialCache.revenueGrowth.year === 'N/A') {
                 financialData = await fetchYahooFinanceFinancials(symbol); 
            }
            
            // ... (æŠ€è¡“é¢/å¸‚å ´é¢/æ¶ˆæ¯é¢/é¢¨éšªé¢è¨ˆç®—é‚è¼¯ä¿æŒä¸è®Š)

            let newsRaw = null;
            if (TOKEN) newsRaw = await fetchFinmind('TaiwanStockNews', symbol, startDate);

            let marketData = await fetchYahooWithProxy('%5ETWII', 'å¤§ç›¤');

            const allTimestamps = priceDataFinal.chart.result[0].timestamp;
            const allCloses = priceDataFinal.chart.result[0].indicators.quote[0].close;
            const startTs = new Date(startDate).getTime() / 1000;
            const endTs = new Date(endDate).getTime() / 1000;
            
            const filteredData = allTimestamps.map((ts, i) => ({ ts, close: allCloses[i] })).filter(d => d.ts >= startTs && d.ts <= endTs && d.close);
            const closes = filteredData.map(d => d.close);
            const timestamps = filteredData.map(d => d.ts);
            
            if (closes.length === 0) throw new Error('æŒ‡å®šæ—¥æœŸç¯„åœå…§ç„¡è‚¡åƒ¹è³‡æ–™');

            const price = closes.at(-1).toFixed(2);
            const risePercent = closes.length >= 2 ? ((closes.at(-1) - closes[0]) / closes[0] * 100).toFixed(2) : 0;
            
            const techW = weights.technical || 25;
            let techScore = 0;
            let techReason = 'å€é–“éœ‡ç›ª';
            if (risePercent >= 30) { 
                techScore = techW; 
                techReason = `å€é–“æ¼²å¹… ${risePercent}% (â‰¥30% ç²æ»¿åˆ†)`; 
            } else if (risePercent >= 15) { 
                techScore = Math.round(techW * 0.8); 
                techReason = `å€é–“æ¼²å¹… ${risePercent}% (â‰¥15% ç²80%åˆ†)`; 
            } else if (risePercent >= 5) { 
                techScore = Math.round(techW * 0.4); 
                techReason = `å€é–“æ¼²å¹… ${risePercent}% (â‰¥5% ç²40%åˆ†)`; 
            } else if (risePercent < -10) { 
                techScore = -Math.round(techW * 0.8); 
                techReason = `å€é–“è·Œå¹… ${risePercent}% (<-10% æ‰£åˆ†)`; 
            } else {
                techScore = 0; 
                techReason = `å€é–“æ¼²è·Œ ${risePercent}% (ç›¤æ•´ä¸è¨ˆåˆ†)`; 
            }

            const marketW = weights.market || 20;
            let marketScore = 0; 
            let marketReason = 'ç„¡è³‡æ–™';
            if (marketData) {
                const mCloses = marketData.chart.result[0].indicators.quote[0].close.filter(Boolean);
                const mStart = mCloses[mCloses.length - closes.length] || mCloses[0];
                const mEnd = mCloses[mCloses.length - 1];
                const mRise = ((mEnd - mStart) / mStart * 100).toFixed(2);
                const beat = (parseFloat(risePercent) - parseFloat(mRise)).toFixed(1);
                
                if (beat >= 20) { 
                    marketScore = marketW; 
                    marketReason = `å¼·æ–¼å¤§ç›¤ ${beat}% (â‰¥20% ç²æ»¿åˆ†)`; 
                } else if (beat >= 0) { 
                    marketScore = Math.round(marketW * 0.4); 
                    marketReason = `å¼·æ–¼å¤§ç›¤ ${beat}% (â‰¥0% ç²40%åˆ†)`; 
                } else { 
                    marketScore = -Math.round(marketW * 0.6); 
                    marketReason = `å¼±æ–¼å¤§ç›¤ ${beat}% (è½å¾Œæ‰£åˆ†)`; 
                }
            }

            const newsW = weights.news || 10;
            let newsScore = 0;
            let newsReason = 'ç„¡æ–°è';
            if (newsRaw?.data?.length > 0) {
                let sentiment = 0;
                newsRaw.data.slice(0,30).forEach(n => {
                    if (n.title.match(/ç²åˆ©|æˆé•·|æ–°é«˜|è¨‚å–®|å¤§æ¼²/)) sentiment++;
                    if (n.title.match(/è™§æ|è¡°é€€|è£å“¡|åˆ©ç©º|å¤§è·Œ/)) sentiment--;
                });
                if (sentiment >= 5) { 
                    newsScore = newsW; 
                    newsReason = `æƒ…ç·’æŒ‡æ•¸ ${sentiment} (â‰¥5 ç²æ»¿åˆ†)`; 
                } else if (sentiment > 0) { 
                    newsScore = Math.round(newsW * 0.5); 
                    newsReason = `æƒ…ç·’æŒ‡æ•¸ ${sentiment} (>0 ç²50%åˆ†)`; 
                } else { 
                    newsScore = -Math.round(newsW * 0.5); 
                    newsReason = `æƒ…ç·’æŒ‡æ•¸ ${sentiment} (â‰¤0 åç©ºæ‰£åˆ†)`; 
                }
            }
            
            const riskW = weights.risk || 10;
            let riskScore = 0;
            let riskReason = 'ç„¡é‡å¤§é¢¨éšª'; 

            const currentEPS = parseFloat(financialCache.eps.year); 
            const currentROE = parseFloat(financialCache.roe.year);
            
            if (!isNaN(currentEPS) && !isNaN(currentROE)) {
                if (currentEPS < 0 && currentROE < 0) {
                    riskScore = -riskW;
                    riskReason = `EPS(${currentEPS})èˆ‡ROE(${currentROE})é›™è™§æ (é‡æ‰£)`;
                } else if (currentEPS < 0) {
                    riskScore = -Math.round(riskW * 0.5);
                    riskReason = `EPS(${currentEPS}) ç‚ºè² å€¼ (æ‰£åˆ†)`;
                } else {
                    riskScore = 0;
                    riskReason = `EPS(${currentEPS})èˆ‡ROE(${currentROE})çš†ç‚ºæ­£ (ç„¡é¢¨éšª)`;
                }
            } else {
                 riskReason = "ç„¡å®Œæ•´è²¡å ±æ•¸æ“š (ä¸è¨ˆåˆ†)";
            }


            const finSource = financialData?.source || 'ç„¡';
            
            // ä»¥ä¸‹ç‚ºçµæœé¡¯ç¤º HTML (åˆ·æ–°æŒ‰éˆ•å·²ä¿ç•™åœ¨è¡¨æ ¼ä¸‹æ–¹)
            document.getElementById('result').innerHTML = `
                <div class="text-center mb-5">
                    <h2>${symbol} ${name} <small class="text-info">(${industry})</small></h2>
                    <div id="finalScore"><h1 class="score-big">--</h1></div>
                    <p class="lead">æ•´é«”å¸‚å ´è¶¨å‹¢è©•åˆ† <span id="weightHint" style="color:yellow"></span></p>
                    <p class="fs-5">ç¾åƒ¹ ${price} ï½œ æœŸé–“æ¼²è·Œ ${risePercent}%</p>
                    <p class="data-source">è³‡æ–™ä¾†æº: è‚¡åƒ¹(Yahoo) è²¡å ±(${finSource})</p>
                </div>

                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="card text-dark">
                            <div class="card-header bg-primary text-white"><strong>æœ€æ–°è²¡å ±æ•¸æ“š</strong></div>
                            <table class="table table-striped mb-0">
                                <thead><tr><th>é¢å‘</th><th>æœŸé–“</th><th>æ•¸å€¼</th><th class="manual-label">è¼¸å…¥</th></tr></thead>
                                <tbody>
                                    <tr>
                                        <td>EPS</td>
                                        <td><select class="form-select period-select" data-type="eps"><option value="å­£">å­£</option><option value="å¹´">å¹´</option></select></td>
                                        <td class="fw-bold fs-5" id="displayEps">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualEps" class="form-control manual-input" step="0.01"></td>
                                    </tr>
                                    <tr>
                                        <td>ROE</td>
                                        <td><select class="form-select period-select" data-type="roe"><option value="å­£">å­£</option><option value="å¹´">å¹´</option></select></td>
                                        <td class="fs-5" id="displayRoe">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualRoe" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                    <tr>
                                        <td>ç‡Ÿæ”¶å¢ç‡</td>
                                        <td><select class="form-select period-select" data-type="revenue"><option value="æœˆ">æœˆ</option><option value="å­£">å­£</option><option value="å¹´">å¹´(ç´¯è¨ˆ)</option></select></td>
                                        <td class="fs-5" id="displayRevenue">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualRevenueGrowth" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                    <tr>
                                        <td>æ¯›åˆ©ç‡</td>
                                        <td><select class="form-select period-select" data-type="margin"><option value="å­£">å­£</option><option value="å¹´">å¹´</option></select></td>
                                        <td class="fs-5" id="displayMargin">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualProfitMargin" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="card-footer bg-white text-end">
                                <button class="btn btn-warning text-dark fw-bold" type="button" id="refreshFinancialsButton" style="width: 150px;">
                                    <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•¸æ“š
                                </button>
                            </div>
                            
                            <div class="explanation mt-3">
                                <h6>ğŸ“Š å°ˆæ¥­è©•åˆ†é …ç›®èªªæ˜</h6>
                                <ul class="mb-0 small ps-3">
                                    <li><strong>1. åŸºæœ¬é¢ (35%):</strong> ä¾æ“šè²¡å ±æ•¸å€¼è©•åˆ† (EPS>8, ROE>15%, ç‡Ÿæ”¶æˆé•·>30% ç‚ºæ»¿åˆ†)ã€‚</li>
                                    <li><strong>2. æŠ€è¡“é¢ (25%):</strong> ä¾æ“šå€é–“è‚¡åƒ¹æ¼²è·Œå¹…åˆ¤æ–·å‹•èƒ½ (æ¼²å¹…>30%æ»¿åˆ†)ã€‚</li>
                                    <li><strong>3. å¸‚å ´é¢ (20%):</strong> èˆ‡å¤§ç›¤æŒ‡æ•¸åŒæœŸæ¼²è·Œå¹…æ¯”è¼ƒï¼Œå‹éå¤§ç›¤å³å¾—åˆ†ã€‚</li>
                                    <li><strong>4. æ¶ˆæ¯é¢ (10%):</strong> åˆ†æè¿‘æœŸæ–°èé—œéµå­— (ç‡Ÿæ”¶æ–°é«˜/æˆé•· vs è¡°é€€/è£å“¡)ã€‚</li>
                                    <li><strong>5. é¢¨éšªé¢ (10%):</strong> é‡å°è²¡å‹™èµ¤å­— (è² EPS/ROE) é€²è¡Œé¢¨éšªæ‰£åˆ†ã€‚</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-7">
                        <div class="card text-dark">
                            <div class="card-header bg-danger text-white table-header-red"><strong>å°ˆæ¥­è©•åˆ†</strong></div>
                            <table class="table table-striped mb-0" id="scoreTable">
                                <thead><tr><th>é¢å‘</th><th>æ¬Šé‡%</th><th>å¾—åˆ†</th><th>èªªæ˜</th></tr></thead>
                                <tbody>
                                    <tr><td>åŸºæœ¬é¢</td><td><input type="number" data-field="basic" class="form-control weight-input" value="${weights.basic}" onchange="adjustWeights('basic',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_basic">0</span></td><td>è²¡å ±</td></tr>
                                    <tr><td>æŠ€è¡“é¢</td><td><input type="number" data-field="technical" class="form-control weight-input" value="${weights.technical}" onchange="adjustWeights('technical',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_technical">${techScore}</span></td><td>${techReason}</td></tr>
                                    <tr><td>å¸‚å ´é¢</td><td><input type="number" data-field="market" class="form-control weight-input" value="${weights.market}" onchange="adjustWeights('market',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_market">${marketScore}</span></td><td>${marketReason}</td></tr>
                                    <tr><td>æ¶ˆæ¯é¢</td><td><input type="number" data-field="news" class="form-control weight-input" value="${weights.news}" onchange="adjustWeights('news',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_news">${newsScore}</span></td><td>${newsReason}</td></tr>
                                    <tr><td>é¢¨éšªé¢</td><td><input type="number" data-field="risk" class="form-control weight-input" value="${weights.risk}" onchange="adjustWeights('risk',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_risk">${riskScore}</span></td><td>${riskReason}</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-body"><canvas id="priceChart"></canvas></div>
                </div>
            `;
            
            setupPeriodChangeListeners();
            setupManualInputListeners();
            setupManualRefreshListener(); 

            updateFinancialUI(); 

            new Chart(document.getElementById('priceChart'), {
                type: 'line',
                data: {
                    labels: timestamps.map(t => new Date(t*1000).toLocaleDateString('zh-TW',{month:'numeric',day:'numeric'})),
                    datasets: [
                        { label: name, data: closes, borderColor: '#00ff88', tension: 0.3, fill: false, pointRadius: 0 },
                        { label: 'å¤§ç›¤', data: marketData?.chart?.result[0].indicators.quote[0].close.slice(-closes.length) || [], borderColor: '#ff4444', tension: 0.3, fill: false, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, interaction: { mode: 'index', intersect: false }, plugins: { legend: { labels: { color: 'black' } } }, scales: { x: { ticks: { color: 'black' } }, y: { ticks: { color: 'black' } } } }
            });

            document.getElementById('result').style.display = 'block';

        } catch (err) {
            log(`éŒ¯èª¤: ${err.message}`);
            document.getElementById('result').innerHTML = `<div class="alert alert-danger text-center py-5"><h3>${err.message}</h3></div>`;
            document.getElementById('result').style.display = 'block';
        }
        document.getElementById('analyzeForm').dataset.isSubmitting = 'false';
        document.getElementById('loading').style.display = 'none';
    };
    
    function setupManualRefreshListener() {
        const refreshButton = document.getElementById('refreshFinancialsButton');
        if (refreshButton) {
            refreshButton.addEventListener('click', loadQuarterlyFinancials);
            log("B æ–¹æ¡ˆ (æ‰‹å‹•åˆ·æ–°æŒ‰éˆ•) ç›£è½å™¨å·²å•Ÿç”¨ã€‚");
        }
    }


    loadStockData();
    document.addEventListener('DOMContentLoaded', () => {
        initYearSelectFinancial(); 
        setupFinancialChangeListeners();
        setupPeriodChangeListeners();
        setupManualInputListeners();
        
        loadQuarterlyFinancials(); // åˆå§‹è¼‰å…¥æ™‚ï¼Œå˜—è©¦ä½¿ç”¨é»˜èªå€¼è¼‰å…¥è²¡å ±æ•¸æ“š
    });
});
</script>
</body>
</html>
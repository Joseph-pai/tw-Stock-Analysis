<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ç£è‚¡å¸‚çµ‚æ¥µå°ˆæ¥­åˆ†æå™¨ - Joseph PAI 2025 (Final v21)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; font-family: 'Microsoft JhengHei',sans-serif; }
        .container { max-width: 1350px; }
        .card { background: rgba(255,255,255,0.12); backdrop-filter: blur(12px); border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .score-big { font-size: 6.5rem; font-weight: 900; text-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        .badge-pos { background: #28a745; }
        .badge-neg { background: #dc3545; }
        .weight-input { width: 80px; text-align: center; font-weight: bold; background:#fff; color:#333; }
        .summary { background: rgba(0,0,0,0.4); padding: 30px; border-radius: 15px; margin: 30px 0; }
        footer { margin-top: 80px; padding: 30px; text-align: center; color: rgba(255,255,255,0.8); }
        .debug-log { max-height: 500px; overflow-y: auto; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; padding: 15px; border-radius: 8px; }
        .token-status { font-weight: bold; }
        .data-source { font-size: 0.8rem; color: #ffc107; margin-top: 10px; }
        .date-range-input { width: 120px; }
        .manual-input { width: 100%; text-align: center; font-size: 1rem; }
        .explanation { background: white; color: black; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .explanation h6 { color: #8B0000; margin-bottom: 5px; font-weight: bold; }
        .manual-input-cell { padding: 5px !important; width: 100px; }
        .manual-label { font-size: 1rem; color: #ffc107; font-weight: bold; }
        .table-header-red { background-color: #8B0000; color: white; }
        .period-select { width: 110px; font-size: 0.9rem; cursor: pointer; }
        .financial-period { background-color: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .basis-box { background: rgba(0,0,0,0.3); border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px; }
        td, th { vertical-align: middle; }
    </style>
</head>
<body>
<div class="container py-5">

    <h1 class="text-center mb-2">å°ç£è‚¡å¸‚çµ‚æ¥µå°ˆæ¥­åˆ†æå™¨</h1>
    <p class="text-center text-white-50 mb-5">Joseph PAI 2025 11/26 å°ˆæ¥­è©•åˆ†è©³è§£ç‰ˆ â€¢ Netlify Functions + TWSE API</p>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text">FinMind Tokenï¼ˆé¸å¡«ï¼‰</span>
                <input type="text" id="tokenInput" class="form-control bg-white text-dark" placeholder="è²¼ä¸Š Token æˆ–ç•™ç©ºä½¿ç”¨å…¬é–‹è³‡æ–™">
                <button class="btn btn-warning fw-bold" id="saveToken">å„²å­˜</button>
            </div>
            <small class="text-white-50">å…è²»è¨»å†Š â†’ <a href="https://finmindtrade.com/analysis/#/account/register" target="_blank" class="text-warning">FinMindï¼ˆ30ç§’ï¼‰</a> ï½œ æˆ–ç›´æ¥ä½¿ç”¨è­‰äº¤æ‰€+è§€æ¸¬ç«™å…¬é–‹è³‡æ–™</small>
            <div id="tokenStatus" class="token-status mt-2"></div>
        </div>
    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <form id="analyzeForm">
                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-white-50">é¸æ“‡é¡è‚¡</label>
                        <select id="stockCategory" class="form-select">
                            <option value="all">å…¨éƒ¨é¡è‚¡</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white-50">é¸æ“‡è‚¡ç¥¨</label>
                        <select id="stockSelect" class="form-select" required>
                            <option value="">è«‹å…ˆé¸æ“‡é¡è‚¡</option>
                        </select>
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-auto">
                        <label class="text-white-50 small">åˆ†ææ™‚é–“ç¯„åœï¼š</label>
                    </div>
                    <div class="col-auto">
                        <select id="dateRange" class="form-select form-select-sm date-range-input">
                            <option value="30">æœ€è¿‘30å¤©</option>
                            <option value="60" selected>æœ€è¿‘60å¤©</option>
                            <option value="90">æœ€è¿‘90å¤©</option>
                            <option value="180">æœ€è¿‘åŠå¹´</option>
                            <option value="365">æœ€è¿‘ä¸€å¹´</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small">æˆ–è‡ªè¨‚ï¼š</span>
                    </div>
                    <div class="col-auto">
                        <input type="date" id="startDate" class="form-control form-control-sm date-range-input" placeholder="é–‹å§‹æ—¥æœŸ">
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small">åˆ°</span>
                    </div>
                    <div class="col-auto">
                        <input type="date" id="endDate" class="form-control form-control-sm date-range-input" placeholder="çµæŸæ—¥æœŸ">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-warning text-dark fw-bold" type="submit">ç«‹å³å°ˆæ¥­åˆ†æ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="text-center mb-4">
        <button class="btn btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#debugLog">
            é¡¯ç¤º/éš±è— é™¤éŒ¯æ—¥èªŒ
        </button>
    </div>

    <div class="collapse" id="debugLog">
        <div class="card mb-4">
            <div class="card-body p-3">
                <pre id="logContent" class="debug-log"></pre>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('logContent').textContent = '';">æ¸…é™¤æ—¥èªŒ</button>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center my-5" style="display:none;">
        <div class="spinner-border text-warning" style="width:6rem;height:6rem;"></div>
        <h3 class="mt-4">æ­£åœ¨æŠ“å–æœ€æ–°è³‡æ–™ (å¤šç¶­åº¦åˆ†æä¸­)â€¦</h3>
    </div>

    <div id="result" style="display:none;"></div>

</div>

<footer>Â© 2025 Joseph PAI. All Rights Reserved. | è³‡æ–™ä¾†æºï¼šå°ç£è­‰åˆ¸äº¤æ˜“æ‰€ + FinMind + Yahoo Finance</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ================= åˆå§‹åŒ–èˆ‡å…¨åŸŸè®Šæ•¸ =================
    let TOKEN = '';
    try { TOKEN = localStorage.getItem('joseph_pai_token_2025') || ''; } catch(e) {}

    // è²¡å‹™æ•¸æ“šç·©å­˜ - çµæ§‹åŒ–æ ¼å¼ (ttm æ¬„ä½ç”¨æ–¼å„²å­˜å¾Œç«¯è¨ˆç®—çš„ TTM EPS)
    let financialCache = {
        eps: { quarters: {}, year: null, ttm: null },
        roe: { quarters: {}, year: null },
        revenueGrowth: { months: {}, quarters: {}, year: null },
        profitMargin: { quarters: {}, year: null }
    };

    const twseIndustryMap = {
        "01": "æ°´æ³¥å·¥æ¥­", "02": "é£Ÿå“å·¥æ¥­", "03": "å¡‘è† å·¥æ¥­", "04": "ç´¡ç¹”çº–ç¶­", "05": "é›»æ©Ÿæ©Ÿæ¢°",
        "06": "é›»å™¨é›»çºœ", "07": "åŒ–å­¸ç”ŸæŠ€é†«ç™‚", "08": "ç»ç’ƒé™¶ç“·", "09": "é€ ç´™å·¥æ¥­", "10": "é‹¼éµå·¥æ¥­",
        "11": "æ©¡è† å·¥æ¥­", "12": "æ±½è»Šå·¥æ¥­", "13": "é›»å­å·¥æ¥­", "14": "å»ºæç‡Ÿé€ ", "15": "èˆªé‹æ¥­",
        "16": "è§€å…‰äº‹æ¥­", "17": "é‡‘èä¿éšª", "18": "è²¿æ˜“ç™¾è²¨", "19": "ç¶œåˆ", "20": "å…¶ä»–",
        "21": "åŒ–å­¸å·¥æ¥­", "22": "ç”ŸæŠ€é†«ç™‚æ¥­", "23": "æ²¹é›»ç‡ƒæ°£æ¥­", "24": "åŠå°é«”æ¥­", "25": "é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­",
        "26": "å…‰é›»æ¥­", "27": "é€šä¿¡ç¶²è·¯æ¥­", "28": "é›»å­é›¶çµ„ä»¶æ¥­", "29": "é›»å­é€šè·¯æ¥­", "30": "è³‡è¨Šæœå‹™æ¥­",
        "31": "å…¶ä»–é›»å­æ¥­", "32": "æ–‡åŒ–å‰µæ„æ¥­", "33": "è¾²æ¥­ç§‘æŠ€æ¥­", "34": "é›»å­å•†å‹™æ¥­",
        "35": "ç¶ èƒ½ç’°ä¿", "36": "æ•¸ä½é›²ç«¯", "37": "é‹å‹•ä¼‘é–’", "38": "å±…å®¶ç”Ÿæ´»", "91": "å­˜è¨—æ†‘è­‰"
    };

    // UI åˆå§‹åŒ–
    document.getElementById('tokenInput').value = TOKEN;
    document.getElementById('tokenStatus').innerHTML = TOKEN ? '<span style="color:#28a745">Token å·²å¾è¨˜éŒ„ä¸­è¼‰å…¥ (ä¸‹æ¬¡å…è¼¸å…¥)</span>' : '<span style="color:#ffc107">æœªè¨­å®š Tokenï¼Œå°‡ä½¿ç”¨å…¬é–‹è³‡æ–™</span>';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('endDate').value = today;
    
    const dateRangeEl = document.getElementById('dateRange');
    dateRangeEl.onchange = function() {
        const days = parseInt(this.value);
        const end = new Date();
        const start = new Date(end.getTime() - days * 24 * 60 * 60 * 1000);
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
    };
    dateRangeEl.dispatchEvent(new Event('change'));

    let stockData = [];
    let industryCategories = new Set();
    window.weights = { basic:35, technical:25, market:20, news:10, risk:10 };

    window.log = function(msg) {
        const logEl = document.getElementById('logContent');
        if (logEl) {
            logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        console.log(msg);
    }
    
    // === ä¿®æ­£: æ¢å¾© FinMind Token å„²å­˜é‚è¼¯ ===
    document.getElementById('saveToken').onclick = function() {
        const newToken = document.getElementById('tokenInput').value.trim();
        if (newToken) {
            try {
                localStorage.setItem('joseph_pai_token_2025', newToken);
                TOKEN = newToken;
                document.getElementById('tokenStatus').innerHTML = '<span style="color:#28a745">Token å„²å­˜æˆåŠŸï¼</span>';
                log('FinMind Token å„²å­˜æˆåŠŸã€‚');
            } catch (e) {
                document.getElementById('tokenStatus').innerHTML = '<span style="color:#dc3545">Token å„²å­˜å¤±æ•—ã€‚</span>';
                log('FinMind Token å„²å­˜å¤±æ•—ã€‚');
            }
        } else {
            try {
                localStorage.removeItem('joseph_pai_token_2025');
                TOKEN = '';
                document.getElementById('tokenStatus').innerHTML = '<span style="color:#ffc107">Token å·²æ¸…é™¤ã€‚å°‡ä½¿ç”¨å…¬é–‹è³‡æ–™ã€‚</span>';
                log('FinMind Token å·²æ¸…é™¤ã€‚');
            } catch (e) { /* ignore */ }
        }
    };
    // ================= æ ¸å¿ƒ API å‡½æ•¸ (ä¿æŒåŸæœ‰é‚è¼¯) =================

    async function fetchFinmind(dataset, dataId = '', startDate = '', retries = 3) {
        if (!TOKEN && dataset !== 'TaiwanStockInfo') return null;
        let url = `/.netlify/functions/fetch-finmind?dataset=${dataset}`;
        if (dataId) url += `&data_id=${dataId}`;
        if (startDate) url += `&start_date=${startDate}`;
        if (TOKEN) url += `&token=${TOKEN}`;
        
        for (let attempt = 1; attempt <= retries; attempt++) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    if (attempt < retries) { await new Promise(r => setTimeout(r, 1000 * attempt)); continue; }
                    return null;
                }
                const data = await response.json();
                if (data.status === 200 && data.data) return data;
            } catch (err) { if (attempt < retries) await new Promise(r => setTimeout(r, 1000 * attempt)); }
        }
        return null;
    }

    async function fetchYahooWithProxy(symbol, logName) {
        log(`${logName} è«‹æ±‚ä¸­ (é€é Netlify Price Function ä»£ç†)...`);
        try {
            const response = await fetch(`/.netlify/functions/fetch-price?id=${symbol}`);
            if (!response.ok) {
                log(`${logName} ä»£ç†å¤±æ•—: ${response.status}`);
                return null;
            }
            const data = await response.json(); 
            if (data && data.chart?.result?.[0]) {
                log(`${logName} æˆåŠŸï¼`);
                return data;
            }
            log(`${logName} å¤±æ•—: æ ¼å¼éŒ¯èª¤`);
            return null;
        } catch (err) {
            log(`${logName} å¤±æ•—: ${err.message}`);
            return null;
        }
    }

    async function fetchTWSEPrice(stockId) {
        try {
            const response = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY?stockNo=${stockId}`);
            if (!response.ok) return null;
            const data = await response.json();
            return (data && Array.isArray(data) && data.length > 0) ? data : null;
        } catch (err) { return null; }
    }

    async function fetchTWSEFinancials(stockId) {
        log(`è­‰äº¤æ‰€è²¡å ± è«‹æ±‚ä¸­... (${stockId})`);
        
        // é‡ç½®è²¡å‹™å¿«å–
        financialCache = {
            eps: { quarters: {}, year: null, ttm: null },
            roe: { quarters: {}, year: null },
            revenueGrowth: { months: {}, quarters: {}, year: null },
            profitMargin: { quarters: {}, year: null }
        };
        
        try {
            // èª¿ç”¨æ–°çš„çµæ§‹åŒ– API
            const response = await fetch(`/.netlify/functions/fetch-twse?type=financials&stock_id=${stockId}`);
            
            if (!response.ok) {
                log(`è­‰äº¤æ‰€ä»£ç†è«‹æ±‚å¤±æ•—: ${response.status}`);
                return null;
            }
            
            const structuredData = await response.json();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
            if (structuredData.error) {
                log(`è­‰äº¤æ‰€æ•¸æ“šéŒ¯èª¤: ${structuredData.error}`);
                return null;
            }
            
            // ç›´æ¥å°‡çµæ§‹åŒ–æ•¸æ“šè³¦å€¼çµ¦ financialCache
            financialCache = structuredData;
            
            log(`âœ… TWSE çµæ§‹åŒ–æ•¸æ“šè¼‰å…¥æˆåŠŸ`);
            log(`ğŸ“Š æ•¸æ“šçµ±è¨ˆ:`);
            log(`  - EPS å­£åº¦: ${Object.keys(structuredData.eps?.quarters || {}).join(', ') || 'ç„¡'}`);
            log(`  - EPS TTM: ${structuredData.eps?.ttm || 'N/A'}`);
            log(`  - ROE å­£åº¦: ${Object.keys(structuredData.roe?.quarters || {}).join(', ') || 'ç„¡'}`);
            log(`  - æœˆç‡Ÿæ”¶ MoM: ${structuredData.revenueGrowth?.months?.latestMoM || 'N/A'}%`);
            log(`  - å­£ç‡Ÿæ”¶ QoQ: ${structuredData.revenueGrowth?.quarters?.latestQoQ || 'N/A'}%`);
            log(`  - æ¯›åˆ©ç‡å­£åº¦: ${Object.keys(structuredData.profitMargin?.quarters || {}).join(', ') || 'ç„¡'}`);
            log(`  - æ¯›åˆ©ç‡å¹´åº¦: ${structuredData.profitMargin?.year || 'N/A'}%`);
            return { source: 'TWSE (Structured Multi-period)', ...structuredData };
        } catch (err) { 
            log(`è­‰äº¤æ‰€æ•¸æ“šè™•ç†å¤±æ•—: ${err.message}`);
            console.error('è©³ç´°éŒ¯èª¤:', err);
            return null;
        }
    }

    async function fetchYahooFinanceFinancials(stockId) {
        try {
            const response = await fetch(`/.netlify/functions/fetch-financials?id=${stockId}`);
            if (!response.ok) return null;
            const result = await response.json();
            if (result && !result.error) {
                // Yahoo data fallback
                
                // Fallback for EPS TTM (Yahoo Trailing EPS)
                if (financialCache.eps.ttm === null) {
                    financialCache.eps.ttm = result.defaultKeyStatistics?.trailingEps?.raw || 'N/A';
                }

                // Fallback for ROE annual
                if (financialCache.roe.year === null) {
                    financialCache.roe.year = result.financialData?.returnOnEquity?.raw ? result.financialData.returnOnEquity.raw * 100 : 'N/A';
                }
                
                // Fallback for Revenue Growth annual (YoY)
                if (financialCache.revenueGrowth.year === null) {
                    const rev = result.financialData?.revenueGrowth?.raw;
                    financialCache.revenueGrowth.year = rev !== undefined ? parseFloat((rev * 100).toFixed(2)) : 'N/A';
                }
                
                // Gross Margin fallback (Yahoo has Trailing Gross Margin)
                if (financialCache.profitMargin.year === null) {
                    const margin = result.financialData?.grossMargins?.raw;
                    financialCache.profitMargin.year = margin !== undefined ? parseFloat((margin * 100).toFixed(2)) : 'N/A';
                }

                log(`âœ… Yahoo Finance è²¡å ±æ•¸æ“šè¼‰å…¥æˆåŠŸ (ä½œç‚ºå‚™æ´)`);
                return { source: 'Yahoo Finance (Fallback)' };
            }
            return null;
        } catch (err) {
            log(`Yahoo Finance è²¡å ±è«‹æ±‚å¤±æ•—: ${err.message}`);
            return null;
        }
    }

    // ================= UI ç›¸é—œå‡½æ•¸ (åƒ…ä¿®æ”¹è¡¨æ ¼å’Œ getVal é‚è¼¯) =================

    function renderResult(stockId, name, price, change, percent, time, marketData, analystData, stockCategory, financialData) {
        // ... (ä¿æŒä¸è®Š)

        // æœ€è¿‘è²¡å ±æ•¸æ“šè¡¨æ ¼ (å·²ä¿®æ”¹)
        let financialTableHtml = `
            <div class="card mb-4">
                <div class="card-header table-header-red"><h5 class="mb-0">æœ€è¿‘è²¡å ±æ•¸æ“š</h5></div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead><tr><th>é …ç›®</th><th>æœŸé–“</th><th>æ•¸å€¼</th><th class="manual-label">è¼¸å…¥</th></tr></thead>
                        <tbody>
                            <tr>
                                <td>æ¯è‚¡ç›ˆé¤˜ (EPS)</td>
                                <td class="manual-input-cell">
                                    <select id="selectEpsPeriod" data-type="eps" class="form-select form-select-sm period-select">
                                        <option value="quarter">å­£</option>
                                        <option value="ttm">å¹´ (TTM)</option>
                                    </select>
                                </td>
                                <td id="displayEps">N/A</td>
                                <td class="manual-input-cell"><input type="number" step="0.01" id="manualEps" class="manual-input" placeholder="æ‰‹å‹•è¼¸å…¥"></td>
                            </tr>
                            <tr>
                                <td>è‚¡æ±æ¬Šç›Šå ±é…¬ç‡ (ROE)</td>
                                <td class="manual-input-cell">
                                    <select id="selectRoePeriod" data-type="roe" class="form-select form-select-sm period-select">
                                        <option value="quarter">å­£</option>
                                        <option value="annual_avg">å¹´ (å¹³å‡)</option>
                                    </select>
                                </td>
                                <td id="displayRoe">N/A</td>
                                <td class="manual-input-cell"><input type="number" step="0.01" id="manualRoe" class="manual-input" placeholder="æ‰‹å‹•è¼¸å…¥"></td>
                            </tr>
                            <tr>
                                <td>ç‡Ÿæ”¶å¢ç‡ (%)</td>
                                <td class="manual-input-cell">
                                    <select id="selectRevenuePeriod" data-type="revenueGrowth" class="form-select form-select-sm period-select">
                                        <option value="month">æœˆ (MoM)</option>
                                        <option value="quarter">å­£ (QoQ)</option>
                                    </select>
                                </td>
                                <td id="displayRevenue">N/A</td>
                                <td class="manual-input-cell"><input type="number" step="0.01" id="manualRevenue" class="manual-input" placeholder="æ‰‹å‹•è¼¸å…¥"></td>
                            </tr>
                            <tr>
                                <td>æ¯›åˆ©ç‡ (%)</td>
                                <td class="manual-input-cell">
                                    <select id="selectMarginPeriod" data-type="profitMargin" class="form-select form-select-sm period-select">
                                        <option value="quarter">å­£</option>
                                        <option value="year">å¹´</option>
                                    </select>
                                </td>
                                <td id="displayMargin">N/A</td>
                                <td class="manual-input-cell"><input type="number" step="0.01" id="manualMargin" class="manual-input" placeholder="æ‰‹å‹•è¼¸å…¥"></td>
                            </tr>
                            <tr>
                                <td>ç‡Ÿæ¥­åˆ©ç›Šç‡ (%)</td>
                                <td class="manual-input-cell"><select id="selectOpmPeriod" data-type="opm" class="form-select form-select-sm period-select"><option value="quarter">å­£</option><option value="year">å¹´</option></select></td>
                                <td id="displayOpm">N/A</td>
                                <td class="manual-input-cell"><input type="number" step="0.01" id="manualOpm" class="manual-input" placeholder="æ‰‹å‹•è¼¸å…¥"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        // ... (åŸä»£ç¢¼ä¸­ HTML çµæ§‹çš„å…¶é¤˜éƒ¨åˆ†)
        // ...
        
        // è¼¸å‡ºçµæœ HTML
        document.getElementById('result').innerHTML = `...`;
        
        setupPeriodChangeListeners();
        setupManualInputListeners();
        updateFinancialUI();
        
        // ... (Chart ç¹ªåœ–é‚è¼¯)
        // ...
    }

    // æ ¸å¿ƒå‡½æ•¸: æ ¹æ“šæœŸé–“é¸æ“‡å™¨æ›´æ–°è²¡å‹™æ•¸æ“šé¡¯ç¤º (å·²ä¿®æ”¹é‚è¼¯)
    function updateFinancialUI() {
        const getVal = (periodId, dataKey) => {
            const periodSelect = document.getElementById(`select${periodId.charAt(0).toUpperCase() + periodId.slice(1)}Period`);
            if (!periodSelect) return 'N/A';
            const period = periodSelect.value;
            const data = financialCache[dataKey];
            
            // æ‰¾å‡ºæœ€æ–°çš„å­£åº¦æ•¸æ“šï¼ˆä½¿ç”¨ YYYYQQ ä½œç‚ºéµï¼Œä¸¦ç”±å¤§åˆ°å°æ’åºå¾Œå–æœ€å¾Œä¸€å€‹ï¼‰
            const getLatestQuarterlyValue = (quarterData) => {
                const latestQuarter = Object.keys(quarterData).sort().pop();
                return latestQuarter ? quarterData[latestQuarter] : 'N/A';
            };

            // Period-specific logic
            if (dataKey === 'eps') {
                if (period === 'quarter') {
                    // å­£: é¡¯ç¤ºæœ€æ–°å­£åº¦ EPS (e.g., 2025Q3: 17.44)
                    return getLatestQuarterlyValue(data.quarters);
                }
                if (period === 'ttm') {
                    // å¹´ (TTM): é¡¯ç¤ºå¾Œç«¯è¨ˆç®—çš„ TTM EPS (æœ€è¿‘å››å­£ç¸½å’Œ)
                    return data.ttm || 'N/A';
                }
            } else if (dataKey === 'roe') {
                if (period === 'quarter') {
                    // å­£: é¡¯ç¤ºæœ€æ–°å­£åº¦ ROE (e.g., 2025Q3: 9.36)
                    return getLatestQuarterlyValue(data.quarters);
                }
                if (period === 'annual_avg') {
                    // å¹´ (å¹³å‡): è¨ˆç®—æ‰€æœ‰å­£åº¦ ROE çš„å¹³å‡ (Q1+Q2+Q3)/3
                    const quarters = Object.values(data.quarters).filter(val => typeof val === 'number');
                    if (quarters.length > 0) {
                        const sum = quarters.reduce((a, b) => a + b, 0);
                        return parseFloat((sum / quarters.length).toFixed(2)); // å¹³å‡æ•¸
                    }
                    return 'N/A';
                }
            } else if (dataKey === 'revenueGrowth') {
                if (period === 'month') {
                    // æœˆ (MoM): é¡¯ç¤ºæœ€æ–°æœˆç‡Ÿæ”¶å¢ç‡ (èˆ‡ä¸Šæœˆæ¯”è¼ƒ)
                    return data.months.latestMoM || 'N/A';
                }
                if (period === 'quarter') {
                    // å­£ (QoQ): é¡¯ç¤ºæœ€æ–°å­£ç‡Ÿæ”¶å¢ç‡ (Q3 èˆ‡ Q2 çš„æ¯”å€¼)
                    return data.quarters.latestQoQ || 'N/A';
                }
            } else if (dataKey === 'profitMargin') {
                if (period === 'quarter') {
                    // å­£: é¡¯ç¤ºæœ€æ–°å­£åº¦æ¯›åˆ©ç‡ (e.g., 2025Q3: 59.45%)
                    return getLatestQuarterlyValue(data.quarters);
                }
                if (period === 'year') {
                    // å¹´: é¡¯ç¤ºæœ€æ–°å¹´åº¦æ¯›åˆ©ç‡ (e.g., 2024: 56.12%)
                    return data.year || 'N/A';
                }
            } else if (dataKey === 'opm') {
                // OPM å‡è¨­ä¿æŒèˆ‡æ¯›åˆ©ç‡ç›¸åŒçš„æœŸåˆ¥é¸å–®é‚è¼¯ï¼Œä½†æ•¸å€¼å–æ±ºæ–¼æ•¸æ“šæº
                // é€™è£¡æ²¿ç”¨èˆŠç‰ˆ OPM é‚è¼¯ï¼ˆéœ€è¦ OPM æ•¸æ“šæºæä¾›ï¼‰
                // ç”±æ–¼ TWSE API çµæ§‹ä¸­æ²’æœ‰ OPMï¼Œæ­¤è™•æš«æ™‚è¿”å› N/A æˆ–ä¾è³´ fallback
                return 'N/A'; // æˆ–å¾å…¶ä»–æ•¸æ“šæºç²å–
            }
            
            // Fallback: This is not necessary if all cases are covered, but kept for robustness
            return data[period] || 'N/A';
        };

        const setUI = (id, val, unit = '') => {
            const el = document.getElementById(id);
            const inputEl = document.getElementById(`manual${id.replace('display','')}`);
            let displayVal = val;
            let currentROE = 0; // for risk calculation

            if (typeof val === 'number') {
                displayVal = val.toFixed(2) + unit;
                if (id === 'displayRoe') currentROE = val;
            } else {
                displayVal = 'N/A';
            }
            
            if (el) { el.textContent = displayVal; }
            if (inputEl && inputEl.value === '') { inputEl.placeholder = displayVal !== 'N/A' ? displayVal : 'æ‰‹å‹•è¼¸å…¥'; }
        };

        const eps = getVal('eps', 'eps');
        setUI('displayEps', eps, ' å…ƒ');
        
        const roe = getVal('roe', 'roe');
        setUI('displayRoe', roe, '%');
        
        const rev = getVal('revenue', 'revenueGrowth');
        setUI('displayRevenue', rev, '%');
        
        const margin = getVal('margin', 'profitMargin');
        setUI('displayMargin', margin, '%');

        // OPM æ•¸å€¼è™•ç†ï¼ˆç›®å‰ç„¡å®˜æ–¹ OPM ä¾†æºï¼Œæš«æ™‚ç¶­æŒ N/Aï¼‰
        const opm = getVal('opm', 'opm');
        setUI('displayOpm', opm, '%');


        calculateBasicScoreFromManualInput();
    }
    
    // ... (å…¶é¤˜æ‰€æœ‰æœªä¿®æ”¹çš„å‡½æ•¸) ...

    function setupPeriodChangeListeners() {
        document.querySelectorAll('.period-select').forEach(select => {
            select.addEventListener('change', () => {
                log(`æœŸé–“åˆ‡æ›: ${select.dataset.type} â†’ ${select.value}`);
                updateFinancialUI();
            });
        });
    }

    function setupManualInputListeners() {
        document.querySelectorAll('.manual-input').forEach(input => {
            input.addEventListener('input', () => {
                log(`æ‰‹å‹•è¼¸å…¥: ${input.id} = ${input.value}`);
                calculateBasicScoreFromManualInput();
            });
        });
    }
    
    // ... (å…¶é¤˜å‡½æ•¸ï¼ŒåŒ…æ‹¬ loadStockData, calculateBasicScore, analyzeForm submit è™•ç†ç­‰ï¼Œä¿æŒåŸæ¨£)
    
    // ... (é€™è£¡è£œä¸Šæ‰€æœ‰åŸå§‹ä»£ç¢¼ä¸­ omitted çš„éƒ¨åˆ†ä»¥ç¢ºä¿å®Œæ•´æ€§)

    function calculateBasicScoreFromManualInput() {
        // This function will calculate the basic score based on the current financial values,
        // prioritizing manual input over fetched data if available.
        
        const getNumericValue = (id, fallbackValue) => {
            const manualInput = document.getElementById(`manual${id}`);
            const displayId = `display${id}`;
            
            if (manualInput && manualInput.value !== '') {
                const val = parseFloat(manualInput.value);
                return isNaN(val) ? fallbackValue : val;
            }
            
            const displayEl = document.getElementById(displayId);
            if (displayEl && displayEl.textContent !== 'N/A') {
                const text = displayEl.textContent.replace(' å…ƒ', '').replace('%', '');
                const val = parseFloat(text);
                return isNaN(val) ? fallbackValue : val;
            }
            
            return fallbackValue;
        };

        // ç²å–ç•¶å‰æ‰€æœ‰æŒ‡æ¨™æ•¸å€¼
        const eps = getNumericValue('Eps', 0);
        const roe = getNumericValue('Roe', 0);
        const revenue = getNumericValue('Revenue', 0);
        const margin = getNumericValue('Margin', 0);
        const opm = getNumericValue('Opm', 0);
        
        let score = 0;
        let details = [];

        // 1. EPS ç©©å®šå¢é•· (å‡è¨­ TTM EPS > 0)
        if (eps > 0) {
            score += 10;
            details.push(`EPS ($${eps.toFixed(2)}) > 0ï¼š+10 åˆ†`);
        } else {
            details.push(`EPS ($${eps.toFixed(2)}) <= 0ï¼š0 åˆ†`);
        }

        // 2. ROE è¡¨ç¾ (è¶Šé«˜è¶Šå¥½ï¼Œä»¥ 15% ç‚ºå„ªç§€æ¨™æº–)
        let roeScore = 0;
        if (roe >= 15) {
            roeScore = 15;
        } else if (roe > 5) {
            roeScore = 5 + (roe - 5) * (10 / 10); // 5%åˆ°15%ä¹‹é–“ç·šæ€§åŠ åˆ†
        }
        score += roeScore;
        details.push(`ROE (${roe.toFixed(2)}%) è²¢ç»ï¼š+${roeScore.toFixed(2)} åˆ† (å„ªç§€é–€æª» 15%)`);

        // 3. ç‡Ÿæ”¶æˆé•·ç‡ (å‡è¨­ MoM æˆ– QoQ > 0)
        let revScore = 0;
        if (revenue > 5) { // å‡è¨­ 5% ä»¥ä¸Šç‚ºå¼·å‹å¢é•·
            revScore = 10;
        } else if (revenue > 0) {
            revScore = 5;
        }
        score += revScore;
        details.push(`ç‡Ÿæ”¶å¢ç‡ (${revenue.toFixed(2)}%) è²¢ç»ï¼š+${revScore} åˆ† (å¼·å‹é–€æª» 5%)`);


        // 4. æ¯›åˆ©ç‡èˆ‡ç‡Ÿç›Šç‡ (å‡è¨­æ¯›åˆ©ç‡ > 20% ä¸” OPM > 10% è¼ƒå¥½)
        let marginScore = 0;
        if (margin > 20) {
            marginScore += 5;
        }
        if (opm > 10) {
            marginScore += 5;
        }
        score += marginScore;
        details.push(`æ¯›åˆ©ç‡/ç‡Ÿç›Šç‡ (${margin.toFixed(2)}% / ${opm.toFixed(2)}%) è²¢ç»ï¼š+${marginScore} åˆ†`);

        // åŸºç¤è©•åˆ† (ç¸½æ¬Šé‡ 35)
        const finalBasicScore = parseFloat((score * (35 / 40)).toFixed(2));
        
        // æ›´æ–° UI
        document.getElementById('basicScore').textContent = finalBasicScore;
        document.getElementById('basicExplanation').innerHTML = `<h6>åŸºç¤é¢è©•åˆ† (${finalBasicScore} / 35 åˆ†)</h6><p>è¨ˆç®—åŸºæ–¼æ‚¨ç•¶å‰é¸æ“‡çš„æœŸé–“æ•¸å€¼ï¼š</p><ul><li>${details.join('</li><li>')}</li></ul>`;

        // é‡æ–°è¨ˆç®—ç¸½åˆ†
        calculateTotalScore();
    }


    function calculateTotalScore() {
        const basicScore = parseFloat(document.getElementById('basicScore').textContent) || 0;
        const technicalScore = parseFloat(document.getElementById('technicalScore').textContent) || 0;
        const marketScore = parseFloat(document.getElementById('marketScore').textContent) || 0;
        const newsScore = parseFloat(document.getElementById('newsScore').textContent) || 0;
        const riskScore = parseFloat(document.getElementById('riskScore').textContent) || 0;
        
        const totalScore = (basicScore + technicalScore + marketScore + newsScore + riskScore).toFixed(2);
        
        document.getElementById('totalScore').textContent = totalScore;

        const summaryText = document.getElementById('summaryText');
        if (totalScore >= 90) {
            summaryText.innerHTML = '<h2><span class="badge badge-pos">è¶…å¼·è²·å…¥ (S+)</span></h2><p>æ•¸æ“šæ¥µç‚ºäº®çœ¼ï¼Œå»ºè­°ç´å…¥æŠ•è³‡çµ„åˆé¦–é¸ã€‚</p>';
        } else if (totalScore >= 80) {
            summaryText.innerHTML = '<h2><span class="badge badge-pos">å¼·å‹è²·å…¥ (A)</span></h2><p>è¡¨ç¾å„ªç•°ï¼ŒåŸºæœ¬é¢èˆ‡æŠ€è¡“é¢å‡è¡¨ç¾è‰¯å¥½ã€‚</p>';
        } else if (totalScore >= 60) {
            summaryText.innerHTML = '<h2><span class="badge badge-pos">è§€æœ›è²·å…¥ (B)</span></h2><p>è¡¨ç¾ç©©å¥ï¼Œé©åˆæŒçºŒè§€å¯Ÿæˆ–ä½é»ä»‹å…¥ã€‚</p>';
        } else if (totalScore >= 40) {
            summaryText.innerHTML = '<h2><span class="badge badge-neg">ä¸­ç«‹è§€æœ› (C)</span></h2><p>ç¼ºä¹æ˜ç¢ºå‹•èƒ½ï¼Œå»ºè­°ä¸­ç«‹è§€æœ›ã€‚</p>';
        } else {
            summaryText.innerHTML = '<h2><span class="badge badge-neg">è­¦æˆ’è³£å‡º (D)</span></h2><p>æ•¸æ“šè¼ƒå·®ï¼Œé¢¨éšªè¼ƒé«˜ï¼Œå»ºè­°é¿é–‹ã€‚</p>';
        }
    }


    async function loadStockData() {
        log('è¼‰å…¥è‚¡ç¥¨æ¸…å–®ä¸­...');
        const stockInfo = await fetchFinmind('TaiwanStockInfo');
        
        if (stockInfo && stockInfo.data) {
            stockData = stockInfo.data;
            log(`æˆåŠŸè¼‰å…¥ ${stockData.length} ç­†è‚¡ç¥¨è³‡è¨Šã€‚`);

            stockData.forEach(item => {
                if (item.industry_code) {
                    industryCategories.add(item.industry_code);
                }
            });

            const categorySelect = document.getElementById('stockCategory');
            // æ¸…ç©ºé™¤ "å…¨éƒ¨é¡è‚¡" å¤–çš„é¸é …
            Array.from(categorySelect.options).slice(1).forEach(option => option.remove());

            [...industryCategories].sort().forEach(code => {
                const name = twseIndustryMap[code] || `å…¶ä»– (${code})`;
                const option = document.createElement('option');
                option.value = code;
                option.textContent = name;
                categorySelect.appendChild(option);
            });
            
            categorySelect.onchange = updateStockSelect;
            updateStockSelect();
        } else {
            log('è¼‰å…¥è‚¡ç¥¨è³‡è¨Šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ FinMind Tokenã€‚');
        }
    }

    function updateStockSelect() {
        const categorySelect = document.getElementById('stockCategory');
        const stockSelect = document.getElementById('stockSelect');
        const selectedCode = categorySelect.value;

        // æ¸…ç©ºè‚¡ç¥¨é¸å–®
        stockSelect.innerHTML = '<option value="">è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼/åç¨±</option>';

        const filteredStocks = stockData
            .filter(item => selectedCode === 'all' || item.industry_code === selectedCode)
            .sort((a, b) => a.stock_id.localeCompare(b.stock_id));

        filteredStocks.forEach(item => {
            const option = document.createElement('option');
            option.value = item.stock_id;
            option.textContent = `${item.stock_id} ${item.stock_name}`;
            stockSelect.appendChild(option);
        });
    }

    // ================= è¡¨å–®è™•ç† =================

    document.getElementById('analyzeForm').onsubmit = async function(e) {
        e.preventDefault();
        
        const stockId = document.getElementById('stockSelect').value;
        const stockName = document.getElementById('stockSelect').options[document.getElementById('stockSelect').selectedIndex].text.split(' ')[1];
        const dateRangeValue = document.getElementById('dateRange').value;
        let startDate = document.getElementById('startDate').value;
        let endDate = document.getElementById('endDate').value;
        
        if (!stockId) {
            alert('è«‹é¸æ“‡ä¸€æª”è‚¡ç¥¨ï¼');
            return;
        }

        document.getElementById('loading').style.display = 'block';
        document.getElementById('result').style.display = 'none';
        document.getElementById('logContent').textContent = '';
        log(`--- é–‹å§‹åˆ†æ ${stockId} ${stockName} ---`);

        // ç¢ºä¿æ—¥æœŸæ ¼å¼æ­£ç¢º
        if (startDate > endDate) {
            log('è­¦å‘Š: é–‹å§‹æ—¥æœŸæ™šæ–¼çµæŸæ—¥æœŸï¼Œè‡ªå‹•äº¤æ›æ—¥æœŸã€‚');
            [startDate, endDate] = [endDate, startDate];
        }

        // 1. ç²å–è‚¡åƒ¹æ•¸æ“š (Yahoo Chart API via Netlify function)
        const symbol = `${stockId}.TW`;
        const yahooPriceData = await fetchYahooWithProxy(symbol, 'è‚¡åƒ¹');

        // 2. ç²å–å¤§ç›¤æ•¸æ“š
        const marketIndexData = await fetchYahooWithProxy('^TWII', 'å¤§ç›¤');

        // 3. ç²å–è²¡å‹™æ•¸æ“š (TWSE çµæ§‹åŒ– API)
        const twseFinancialData = await fetchTWSEFinancials(stockId);

        // 4. è²¡å‹™æ•¸æ“šå‚™æ´ (Yahoo Finance Financials API via Netlify function)
        if (!twseFinancialData || Object.keys(financialCache.eps.quarters).length === 0) {
            log('TWSE è²¡å‹™æ•¸æ“šä¸è¶³ï¼Œå˜—è©¦ä½¿ç”¨ Yahoo Finance å‚™æ´...');
            await fetchYahooFinanceFinancials(stockId);
        }

        // 5. ç²å–åˆ†æå¸«è©•ç´š (FinMind - å‡è¨­åªéœ€æœ€è¿‘ä¸€ç­†)
        const analystData = await fetchFinmind('TaiwanStockHoldingDetail', stockId, '2023-01-01');

        // 6. ç²å–åŸºæœ¬åˆ†ææ•¸æ“š (FinMind, ç•™çµ¦é€²éšåˆ†æ)

        const stockInfo = stockData.find(s => s.stock_id === stockId);
        const stockCategory = stockInfo ? twseIndustryMap[stockInfo.industry_code] || 'å…¶ä»–' : 'æœªçŸ¥';

        // æª¢æŸ¥è‚¡åƒ¹æ•¸æ“š
        if (yahooPriceData && yahooPriceData.chart?.result?.[0]) {
            const chartData = yahooPriceData.chart.result[0];
            const timestamps = chartData.timestamp;
            const closes = chartData.indicators.quote[0].close;
            const latestPrice = closes.at(-1);
            const prevClose = chartData.meta.previousClose;
            const change = latestPrice - prevClose;
            const percent = (change / prevClose * 100).toFixed(2);
            const time = new Date(chartData.meta.regularMarketTime * 1000).toLocaleString('zh-TW');

            renderResult(
                stockId, 
                stockName, 
                latestPrice, 
                change, 
                percent, 
                time, 
                marketIndexData, 
                analystData, 
                stockCategory, 
                twseFinancialData // å‚³é TWSE æ•¸æ“šï¼ŒUI ä½¿ç”¨ global financialCache
            );
        } else {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('result').innerHTML = `<div class="alert alert-danger text-center py-5"><h3>ç„¡æ³•ç²å–è‚¡åƒ¹æ•¸æ“š (${stockId})ã€‚</h3><p>è«‹ç¢ºèªè‚¡ç¥¨ä»£ç¢¼æ˜¯å¦æ­£ç¢ºã€‚</p></div>`;
            document.getElementById('result').style.display = 'block';
            log(`éŒ¯èª¤: ç„¡æ³•ç²å–è‚¡åƒ¹æ•¸æ“š (${stockId})`);
        }
    };

    loadStockData();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ç£è‚¡å¸‚çµ‚æ¥µå°ˆæ¥­åˆ†æå™¨ - Joseph PAI 2025 (Final v21)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; font-family: 'Microsoft JhengHei',sans-serif; }
        .container { max-width: 1350px; }
        .card { background: rgba(255,255,255,0.12); backdrop-filter: blur(12px); border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .score-big { font-size: 6.5rem; font-weight: 900; text-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        .badge-pos { background: #28a745; }
        .badge-neg { background: #dc3545; }
        .weight-input { width: 80px; text-align: center; font-weight: bold; background:#fff; color:#333; }
        .summary { background: rgba(0,0,0,0.4); padding: 30px; border-radius: 15px; margin: 30px 0; }
        footer { margin-top: 80px; padding: 30px; text-align: center; color: rgba(255,255,255,0.8); }
        .debug-log { max-height: 500px; overflow-y: auto; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; padding: 15px; border-radius: 8px; }
        .token-status { font-weight: bold; }
        .data-source { font-size: 0.8rem; color: #ffc107; margin-top: 10px; }
        .date-range-input { width: 120px; }
        .manual-input { width: 100%; text-align: center; font-size: 1rem; }
        .explanation { background: white; color: black; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .explanation h6 { color: #8B0000; margin-bottom: 5px; font-weight: bold; }
        .manual-input-cell { padding: 5px !important; width: 100px; }
        .manual-label { font-size: 1rem; color: #ffc107; font-weight: bold; }
        .table-header-red { background-color: #8B0000; color: white; }
        .period-select { width: 110px; font-size: 0.9rem; cursor: pointer; }
        .financial-period { background-color: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .basis-box { background: rgba(0,0,0,0.3); border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px; }
        td, th { vertical-align: middle; }
        .stock-search { max-width: 300px; }
    </style>
</head>
<body>
<div class="container py-5">

    <h1 class="text-center mb-2">å°ç£è‚¡å¸‚çµ‚æ¥µå°ˆæ¥­åˆ†æå™¨</h1>
    <p class="text-center text-white-50 mb-5">Joseph PAI 2025 11/26 å°ˆæ¥­è©•åˆ†è©³è§£ç‰ˆ â€¢ Netlify Functions + TWSE API</p>

 <div class="row justify-content-center mb-4">
    <div class="col-md-8">
        <!-- ä¿®æ”¹å¾Œçš„ Token è¼¸å…¥å€åŸŸ -->
        <div class="mb-3">
            <label class="form-label text-white-50 mb-2">FinMind Tokenï¼ˆé¸å¡«ï¼‰</label>
            <div class="input-group">
                <input type="text" id="tokenInput" class="form-control bg-white text-dark" placeholder="è²¼ä¸Š Token æˆ–ç•™ç©ºä½¿ç”¨å…¬é–‹è³‡æ–™">
                <button class="btn btn-warning fw-bold" id="saveToken">å„²å­˜</button>
            </div>
        </div>
        <small class="text-white-50">å…è²»è¨»å†Š â†’ <a href="https://finmindtrade.com/analysis/#/account/register" target="_blank" class="text-warning">FinMindï¼ˆ30ç§’ï¼‰</a> ï½œ æˆ–ç›´æ¥ä½¿ç”¨è­‰äº¤æ‰€+è§€æ¸¬ç«™å…¬é–‹è³‡æ–™</small>
        <div id="tokenStatus" class="token-status mt-2"></div>
    </div>
</div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="row g-2 mb-3">
                <div class="col-md-4">
                    <label class="form-label text-white-50">æ‰‹å‹•è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼</label>
                    <div class="input-group stock-search">
                        <input type="text" id="manualStockCode" class="form-control" placeholder="ä¾‹å¦‚: 2330">
                        <button class="btn btn-info text-white fw-bold" id="searchStock">æœå°‹</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white-50">é¸æ“‡é¡è‚¡</label>
                    <select id="stockCategory" class="form-select">
                        <option value="all">å…¨éƒ¨é¡è‚¡</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white-50">é¸æ“‡è‚¡ç¥¨</label>
                    <select id="stockSelect" class="form-select" required>
                        <option value="">è«‹å…ˆé¸æ“‡é¡è‚¡</option>
                    </select>
                </div>
            </div>
            
            <form id="analyzeForm">
                <div class="row g-2">
                    <div class="col-auto">
                        <label class="text-white-50 small">åˆ†ææ™‚é–“ç¯„åœï¼š</label>
                    </div>
                    <div class="col-auto">
                        <select id="dateRange" class="form-select form-select-sm date-range-input">
                            <option value="30">æœ€è¿‘30å¤©</option>
                            <option value="60" selected>æœ€è¿‘60å¤©</option>
                            <option value="90">æœ€è¿‘90å¤©</option>
                            <option value="180">æœ€è¿‘åŠå¹´</option>
                            <option value="365">æœ€è¿‘ä¸€å¹´</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small">æˆ–è‡ªè¨‚ï¼š</span>
                    </div>
                    <div class="col-auto">
                        <input type="date" id="startDate" class="form-control form-control-sm date-range-input" placeholder="é–‹å§‹æ—¥æœŸ">
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small">åˆ°</span>
                    </div>
                    <div class="col-auto">
                        <input type="date" id="endDate" class="form-control form-control-sm date-range-input" placeholder="çµæŸæ—¥æœŸ">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-warning text-dark fw-bold" type="submit">ç«‹å³å°ˆæ¥­åˆ†æ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

<!-- AI åˆ†æåŠŸèƒ½å€åŸŸ -->
<div class="row justify-content-center mb-4">
    <div class="col-md-12">
        <div class="card text-dark">
            <div class="card-header bg-info text-white">
                <strong>ğŸ” æ¶ˆæ¯é¢èˆ‡é¢¨éšªåˆ†æAIåŠ©æ‰‹</strong>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-center">
                    <div class="col-md-3">
                        <label class="form-label">AIå¹³å°é¸æ“‡</label>
                        <select id="aiPlatform" class="form-select">
                            <option value="deepseek">DeepSeek (æ¨è–¦)</option>
                            <option value="gpt">ChatGPT (OpenAI)</option>
                            <option value="gemini">Gemini (Google)</option>
                            <option value="claude">Claude (Anthropic)</option>
                            <option value="grok">Grok (xAI)</option>
                        </select>
                        <small class="text-muted">
                            <a href="#" id="getApiLink" class="text-primary">ğŸ“Œ ç²å–API Key</a>
                        </small>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">API Key</label>
                        <div class="input-group">
                            <input type="password" id="aiApiKey" class="form-control" placeholder="è¼¸å…¥é¸æ“‡å¹³å°çš„ API Key">
                            <button class="btn btn-outline-primary" type="button" id="verifyAiKey">é©—è­‰</button>
                        </div>
                        <small class="text-muted" id="apiKeyHint">è«‹è¼¸å…¥æœ‰æ•ˆçš„API Key</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">åˆ†æé¡å‹</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="analysisType" id="newsAnalysis" value="news" checked>
                            <label class="btn btn-outline-success" for="newsAnalysis">ğŸ“° æ¶ˆæ¯é¢åˆ†æ</label>
                            
                            <input type="radio" class="btn-check" name="analysisType" id="riskAnalysis" value="risk">
                            <label class="btn btn-outline-warning" for="riskAnalysis">âš ï¸ é¢¨éšªé¢åˆ†æ</label>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary" id="aiAnalyzeBtn" disabled>
                                <span class="spinner-border spinner-border-sm me-2" id="aiSpinner" style="display: none;"></span>
                                ğŸ¤– AI åˆ†æ
                            </button>
                            <button class="btn btn-outline-secondary" id="clearAiAnalysis">
                                ğŸ—‘ï¸ æ¸…é™¤åˆ†æ
                            </button>
                            <button class="btn btn-outline-info" id="testConnectionBtn">
                                ğŸ”— æ¸¬è©¦é€£ç·š
                            </button>
                            <div id="aiKeyStatus" class="ms-2 align-self-center"></div>
                        </div>
                    </div>
                </div>

                <!-- AI åˆ†æçµæœé¡¯ç¤º -->
                <div id="aiAnalysisResult" class="mt-4" style="display: none;">
                    <ul class="nav nav-tabs" id="aiResultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="analysis-content-tab" data-bs-toggle="tab" data-bs-target="#analysis-content" type="button" role="tab">åˆ†æå ±å‘Š</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="score-summary-tab" data-bs-toggle="tab" data-bs-target="#score-summary" type="button" role="tab">è©•åˆ†æ‘˜è¦</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="score-details-tab" data-bs-toggle="tab" data-bs-target="#score-details" type="button" role="tab">è©•åˆ†æ˜ç´°</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="analysis-content" role="tabpanel">
                            <div class="border rounded p-3 bg-light">
                                <pre id="aiAnalysisContent" style="white-space: pre-wrap; font-family: inherit;"></pre>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="score-summary" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h5>AI åˆ†æè©•åˆ†</h5>
                                            <div id="aiScoreDisplay" class="fs-1 fw-bold text-primary">0</div>
                                            <div id="aiComment" class="text-muted mt-2"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>æ‡‰ç”¨è©•åˆ†åˆ°ç³»çµ±</h6>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="autoApplyScore" checked>
                                                <label class="form-check-label" for="autoApplyScore">
                                                    è‡ªå‹•æ‡‰ç”¨è©•åˆ†
                                                </label>
                                            </div>
                                            <button class="btn btn-success w-100" id="applyAiScore">
                                                âœ… æ‡‰ç”¨è©•åˆ†åˆ°å°ˆæ¥­è©•åˆ†è¡¨
                                            </button>
                                            <small class="text-muted">å°‡è‡ªå‹•å¡«å……åˆ°å°æ‡‰çš„è©•åˆ†é …ç›®</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="score-details" role="tabpanel">
                            <!-- æ¶ˆæ¯é¢è©•åˆ†è¡¨æ ¼ -->
                            <div id="newsScoreTable" class="card mb-4" style="display: none;">
                                <div class="card-header bg-success text-white">
                                    <strong>ğŸ“° æ¶ˆæ¯é¢è©•åˆ†æ˜ç´°</strong>
                                </div>
                                <div class="card-body">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>é …ç›®</th>
                                                <th>åˆ†æèˆ‡æ¬Šé‡</th>
                                                <th>åˆ†æ•£è²¢ç»</th>
                                            </tr>
                                        </thead>
                                        <tbody id="newsScoreDetails">
                                            <!-- å‹•æ…‹å¡«å……æ¶ˆæ¯é¢è©•åˆ†é …ç›® -->
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-primary">
                                                <td><strong>ç¸½è¨ˆ</strong></td>
                                                <td><strong>æ¶ˆæ¯é¢æœ€çµ‚å¾—åˆ†</strong></td>
                                                <td><strong id="newsTotalScore">0</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                    <div class="mt-3">
                                        <strong>è©•èª:</strong> 
                                        <span id="newsFinalComment"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- é¢¨éšªé¢è©•åˆ†è¡¨æ ¼ -->
                            <div id="riskScoreTable" class="card" style="display: none;">
                                <div class="card-header bg-warning text-dark">
                                    <strong>âš ï¸ é¢¨éšªé¢è©•åˆ†æ˜ç´°</strong>
                                </div>
                                <div class="card-body">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>é …ç›®</th>
                                                <th>åˆ†æèˆ‡æ¬Šé‡</th>
                                                <th>åˆ†æ•£è²¢ç»</th>
                                            </tr>
                                        </thead>
                                        <tbody id="riskScoreDetails">
                                            <!-- å‹•æ…‹å¡«å……é¢¨éšªé¢è©•åˆ†é …ç›® -->
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-primary">
                                                <td><strong>ç¸½è¨ˆ</strong></td>
                                                <td><strong>é¢¨éšªé¢æœ€çµ‚å¾—åˆ†</strong></td>
                                                <td><strong id="riskTotalScore">0</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                    <div class="mt-3">
                                        <strong>è©•èª:</strong> 
                                        <span id="riskFinalComment"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="text-center mb-4">
        <button class="btn btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#debugLog">
            é¡¯ç¤º/éš±è— é™¤éŒ¯æ—¥èªŒ
        </button>
    </div>

    <div class="collapse" id="debugLog">
        <div class="card mb-4">
            <div class="card-body p-3">
                <pre id="logContent" class="debug-log"></pre>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('logContent').textContent = '';">æ¸…é™¤æ—¥èªŒ</button>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center my-5" style="display:none;">
        <div class="spinner-border text-warning" style="width:6rem;height:6rem;"></div>
        <h3 class="mt-4">æ­£åœ¨æŠ“å–æœ€æ–°è³‡æ–™ (å¤šç¶­åº¦åˆ†æä¸­)â€¦</h3>
    </div>

    <div id="result" style="display:none;"></div>

</div>

<footer>Â© 2025 Joseph PAI. All Rights Reserved. | è³‡æ–™ä¾†æºï¼šå°ç£è­‰åˆ¸äº¤æ˜“æ‰€ + FinMind + Yahoo Finance</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ================= åˆå§‹åŒ–èˆ‡å…¨åŸŸè®Šæ•¸ =================
    let TOKEN = '';
    try { TOKEN = localStorage.getItem('joseph_pai_token_2025') || ''; } catch(e) {}

    // è²¡å‹™æ•¸æ“šç·©å­˜ - çµæ§‹åŒ–æ ¼å¼
    let financialCache = {
        eps: { quarters: {}, year: null },
        roe: { quarters: {}, year: null },
        revenueGrowth: { months: {}, quarters: {}, year: null },
        profitMargin: { quarters: {}, year: null }
    };

    const twseIndustryMap = {
        "01": "æ°´æ³¥å·¥æ¥­", "02": "é£Ÿå“å·¥æ¥­", "03": "å¡‘è† å·¥æ¥­", "04": "ç´¡ç¹”çº–ç¶­", "05": "é›»æ©Ÿæ©Ÿæ¢°",
        "06": "é›»å™¨é›»çºœ", "07": "åŒ–å­¸ç”ŸæŠ€é†«ç™‚", "08": "ç»ç’ƒé™¶ç“·", "09": "é€ ç´™å·¥æ¥­", "10": "é‹¼éµå·¥æ¥­",
        "11": "æ©¡è† å·¥æ¥­", "12": "æ±½è»Šå·¥æ¥­", "13": "é›»å­å·¥æ¥­", "14": "å»ºæç‡Ÿé€ ", "15": "èˆªé‹æ¥­",
        "16": "è§€å…‰äº‹æ¥­", "17": "é‡‘èä¿éšª", "18": "è²¿æ˜“ç™¾è²¨", "19": "ç¶œåˆ", "20": "å…¶ä»–",
        "21": "åŒ–å­¸å·¥æ¥­", "22": "ç”ŸæŠ€é†«ç™‚æ¥­", "23": "æ²¹é›»ç‡ƒæ°£æ¥­", "24": "åŠå°é«”æ¥­", "25": "é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­",
        "26": "å…‰é›»æ¥­", "27": "é€šä¿¡ç¶²è·¯æ¥­", "28": "é›»å­é›¶çµ„ä»¶æ¥­", "29": "é›»å­é€šè·¯æ¥­", "30": "è³‡è¨Šæœå‹™æ¥­",
        "31": "å…¶ä»–é›»å­æ¥­", "32": "æ–‡åŒ–å‰µæ„æ¥­", "33": "è¾²æ¥­ç§‘æŠ€æ¥­", "34": "é›»å­å•†å‹™æ¥­",
        "35": "ç¶ èƒ½ç’°ä¿", "36": "æ•¸ä½é›²ç«¯", "37": "é‹å‹•ä¼‘é–’", "38": "å±…å®¶ç”Ÿæ´»", "91": "å­˜è¨—æ†‘è­‰"
    };

    // ================= åˆ†ææ­·å²ç®¡ç† =================
    let analysisHistory = {
        news: null,
        risk: null
    };

    // ä¿å­˜åˆ†ææ­·å²
    function saveAnalysisHistory(analysisType, result, stockName) {
        analysisHistory[analysisType] = {
            content: result.content,
            score: result.score,
            comment: result.comment,
            timestamp: new Date().toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }),
            stockName: stockName,
            rawContent: result.rawContent || result.content,
            positives: result.positives || [],
            negatives: result.negatives || []
        };
        console.log(`å·²ä¿å­˜ ${analysisType} åˆ†ææ­·å²`);
    }

    // åŠ è¼‰ä¿å­˜çš„åˆ†ææ­·å²
    function loadAnalysisHistory(analysisType) {
        const history = analysisHistory[analysisType];
        if (history && document.getElementById('aiAnalysisResult').style.display !== 'none') {
            document.getElementById('aiAnalysisContent').textContent = history.content;
            document.getElementById('aiScoreDisplay').textContent = 
                history.score > 0 ? `+${history.score}` : history.score;
            document.getElementById('aiComment').textContent = history.comment;
            
            // æ›´æ–°è©•åˆ†é¡¯ç¤º
            const scoreDisplay = document.getElementById('aiScoreDisplay');
            scoreDisplay.className = 'fs-1 fw-bold ' + 
                (history.score > 0 ? 'text-success' : 
                 history.score < 0 ? 'text-danger' : 'text-warning');
            
            // é¡¯ç¤ºè©•åˆ†æ˜ç´°
            displayScoreDetails(analysisType, history.rawContent, history.score, history.stockName);
            
            console.log(`å·²è¼‰å…¥ ${analysisType} åˆ†ææ­·å²`);
            return true;
        }
        return false;
    }

    // UI åˆå§‹åŒ–
    document.getElementById('tokenInput').value = TOKEN;
    document.getElementById('tokenStatus').innerHTML = TOKEN ? '<span style="color:#28a745">Token å·²å¾è¨˜éŒ„ä¸­è¼‰å…¥ (ä¸‹æ¬¡å…è¼¸å…¥)</span>' : '<span style="color:#ffc107">æœªè¨­å®š Tokenï¼Œå°‡ä½¿ç”¨å…¬é–‹è³‡æ–™</span>';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('endDate').value = today;
    
    const dateRangeEl = document.getElementById('dateRange');
    dateRangeEl.onchange = function() {
        const days = parseInt(this.value);
        const end = new Date();
        const start = new Date(end.getTime() - days * 24 * 60 * 60 * 1000);
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
    };
    dateRangeEl.dispatchEvent(new Event('change'));

    let stockData = [];
    let industryCategories = new Set();
    window.weights = { basic:35, technical:25, market:20, news:10, risk:10 };

    window.log = function(msg) {
        const logEl = document.getElementById('logContent');
        if (logEl) {
            logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        console.log(msg);
    }

     // ================= AI åˆ†æåŠŸèƒ½å¢å¼· =================
    
    // API å¹³å°éˆæ¥æ˜ å°„
    const apiPlatformLinks = {
        'deepseek': 'https://platform.deepseek.com/api_keys',
        'gpt': 'https://platform.openai.com/api-keys',
        'gemini': 'https://aistudio.google.com/app/apikey',
        'claude': 'https://console.anthropic.com/settings/keys',
        'grok': 'https://console.x.ai/keys'
    };

    // API Key æ ¼å¼æç¤º
    const apiKeyHints = {
        'deepseek': 'DeepSeek API Key ä»¥ sk- é–‹é ­',
        'gpt': 'OpenAI API Key ä»¥ sk- é–‹é ­', 
        'gemini': 'Google AI Studio API Key',
        'claude': 'Claude API Key ä»¥ sk-ant- é–‹é ­',
        'grok': 'Grok API Key'
    };

    let currentAiApiKey = '';
    let currentAiPlatform = 'deepseek';
    let isAiKeyVerified = false;

    // åŠ è¼‰ä¿å­˜çš„ AI è¨­ç½®
    try {
        const savedAiConfig = localStorage.getItem('joseph_pai_ai_config');
        if (savedAiConfig) {
            const config = JSON.parse(savedAiConfig);
            document.getElementById('aiPlatform').value = config.platform || 'deepseek';
            document.getElementById('aiApiKey').value = config.apiKey || '';
            currentAiPlatform = config.platform || 'deepseek';
            currentAiApiKey = config.apiKey || '';
            isAiKeyVerified = config.verified || false;
            updateAiButtonState();
            
            // æ›´æ–°æç¤º
            const hint = apiKeyHints[currentAiPlatform] || 'è«‹è¼¸å…¥æœ‰æ•ˆçš„API Key';
            document.getElementById('apiKeyHint').textContent = hint;
        }
    } catch (e) {
        console.error('åŠ è¼‰AIé…ç½®å¤±æ•—:', e);
    }

    // ç²å–APIéˆæ¥
    document.getElementById('getApiLink').addEventListener('click', function(e) {
        e.preventDefault();
        const platform = document.getElementById('aiPlatform').value;
        const url = apiPlatformLinks[platform];
        if (url) {
            window.open(url, '_blank');
        }
    });

    // å¹³å°è®ŠåŒ–æ™‚æ›´æ–°æç¤º
    document.getElementById('aiPlatform').addEventListener('change', function() {
        currentAiPlatform = this.value;
        const hint = apiKeyHints[currentAiPlatform] || 'è«‹è¼¸å…¥æœ‰æ•ˆçš„API Key';
        document.getElementById('apiKeyHint').textContent = hint;
        updateAiButtonState();
    });

// æ¸¬è©¦é€£ç·šæŒ‰éˆ• - ä¿®å¾©ç‰ˆæœ¬
// æ¸¬è©¦é€£ç·šæŒ‰éˆ• - ä¿®å¾©ç‰ˆæœ¬
document.getElementById('testConnectionBtn').addEventListener('click', async function() {
    if (!currentAiApiKey) {
        alert('è«‹å…ˆè¼¸å…¥ API Key');
        return;
    }

    const testBtn = this;
    const originalText = testBtn.innerHTML;
    testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>æ¸¬è©¦ä¸­...';
    testBtn.disabled = true;

    try {
        log(`æ¸¬è©¦ ${currentAiPlatform} API é€£ç·š...`);
        
        // ä½¿ç”¨ç°¡å–®æ¸¬è©¦å‡½æ•¸ï¼Œä¸ä¾è³´è‚¡ç¥¨ä»£ç¢¼
        const response = await fetch('/.netlify/functions/structured-analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                stockId: '2330', // ä½¿ç”¨å›ºå®šçš„æ¸¬è©¦è‚¡ç¥¨ä»£ç¢¼
                stockName: 'å°ç©é›»',
                apiKey: currentAiApiKey,
                analysisType: 'news', // ä½¿ç”¨é»˜èªçš„åˆ†æé¡å‹
                platform: currentAiPlatform
            })
        });

        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }

        document.getElementById('aiKeyStatus').innerHTML = 
            '<span class="badge bg-success">âœ“ é€£ç·šæ­£å¸¸</span>';
        log(`âœ… ${currentAiPlatform} API é€£ç·šæ¸¬è©¦æˆåŠŸ`);
        alert(`âœ… ${currentAiPlatform} API é€£ç·šæ­£å¸¸ï¼`);
        
    } catch (error) {
        let errorMessage = 'é€£ç·šå¤±æ•—';
        if (error.message.includes('API Key') || error.message.includes('401')) {
            errorMessage = 'API Key ç„¡æ•ˆæˆ–å·²éæœŸ';
        } else if (error.message.includes('network') || error.message.includes('fetch') || error.message.includes('ECONNREFUSED')) {
            errorMessage = 'ç¶²çµ¡é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥';
        } else if (error.message.includes('timeout')) {
            errorMessage = 'è«‹æ±‚è¶…æ™‚';
        } else if (error.message.includes('502') || error.message.includes('503')) {
            errorMessage = 'æœå‹™å™¨æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œé‡è©¦';
        }
        
        document.getElementById('aiKeyStatus').innerHTML = 
            `<span class="badge bg-danger">âœ— ${errorMessage}</span>`;
        log(`âŒ API é€£ç·šæ¸¬è©¦å¤±æ•—: ${error.message}`);
        alert(`âŒ ${errorMessage}\n\nè©³ç´°ä¿¡æ¯: ${error.message}`);
    } finally {
        testBtn.innerHTML = originalText;
        testBtn.disabled = false;
    }
});

    // æ”¹é€²çš„ API Key é©—è­‰
    document.getElementById('verifyAiKey').addEventListener('click', async function() {
        if (!currentAiApiKey) {
            alert('è«‹è¼¸å…¥ API Key');
            return;
        }

        const verifyBtn = this;
        const originalText = verifyBtn.innerHTML;
        verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>é©—è­‰ä¸­...';
        verifyBtn.disabled = true;

        try {
            // åŸºç¤æ ¼å¼é©—è­‰
            if ((currentAiPlatform === 'gpt' || currentAiPlatform === 'deepseek') && !currentAiApiKey.startsWith('sk-')) {
                throw new Error('API Key æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰è©²ä»¥ sk- é–‹é ­');
            }
            if (currentAiPlatform === 'claude' && !currentAiApiKey.startsWith('sk-ant-')) {
                throw new Error('Claude API Key æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰è©²ä»¥ sk-ant- é–‹é ­');
            }

            // ä¿å­˜é…ç½®
            const aiConfig = {
                platform: currentAiPlatform,
                apiKey: currentAiApiKey,
                verified: true
            };
            localStorage.setItem('joseph_pai_ai_config', JSON.stringify(aiConfig));
            
            isAiKeyVerified = true;
            updateAiButtonState();
            
            document.getElementById('aiKeyStatus').innerHTML = 
                '<span class="badge bg-success">âœ“ æ ¼å¼é©—è­‰æˆåŠŸ</span>';
            
            log(`âœ… ${currentAiPlatform} API Key æ ¼å¼é©—è­‰æˆåŠŸ`);
            
        } catch (error) {
            document.getElementById('aiKeyStatus').innerHTML = 
                '<span class="badge bg-danger">âœ— é©—è­‰å¤±æ•—</span>';
            log(`âŒ API Key é©—è­‰å¤±æ•—: ${error.message}`);
            alert(`é©—è­‰å¤±æ•—: ${error.message}`);
        } finally {
            verifyBtn.innerHTML = originalText;
            verifyBtn.disabled = false;
        }
    });

    // API Key è¼¸å…¥è®ŠåŒ–
    document.getElementById('aiApiKey').addEventListener('input', function() {
        currentAiApiKey = this.value.trim();
        updateAiButtonState();
        
        // æ¸…é™¤é©—è­‰ç‹€æ…‹
        if (currentAiApiKey === '') {
            document.getElementById('aiKeyStatus').innerHTML = '';
            isAiKeyVerified = false;
        }
    });

    // æ”¹é€²çš„ AI åˆ†æéŒ¯èª¤è™•ç†
    // AIåˆ†ææŒ‰éˆ• - ä½¿ç”¨çµæ§‹åŒ–åˆ†æ
// åœ¨ AI åˆ†ææŒ‰éˆ•çš„é»æ“Šäº‹ä»¶ä¸­ï¼Œæ·»åŠ å¹³å°æª¢æŸ¥
document.getElementById('aiAnalyzeBtn').addEventListener('click', async function() {
    const symbol = document.getElementById('stockSelect').value.trim();
    if (!symbol) {
        alert('è«‹å…ˆé¸æ“‡è‚¡ç¥¨');
        return;
    }

    if (!currentAiApiKey) {
        alert('è«‹å…ˆè¼¸å…¥ API Key');
        return;
    }

    // ç¢ºä¿è‚¡ç¥¨åç¨±æ­£ç¢ºç²å–
    const stockSelect = document.getElementById('stockSelect');
    const selectedOption = stockSelect.options[stockSelect.selectedIndex];
    let stockName = selectedOption.textContent.replace(/^\d+\s/, ''); // ç§»é™¤è‚¡ç¥¨ä»£ç¢¼éƒ¨åˆ†
    
    // å¦‚æœç„¡æ³•å¾é¸é …ç²å–ï¼Œå˜—è©¦å¾ stockData ä¸­æŸ¥æ‰¾
    if (!stockName || stockName === symbol) {
        const stockInfo = stockData.find(s => s.stock_id === symbol);
        stockName = stockInfo ? stockInfo.stock_name : symbol;
    }

    const analysisType = document.querySelector('input[name="analysisType"]:checked').value;
    const analyzeBtn = this;
    const spinner = document.getElementById('aiSpinner');
    
    analyzeBtn.disabled = true;
    spinner.style.display = 'inline-block';
    
    // é¡¯ç¤ºç•¶å‰ä½¿ç”¨çš„å¹³å°
    document.getElementById('aiKeyStatus').innerHTML = 
        `<span class="badge bg-info">ğŸ”„ ${currentAiPlatform} åˆ†æä¸­... (ç´„20ç§’)</span>`;
    
    try {
        log(`é–‹å§‹ ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'} AI åˆ†æ: ${symbol} ${stockName}, å¹³å°: ${currentAiPlatform}`);
        
        // ä½¿ç”¨çµæ§‹åŒ–åˆ†æå‡½æ•¸
        const response = await fetch('/.netlify/functions/structured-analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                stockId: symbol,
                stockName: stockName,
                apiKey: currentAiApiKey,
                analysisType: analysisType,
                platform: currentAiPlatform
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }

        // é¡¯ç¤ºçµæ§‹åŒ–çµæœ
        document.getElementById('aiAnalysisContent').textContent = result.content;
        document.getElementById('aiScoreDisplay').textContent = 
            result.score > 0 ? `+${result.score}` : result.score;
        document.getElementById('aiComment').textContent = result.comment;
        
        // æ›´æ–°è©•åˆ†é¡¯ç¤º
        const scoreDisplay = document.getElementById('aiScoreDisplay');
        scoreDisplay.className = 'fs-1 fw-bold ' + 
            (result.score > 0 ? 'text-success' : 
             result.score < 0 ? 'text-danger' : 'text-warning');
        
        document.getElementById('aiAnalysisResult').style.display = 'block';
        
        // é¡¯ç¤ºè©•åˆ†æ˜ç´°
        displayScoreDetails(analysisType, result.content, result.score, stockName);
        
        // ä¿å­˜åˆ†ææ­·å²
        saveAnalysisHistory(analysisType, result, stockName);
        
        // è‡ªå‹•æ‡‰ç”¨è©•åˆ†
        if (document.getElementById('autoApplyScore').checked) {
            applyAiScoreToSystem(result.score, analysisType);
        }
        
        document.getElementById('aiKeyStatus').innerHTML = 
            `<span class="badge bg-success">âœ“ ${currentAiPlatform} åˆ†æå®Œæˆ</span>`;
        
        log(`âœ… ${currentAiPlatform} ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'} AIåˆ†æå®Œæˆï¼Œè©•åˆ†: ${result.score}`);
        
    } catch (error) {
        document.getElementById('aiKeyStatus').innerHTML = 
            `<span class="badge bg-danger">âœ— ${currentAiPlatform} åˆ†æå¤±æ•—</span>`;
        log(`âŒ ${currentAiPlatform} AIåˆ†æå¤±æ•—: ${error.message}`);
        alert(`${currentAiPlatform} åˆ†æå¤±æ•—: ${error.message}`);
    } finally {
        analyzeBtn.disabled = false;
        spinner.style.display = 'none';
    }
});

    // æ‡‰ç”¨è©•åˆ†åˆ°ç³»çµ±
    document.getElementById('applyAiScore').addEventListener('click', function() {
        const score = parseInt(document.getElementById('aiScoreDisplay').textContent);
        const analysisType = document.querySelector('input[name="analysisType"]:checked').value;
        applyAiScoreToSystem(score, analysisType);
    });

    // æ¸…é™¤åˆ†æçµæœ
    document.getElementById('clearAiAnalysis').addEventListener('click', function() {
        document.getElementById('aiAnalysisResult').style.display = 'none';
        document.getElementById('aiAnalysisContent').textContent = '';
        document.getElementById('aiScoreDisplay').textContent = '0';
        document.getElementById('aiComment').textContent = '';
        // æ¸…é™¤æ­·å²
        analysisHistory.news = null;
        analysisHistory.risk = null;
    });

    // æ›´æ–° AI æŒ‰éˆ•ç‹€æ…‹
    function updateAiButtonState() {
        const analyzeBtn = document.getElementById('aiAnalyzeBtn');
        analyzeBtn.disabled = !isAiKeyVerified || !currentAiApiKey;
        
        if (isAiKeyVerified && currentAiApiKey) {
            document.getElementById('aiKeyStatus').innerHTML = 
                '<span class="badge bg-success">âœ“ å·²é©—è­‰</span>';
        } else {
            document.getElementById('aiKeyStatus').innerHTML = 
                '<span class="badge bg-warning">å¾…é©—è­‰</span>';
        }
    }

    // æ‡‰ç”¨ AI è©•åˆ†åˆ°è©•åˆ†ç³»çµ±
    function applyAiScoreToSystem(score, analysisType) {
        const targetField = analysisType === 'news' ? 'news' : 'risk';
        const weight = weights[targetField] || 10;
        
        // è¨ˆç®—åŠ æ¬Šåˆ†æ•¸
        const weightedScore = Math.round((score / 10) * weight);
        
        // æ›´æ–°å°æ‡‰çš„è©•åˆ†é¡¯ç¤º
        const scoreElement = document.getElementById(`score_${targetField}`);
        if (scoreElement) {
            scoreElement.textContent = weightedScore;
            scoreElement.className = `badge ${weightedScore >= 0 ? 'badge-pos' : 'badge-neg'} fs-5`;
        }
        
        // æ›´æ–°èªªæ˜æ–‡å­—
        const descElement = scoreElement?.closest('tr')?.querySelector('td:nth-child(4)');
        if (descElement) {
            const typeName = analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢';
            descElement.innerHTML = `<small>AI ${typeName}åˆ†æè©•åˆ†: ${score} â†’ åŠ æ¬Š: ${weightedScore}</small>`;
        }
        
        // æ›´æ–°ç¸½åˆ†
        updateTotalScore();
        
        log(`âœ… AI ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}è©•åˆ† ${score} å·²æ‡‰ç”¨åˆ°ç³»çµ± (åŠ æ¬Š: ${weightedScore})`);
        alert(`AI è©•åˆ†å·²æˆåŠŸæ‡‰ç”¨åˆ°${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}ï¼`);
    }

    // ================= åˆ†æé¡å‹åˆ‡æ›ç›£è½ =================
    document.querySelectorAll('input[name="analysisType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const analysisType = this.value;
            console.log(`åˆ‡æ›åˆ° ${analysisType} åˆ†æ`);
            
            // å¦‚æœå·²ç¶“æœ‰åˆ†æçµæœé¡¯ç¤ºï¼Œå˜—è©¦è¼‰å…¥æ­·å²
            if (document.getElementById('aiAnalysisResult').style.display !== 'none') {
                const loaded = loadAnalysisHistory(analysisType);
                if (!loaded) {
                    // å¦‚æœæ²’æœ‰æ­·å²ï¼Œé¡¯ç¤ºæç¤º
                    document.getElementById('aiAnalysisContent').textContent = `è«‹å…ˆé€²è¡Œ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}åˆ†æ`;
                    document.getElementById('aiScoreDisplay').textContent = '0';
                    document.getElementById('aiComment').textContent = 'å°šæœªé€²è¡Œåˆ†æ';
                    
                    // éš±è—è©•åˆ†æ˜ç´°è¡¨æ ¼
                    document.getElementById('newsScoreTable').style.display = 'none';
                    document.getElementById('riskScoreTable').style.display = 'none';
                }
            }
        });
    });

    // ================= æ–°å¢ï¼šé¡¯ç¤ºè©•åˆ†æ˜ç´°å‡½æ•¸ =================
    function displayScoreDetails(analysisType, content, score, stockName) {
        const newsTable = document.getElementById('newsScoreTable');
        const riskTable = document.getElementById('riskScoreTable');
        const newsDetails = document.getElementById('newsScoreDetails');
        const riskDetails = document.getElementById('riskScoreDetails');
        
        // éš±è—æ‰€æœ‰è¡¨æ ¼
        newsTable.style.display = 'none';
        riskTable.style.display = 'none';
        
        if (analysisType === 'news') {
            // é¡¯ç¤ºæ¶ˆæ¯é¢è©•åˆ†è¡¨æ ¼
            newsTable.style.display = 'block';
            
            // å¾AIå›æ‡‰å…§å®¹ä¸­æå–æ­£é¢å’Œè² é¢å› ç´ 
            const positives = extractFactors(content, 'æ­£é¢');
            const negatives = extractFactors(content, 'è² é¢');
            
            // ç”Ÿæˆè©•åˆ†æ•¸æ“š
            const newsScoreData = generateNewsScoreData(positives, negatives, score);
            
            newsDetails.innerHTML = newsScoreData.map(item => `
                <tr>
                    <td><strong>${item.item}</strong></td>
                    <td>${item.analysis}</td>
                    <td>${item.score > 0 ? '+' : ''}${item.score}</td>
                </tr>
            `).join('');
            
            document.getElementById('newsTotalScore').textContent = score > 0 ? `+${score}` : score;
            
            // ç”Ÿæˆè©•èª
            const comment = generateNewsComment(score, stockName, positives, negatives);
            document.getElementById('newsFinalComment').textContent = comment;
            
        } else {
            // é¡¯ç¤ºé¢¨éšªé¢è©•åˆ†è¡¨æ ¼
            riskTable.style.display = 'block';
            
            // å¾AIå›æ‡‰å…§å®¹ä¸­æå–é¢¨éšªå’Œç·©è¡å› ç´ 
            const risks = extractFactors(content, 'é¢¨éšª');
            const buffers = extractFactors(content, 'ç·©è¡');
            
            // ç”Ÿæˆè©•åˆ†æ•¸æ“š - ç¢ºä¿æœ‰åˆç†çš„åˆ†æ•¸åˆ†é…
            const riskScoreData = generateRiskScoreData(risks, buffers, score);
            
            riskDetails.innerHTML = riskScoreData.map(item => `
                <tr>
                    <td><strong>${item.item}</strong></td>
                    <td>${item.analysis}</td>
                    <td>${item.score > 0 ? '+' : ''}${item.score}</td>
                </tr>
            `).join('');
            
            document.getElementById('riskTotalScore').textContent = score > 0 ? `+${score}` : score;
            
            // ç”Ÿæˆè©•èª
            const comment = generateRiskComment(score, stockName, risks, buffers);
            document.getElementById('riskFinalComment').textContent = comment;
        }
    }

    // å¾AIå›æ‡‰ä¸­æå–å› ç´ 
    function extractFactors(content, type) {
        const factors = [];
        const lines = content.split('\n');
        let inSection = false;
        
        for (const line of lines) {
            const trimmed = line.trim();
            
            if (trimmed.includes(type) || trimmed.includes(type === 'æ­£é¢' ? 'åˆ©å¤š' : type === 'é¢¨éšª' ? 'é«˜é¢¨éšª' : 'ç·©è¡')) {
                inSection = true;
                continue;
            }
            
            if (inSection && (trimmed.includes('è² é¢') || trimmed.includes('åˆ©ç©º') || trimmed.includes('ä¸­é¢¨éšª') || trimmed.includes('ä½é¢¨éšª') || trimmed === '')) {
                break;
            }
            
            if (inSection && trimmed.match(/^\d+\./)) {
                factors.push(trimmed.replace(/^\d+\.\s*/, '').trim());
            }
        }
        
        return factors.length > 0 ? factors : [`${type}å› ç´ åˆ†æè©³è¦‹å®Œæ•´å ±å‘Š`];
    }

    // ç”Ÿæˆæ¶ˆæ¯é¢è©•åˆ†æ•¸æ“š
    function generateNewsScoreData(positives, negatives, totalScore) {
        const items = [];
        let currentScore = 0;
        
        // æ­£é¢å› ç´ 
        positives.forEach((positive, index) => {
            if (index < 3) {
                const score = Math.min(4, Math.max(1, Math.floor((4 - index) * 0.8)));
                items.push({
                    item: `æ­£é¢å› ç´  ${index + 1}`,
                    analysis: positive,
                    score: score
                });
                currentScore += score;
            }
        });
        
        // è² é¢å› ç´ 
        negatives.forEach((negative, index) => {
            if (index < 2) {
                const score = Math.max(-2, Math.min(-1, -Math.floor((2 - index) * 0.5)));
                items.push({
                    item: `è² é¢å› ç´  ${index + 1}`,
                    analysis: negative,
                    score: score
                });
                currentScore += score;
            }
        });
        
        // èª¿æ•´åˆ†æ•¸ä»¥åŒ¹é…ç¸½åˆ†
        const scoreDiff = totalScore - currentScore;
        if (scoreDiff !== 0 && items.length > 0) {
            // å°‡å·®ç•°åˆ†é…åˆ°ç¬¬ä¸€å€‹é …ç›®
            items[0].score += scoreDiff;
        }
        
        return items;
    }

    // ç”Ÿæˆé¢¨éšªé¢è©•åˆ†æ•¸æ“š
    function generateRiskScoreData(risks, buffers, totalScore) {
        const items = [];
        
        // ç¢ºä¿æœ‰åˆç†çš„é¢¨éšªå› ç´ 
        const actualRisks = risks.length > 0 ? risks : [
            'è¡Œæ¥­ç«¶çˆ­åŠ åŠ‡å½±éŸ¿å¸‚å ´ä»½é¡',
            'åŸææ–™æˆæœ¬ä¸Šæ¼²å£“ç¸®åˆ©æ½¤ç©ºé–“',
            'æŠ€è¡“è¿­ä»£å¿«é€Ÿå¸¶ä¾†ç ”ç™¼å£“åŠ›'
        ];
        
        // ç¢ºä¿æœ‰åˆç†çš„ç·©è¡å› ç´ 
        const actualBuffers = buffers.length > 0 ? buffers : [
            'å…¬å¸è²¡å‹™çµæ§‹ç©©å¥ç¾é‡‘æµå……è¶³',
            'æŠ€è¡“é ˜å…ˆåœ°ä½æä¾›ç«¶çˆ­å„ªå‹¢',
            'å¤šå…ƒåŒ–å®¢æˆ¶åŸºç¤åˆ†æ•£é¢¨éšª'
        ];
        
        // é¢¨éšªå› ç´ åˆ†æ•¸åˆ†é…ï¼ˆè² åˆ†ï¼‰
        actualRisks.forEach((risk, index) => {
            if (index < 3) {
                const baseScore = -Math.max(1, Math.min(3, 4 - index)); // -3, -2, -1
                items.push({
                    item: `é¢¨éšªå› ç´  ${index + 1}`,
                    analysis: risk,
                    score: baseScore
                });
            }
        });
        
        // ç·©è¡å› ç´ åˆ†æ•¸åˆ†é…ï¼ˆæ­£åˆ†ï¼‰
        actualBuffers.forEach((buffer, index) => {
            if (index < 3) {
                const baseScore = Math.max(1, Math.min(3, 3 - index)); // +3, +2, +1
                items.push({
                    item: `é¢¨éšªç·©è¡ ${index + 1}`,
                    analysis: buffer,
                    score: baseScore
                });
            }
        });
        
        // è¨ˆç®—ç•¶å‰ç¸½åˆ†
        let currentTotal = items.reduce((sum, item) => sum + item.score, 0);
        
        // èª¿æ•´åˆ†æ•¸ä»¥åŒ¹é…ç›®æ¨™ç¸½åˆ†
        const diff = totalScore - currentTotal;
        if (diff !== 0 && items.length > 0) {
            // å°‡å·®ç•°åˆ†é…åˆ°ç¬¬ä¸€å€‹é …ç›®
            items[0].score += diff;
        }
        
        return items;
    }

    // ç”Ÿæˆæ¶ˆæ¯é¢è©•èª
    function generateNewsComment(score, stockName, positives, negatives) {
        if (score >= 7) {
            return `${stockName}åœ¨å¸‚å ´æ¶ˆæ¯é¢ä¸Šç²å¾— +${score} åˆ†ã€‚é€™ä»£è¡¨å…¶åŸºæœ¬é¢éå¸¸ç©©å›ºï¼Œå¸‚å ´å°å…¶å‰æ™¯æŠ±æŒæ¥µåº¦æ¨‚è§€çš„æ…‹åº¦ã€‚ä¸»è¦åˆ©å¤šå› ç´ åŒ…æ‹¬${positives.slice(0,2).join('ã€')}ç­‰ã€‚`;
        } else if (score >= 3) {
            return `${stockName}åœ¨å¸‚å ´æ¶ˆæ¯é¢ä¸Šç²å¾— +${score} åˆ†ã€‚æ•´é«”è¡¨ç¾ç©©å¥ï¼Œå¸‚å ´çœ‹æ³•åå‘æ­£é¢ã€‚æ­£é¢å› ç´ å¦‚${positives[0]}ï¼Œä½†éœ€æ³¨æ„${negatives[0]}ç­‰é¢¨éšªã€‚`;
        } else if (score >= -2) {
            return `${stockName}åœ¨å¸‚å ´æ¶ˆæ¯é¢ä¸Šç²å¾— ${score} åˆ†ã€‚å¸‚å ´çœ‹æ³•ä¸­æ€§ï¼Œåˆ©å¤šåˆ©ç©ºå› ç´ ç›¸äº’æŠµæ¶ˆã€‚éœ€è¦é—œæ³¨å¾ŒçºŒç™¼å±•ã€‚`;
        } else {
            return `${stockName}åœ¨å¸‚å ´æ¶ˆæ¯é¢ä¸Šç²å¾— ${score} åˆ†ã€‚å¸‚å ´å­˜åœ¨è¼ƒå¤šç–‘æ…®ï¼Œä¸»è¦é¢¨éšªåŒ…æ‹¬${negatives.slice(0,2).join('ã€')}ç­‰ã€‚å»ºè­°è¬¹æ…è©•ä¼°ã€‚`;
        }
    }

    // ç”Ÿæˆé¢¨éšªé¢è©•èª
    function generateRiskComment(score, stockName, risks, buffers) {
        if (score >= 3) {
            return `${stockName}åœ¨é¢¨éšªé¢ä¸Šç²å¾— +${score} åˆ†ã€‚é¢¨éšªæ§åˆ¶è‰¯å¥½ï¼Œå…·å‚™è¼ƒå¼·çš„é¢¨éšªæŠµæŠ—åŠ›ã€‚ä¸»è¦å„ªå‹¢åŒ…æ‹¬${buffers.slice(0,2).join('ã€')}ç­‰ã€‚`;
        } else if (score >= -2) {
            return `${stockName}åœ¨é¢¨éšªé¢ä¸Šç²å¾— ${score} åˆ†ã€‚é¢¨éšªæ°´å¹³é©ä¸­ï¼Œéœ€è¦æŒçºŒé—œæ³¨${risks[0]}ç­‰é¢¨éšªå› ç´ ï¼Œä½†å…¬å¸å…·å‚™${buffers[0]}ç­‰ç·©è¡èƒ½åŠ›ã€‚`;
        } else {
            return `${stockName}åœ¨é¢¨éšªé¢ä¸Šç²å¾— ${score} åˆ†ã€‚é¢¨éšªå› ç´ è¼ƒç‚ºé¡¯è‘—ï¼Œç‰¹åˆ¥æ˜¯${risks.slice(0,2).join('ã€')}ç­‰å•é¡Œã€‚æŠ•è³‡è€…éœ€å¯†åˆ‡ç›£æ§é¢¨éšªè®ŠåŒ–ã€‚`;
        }
    }

    // ================= æ ¸å¿ƒ API å‡½æ•¸ =================

    async function fetchFinmind(dataset, dataId = '', startDate = '', endDate = '', retries = 3) {
        if (!TOKEN && dataset !== 'TaiwanStockInfo') return null;
        let url = `/.netlify/functions/fetch-finmind?dataset=${dataset}`;
        if (dataId) url += `&data_id=${dataId}`;
        if (startDate) url += `&start_date=${startDate}`;
        if (endDate) url += `&end_date=${endDate}`;
        if (TOKEN) url += `&token=${TOKEN}`;
        
        for (let attempt = 1; attempt <= retries; attempt++) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    if (attempt < retries) { await new Promise(r => setTimeout(r, 1000 * attempt)); continue; }
                    return null;
                }
                const data = await response.json();
                if (data.status === 200 && data.data) return data;
            } catch (err) { if (attempt < retries) await new Promise(r => setTimeout(r, 1000 * attempt)); }
        }
        return null;
    }

    async function fetchYahooWithProxy(symbol, logName) {
        log(`${logName} è«‹æ±‚ä¸­ (é€é Netlify Price Function ä»£ç†)...`);
        try {
            const response = await fetch(`/.netlify/functions/fetch-price?id=${symbol}`);
            if (!response.ok) {
                log(`${logName} ä»£ç†å¤±æ•—: ${response.status}`);
                return null;
            }
            const data = await response.json(); 
            if (data && data.chart?.result?.[0]) {
                log(`${logName} æˆåŠŸï¼`);
                return data;
            }
            log(`${logName} å¤±æ•—: æ ¼å¼éŒ¯èª¤`);
            return null;
        } catch (err) {
            log(`${logName} å¤±æ•—: ${err.message}`);
            return null;
        }
    }

    async function fetchTWSEPrice(stockId) {
        try {
            const response = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY?stockNo=${stockId}`);
            if (!response.ok) return null;
            const data = await response.json();
            return (data && Array.isArray(data) && data.length > 0) ? data : null;
        } catch (err) { return null; }
    }

    // ================= è²¡å‹™æ•¸æ“šç²å– - å„ªå…ˆ FinMind =================
    
    async function fetchFinancialData(stockId) {
        log(`é–‹å§‹ç²å–è²¡å‹™æ•¸æ“š: ${stockId}`);
        
        // é‡ç½®è²¡å‹™å¿«å–
        financialCache = {
            eps: { quarters: {}, year: null },
            roe: { quarters: {}, year: null },
            revenueGrowth: { months: {}, quarters: {}, year: null },
            profitMargin: { quarters: {}, year: null }
        };
        
        let source = 'Unknown';
        
        // 1. å„ªå…ˆå¾ FinMind ç²å–æ•¸æ“š
        if (TOKEN) {
            log('å˜—è©¦å¾ FinMind ç²å–è²¡å‹™æ•¸æ“š...');
            const finmindData = await fetchFinmindFinancials(stockId);
            if (finmindData) {
                source = 'FinMind';
                log('âœ… FinMind è²¡å‹™æ•¸æ“šè¼‰å…¥æˆåŠŸ');
                return { source, data: finmindData };
            }
        }
        
        // 2. å‚™æ´ï¼šè­‰äº¤æ‰€è²¡å ±
        log('FinMind å¤±æ•—ï¼Œå˜—è©¦è­‰äº¤æ‰€è²¡å ±...');
        const twseData = await fetchTWSEFinancials(stockId);
        if (twseData) {
            source = 'TWSE';
            log('âœ… è­‰äº¤æ‰€è²¡å‹™æ•¸æ“šè¼‰å…¥æˆåŠŸ');
            return { source, data: twseData };
        }
        
        // 3. æœ€çµ‚å‚™æ´ï¼šYahoo Finance
        log('è­‰äº¤æ‰€å¤±æ•—ï¼Œå˜—è©¦ Yahoo Finance...');
        const yahooData = await fetchYahooFinanceFinancials(stockId);
        if (yahooData) {
            source = 'Yahoo Finance';
            log('âœ… Yahoo Finance è²¡å‹™æ•¸æ“šè¼‰å…¥æˆåŠŸ');
            return { source, data: yahooData };
        }
        
        log('âŒ æ‰€æœ‰è²¡å‹™æ•¸æ“šä¾†æºéƒ½å¤±æ•—');
        return null;
    }

    async function fetchFinmindFinancials(stockId) {
        try {
            log(`ğŸ” FinMind æ•¸æ“šç²å–é–‹å§‹: ${stockId}`);
            
            // ä½¿ç”¨æ­£ç¢ºçš„æ•¸æ“šé›† - è²¡å‹™å ±è¡¨åŒ…å« EPS å’Œæ¯›åˆ©ç‡æ•¸æ“š
            const [financialStatement, balanceSheet, revenueData] = await Promise.all([
                fetchFinmind('TaiwanStockFinancialStatements', stockId, '2020-01-01'),
                fetchFinmind('TaiwanStockBalanceSheet', stockId, '2020-01-01'),
                fetchFinmind('TaiwanStockMonthRevenue', stockId, '2020-01-01')
            ]);

            // è©³ç´°çš„æ•¸æ“šæª¢æŸ¥æ—¥èªŒ
            log(`ğŸ“Š FinMind æ•¸æ“šæª¢æŸ¥:`);
            log(`- è²¡å‹™å ±è¡¨ç­†æ•¸: ${financialStatement?.data?.length || 0}`);
            log(`- è³‡ç”¢è² å‚µè¡¨ç­†æ•¸: ${balanceSheet?.data?.length || 0}`);
            log(`- æœˆç‡Ÿæ”¶ç­†æ•¸: ${revenueData?.data?.length || 0}`);

            if (!financialStatement && !balanceSheet && !revenueData) {
                log('âŒ FinMind æ‰€æœ‰æ•¸æ“šé›†éƒ½ç‚ºç©º');
                return null;
            }

            // è™•ç†è²¡å‹™å ±è¡¨æ•¸æ“š - æŒ‰æ—¥æœŸå’Œé¡å‹é‡çµ„
            if (financialStatement?.data) {
                log(`ğŸ”„ é‡çµ„è²¡å‹™å ±è¡¨æ•¸æ“š...`);
                
                // æŒ‰æ—¥æœŸåˆ†çµ„æ•¸æ“š
                const byDate = {};
                financialStatement.data.forEach(item => {
                    if (!byDate[item.date]) byDate[item.date] = {};
                    byDate[item.date][item.type] = item.value;
                    byDate[item.date]['_origin'] = byDate[item.date]['_origin'] || {};
                    byDate[item.date]['_origin'][item.type] = item.origin_name;
                });

                // æŒ‰å­£åº¦åˆ†çµ„æ•¸æ“šï¼ˆç¢ºä¿ Q1-Q4 é †åºï¼‰
                const byQuarter = {};
                let latestYearEPS = 0;
                let latestYearDate = '';
                
                // è™•ç†æ¯å€‹æ—¥æœŸçš„æ•¸æ“š
                const dates = Object.keys(byDate).sort().reverse(); // å¾æœ€æ–°åˆ°æœ€èˆŠ
                
                dates.forEach(date => {
                    const data = byDate[date];
                    const dateObj = new Date(date);
                    const year = dateObj.getFullYear();
                    const month = dateObj.getMonth() + 1;
                    const quarter = Math.floor((month + 2) / 3);
                    const quarterKey = `${year}Q${quarter}`;
                    
                    log(`ğŸ“… è™•ç† ${date} (${year}Q${quarter}) æ•¸æ“š:`);

                    // 1. è™•ç† EPS æ•¸æ“š
                    if (data.EPS !== undefined) {
                        const eps = parseFloat(data.EPS);
                        if (!isNaN(eps)) {
                            if (!byQuarter[quarterKey]) byQuarter[quarterKey] = {};
                            byQuarter[quarterKey].eps = eps;
                            byQuarter[quarterKey].date = date;
                            byQuarter[quarterKey].year = year;
                            byQuarter[quarterKey].quarter = quarter;
                            
                            log(`  âœ… EPS ${year}Q${quarter}: ${eps}`);
                            
                            // è¨ˆç®—å¹´åº¦ EPS (ç´¯è¨ˆæœ€è¿‘4å€‹å­£åº¦)
                            if (year === 2025) { // åªè¨ˆç®—2025å¹´åº¦çš„EPS
                                latestYearEPS += eps;
                                latestYearDate = date;
                            }
                        }
                    }

                    // 2. è¨ˆç®—æ¯›åˆ©ç‡
                    if (data.Revenue !== undefined && data.CostOfGoodsSold !== undefined) {
                        const revenue = parseFloat(data.Revenue);
                        const cost = parseFloat(data.CostOfGoodsSold);
                        
                        if (!isNaN(revenue) && !isNaN(cost) && revenue > 0) {
                            const grossProfit = revenue - cost;
                            const margin = (grossProfit / revenue) * 100;
                            
                            if (!byQuarter[quarterKey]) byQuarter[quarterKey] = {};
                            byQuarter[quarterKey].profitMargin = parseFloat(margin.toFixed(2));
                            log(`  âœ… æ¯›åˆ©ç‡ ${year}Q${quarter}: ${margin.toFixed(2)}%`);
                        }
                    }

                    // 3. è¨ˆç®— ROE - ä½¿ç”¨æ­£ç¢ºçš„æ·¨åˆ©å’Œè‚¡æ±æ¬Šç›Š
                    if (data.IncomeAfterTaxes !== undefined || data.TotalConsolidatedProfitForThePeriod !== undefined) {
                        const netIncome = parseFloat(data.IncomeAfterTaxes || data.TotalConsolidatedProfitForThePeriod);
                        
                        if (balanceSheet?.data && !isNaN(netIncome)) {
                            const balanceItem = balanceSheet.data.find(b => b.date === date);
                            if (balanceItem) {
                                // å˜—è©¦ä¸åŒçš„è‚¡æ±æ¬Šç›Šå­—æ®µåç¨±
                                const equity = parseFloat(balanceItem.equity || balanceItem.total_equity || 
                                                       balanceItem['æ¬Šç›Šç¸½è¨ˆ'] || balanceItem['æ¬Šç›Šç¸½é¡'] ||
                                                       balanceItem['æ­¸å±¬æ–¼æ¯å…¬å¸æ¥­ä¸»ä¹‹æ¬Šç›Šåˆè¨ˆ']);
                                
                                if (!isNaN(equity) && equity > 0) {
                                    const roe = (netIncome / equity) * 100;
                                    
                                    if (!byQuarter[quarterKey]) byQuarter[quarterKey] = {};
                                    byQuarter[quarterKey].roe = parseFloat(roe.toFixed(2));
                                    log(`  âœ… ROE ${year}Q${quarter}: ${roe.toFixed(2)}% (æ·¨åˆ©: ${netIncome}, æ¬Šç›Š: ${equity})`);
                                    
                                    // è¨­ç½®å¹´åº¦ ROE (ä½¿ç”¨æœ€æ–°å­£åº¦çš„)
                                    if (year === 2025 && (!financialCache.roe.year || dateObj > new Date(financialCache.roe._latestDate || 0))) {
                                        financialCache.roe.year = parseFloat(roe.toFixed(2));
                                        financialCache.roe._latestDate = date;
                                    }
                                } else {
                                    log(`  âš ï¸ è‚¡æ±æ¬Šç›Šç‚ºé›¶æˆ–ç„¡æ•ˆ: ${equity}`);
                                }
                            } else {
                                log(`  âš ï¸ æ‰¾ä¸åˆ°å°æ‡‰æ—¥æœŸçš„è³‡ç”¢è² å‚µè¡¨æ•¸æ“š: ${date}`);
                            }
                        } else {
                            log(`  âš ï¸ æ·¨åˆ©æ•¸æ“šç„¡æ•ˆ: ${netIncome}`);
                        }
                    } else {
                        log(`  âš ï¸ ç¼ºå°‘æ·¨åˆ©æ•¸æ“š`);
                    }
                });

                // è¨­ç½®å¹´åº¦ EPS
                if (latestYearEPS > 0) {
                    financialCache.eps.year = parseFloat(latestYearEPS.toFixed(2));
                    log(`ğŸ’° 2025å¹´åº¦ EPS: ${financialCache.eps.year} (ç´¯è¨ˆ: ${latestYearEPS})`);
                }

                // åˆªé™¤æ¯›åˆ©ç‡å¹´åº¦æ•¸æ“š
                financialCache.profitMargin.year = null;

                // æŒ‰æ­£ç¢ºçš„å­£åº¦é †åº (Q1, Q2, Q3, Q4) çµ„ç¹”æ•¸æ“š
                const quarterKeys = Object.keys(byQuarter).sort().reverse(); // å¾æœ€æ–°åˆ°æœ€èˆŠ
                
                // åªå–æœ€è¿‘4å€‹å­£åº¦
                const recentQuarters = quarterKeys.slice(0, 4);
                
                // æŒ‰ Q1, Q2, Q3, Q4 é †åºé‡æ–°æ’åˆ—
                const sortedQuarters = recentQuarters.sort((a, b) => {
                    const [yearA, quarterA] = a.split('Q');
                    const [yearB, quarterB] = b.split('Q');
                    
                    if (yearA !== yearB) return yearB - yearA; // å¹´ä»½æ–°çš„åœ¨å‰
                    return quarterA - quarterB; // å­£åº¦å°çš„åœ¨å‰ (Q1, Q2, Q3, Q4)
                });
                
                log(`ğŸ”„ æŒ‰å­£åº¦é †åºçµ„ç¹”æ•¸æ“š: ${sortedQuarters.join(', ')}`);
                
                // å°‡æ•¸æ“šå¡«å…¥ financialCache
                sortedQuarters.forEach(quarterKey => {
                    const data = byQuarter[quarterKey];
                    const quarterNum = quarterKey.split('Q')[1];
                    
                    if (data.eps !== undefined) {
                        financialCache.eps.quarters[`Q${quarterNum}`] = data.eps;
                    }
                    
                    if (data.profitMargin !== undefined) {
                        financialCache.profitMargin.quarters[`Q${quarterNum}`] = data.profitMargin;
                    }
                    
                    if (data.roe !== undefined) {
                        financialCache.roe.quarters[`Q${quarterNum}`] = data.roe;
                    }
                });

                // å¦‚æœæ²’æœ‰ ROE æ•¸æ“šï¼Œè¨­ç½®é è¨­å€¼
                if (Object.keys(financialCache.roe.quarters).length === 0) {
                    log(`âš ï¸ æ²’æœ‰ ROE æ•¸æ“šï¼Œè¨­ç½®é è¨­å€¼`);
                    financialCache.roe.quarters = {
                        'Q1': 9.36,
                        'Q2': 9.36, 
                        'Q3': 9.36,
                        'Q4': 9.36
                    };
                    financialCache.roe.year = 26.07;
                }
            }

            // è™•ç†ç‡Ÿæ”¶æˆé•·ç‡
            if (revenueData?.data) {
                log(`ğŸ”„ è™•ç†ç‡Ÿæ”¶æˆé•·ç‡æ•¸æ“š...`);
                const sortedRevenue = revenueData.data.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // æœˆåº¦ç‡Ÿæ”¶æˆé•·ç‡ - è¨ˆç®—æœˆå¢ç‡ (æœ¬æœˆ vs ä¸Šæœˆ)
                if (sortedRevenue.length >= 2) {
                    log(`ğŸ“ˆ è¨ˆç®—æœˆåº¦ç‡Ÿæ”¶æˆé•·ç‡...`);
                    
                    for (let i = 0; i < sortedRevenue.length - 1; i++) {
                        const currentMonth = sortedRevenue[i];
                        const previousMonth = sortedRevenue[i + 1];
                        
                        const currentRevenue = parseFloat(currentMonth.revenue);
                        const previousRevenue = parseFloat(previousMonth.revenue);
                        
                        if (!isNaN(currentRevenue) && !isNaN(previousRevenue) && previousRevenue > 0) {
                            const date = new Date(currentMonth.date);
                            const year = date.getFullYear();
                            const month = date.getMonth() + 1;
                            
                            // æ°‘åœ‹å¹´è½‰æ›ï¼šè¥¿å…ƒå¹´è½‰æ°‘åœ‹å¹´
                            const rocYear = (year - 1911).toString();
                            const monthKey = `${rocYear}${month.toString().padStart(2, '0')}`;
                            
                            // è¨ˆç®—æœˆå¢ç‡: (æœ¬æœˆç‡Ÿæ”¶ - ä¸Šæœˆç‡Ÿæ”¶) / ä¸Šæœˆç‡Ÿæ”¶ * 100
                            const monthGrowth = ((currentRevenue - previousRevenue) / previousRevenue) * 100;
                            
                            financialCache.revenueGrowth.months[monthKey] = parseFloat(monthGrowth.toFixed(2));
                            log(`  âœ… æœˆç‡Ÿæ”¶æˆé•· ${monthKey}: ${monthGrowth.toFixed(2)}%`);
                            
                            // åªä¿ç•™æœ€è¿‘12å€‹æœˆ
                            if (Object.keys(financialCache.revenueGrowth.months).length >= 12) break;
                        }
                    }
                }

                // è¨ˆç®—å­£åº¦ç‡Ÿæ”¶æˆé•·ç‡
                const quarters = {};
                sortedRevenue.forEach(item => {
                    const date = new Date(item.date);
                    const year = date.getFullYear();
                    const quarter = Math.floor((date.getMonth() + 2) / 3);
                    const key = `${year}Q${quarter}`;
                    
                    if (!quarters[key]) quarters[key] = 0;
                    quarters[key] += parseFloat(item.revenue) || 0;
                });

                // è¨ˆç®—å­£åº¦æˆé•·ç‡ (èˆ‡å»å¹´åŒæœŸæ¯”è¼ƒ)
                const quarterKeys = Object.keys(quarters).sort().slice(-8);
                for (let i = 4; i < quarterKeys.length; i++) {
                    const current = quarters[quarterKeys[i]];
                    const previous = quarters[quarterKeys[i - 4]];
                    
                    if (previous > 0) {
                        const growth = ((current - previous) / previous) * 100;
                        const quarterLabel = quarterKeys[i].slice(-2);
                        financialCache.revenueGrowth.quarters[quarterLabel] = parseFloat(growth.toFixed(2));
                        log(`  âœ… å­£ç‡Ÿæ”¶æˆé•· ${quarterLabel}: ${growth.toFixed(2)}%`);
                    }
                }

                // å¹´åº¦ç‡Ÿæ”¶æˆé•·ç‡
                if (sortedRevenue.length >= 24) {
                    const currentYearTotal = sortedRevenue.slice(0, 12).reduce((sum, item) => sum + (parseFloat(item.revenue) || 0), 0);
                    const lastYearTotal = sortedRevenue.slice(12, 24).reduce((sum, item) => sum + (parseFloat(item.revenue) || 0), 0);
                    
                    if (lastYearTotal > 0) {
                        const growth = ((currentYearTotal - lastYearTotal) / lastYearTotal) * 100;
                        financialCache.revenueGrowth.year = parseFloat(growth.toFixed(2));
                        log(`  âœ… å¹´ç‡Ÿæ”¶æˆé•·: ${growth.toFixed(2)}%`);
                    }
                }
            }

            // æœ€çµ‚æ•¸æ“šçµ±è¨ˆ
            log(`ğŸ“Š FinMind æ•¸æ“šè§£æå®Œæˆ:`);
            log(`- EPS å­£åº¦: ${Object.keys(financialCache.eps.quarters).join(', ')}`);
            log(`- EPS å¹´åº¦: ${financialCache.eps.year}`);
            log(`- ROE å­£åº¦: ${Object.keys(financialCache.roe.quarters).join(', ')}`);
            log(`- ROE å¹´åº¦: ${financialCache.roe.year}`);
            log(`- ç‡Ÿæ”¶æˆé•·æœˆåº¦: ${Object.keys(financialCache.revenueGrowth.months).length} ç­†`);
            log(`- ç‡Ÿæ”¶æˆé•·å­£åº¦: ${Object.keys(financialCache.revenueGrowth.quarters).join(', ')}`);
            log(`- ç‡Ÿæ”¶æˆé•·å¹´åº¦: ${financialCache.revenueGrowth.year}`);
            log(`- æ¯›åˆ©ç‡å­£åº¦: ${Object.keys(financialCache.profitMargin.quarters).join(', ')}`);
            log(`- æ¯›åˆ©ç‡å¹´åº¦: ${financialCache.profitMargin.year}`);

            return financialCache;

        } catch (err) {
            log(`âŒ FinMind è²¡å‹™æ•¸æ“šç²å–å¤±æ•—: ${err.message}`);
            console.error(err);
            return null;
        }
    }

    async function fetchTWSEFinancials(stockId) {
        log(`è­‰äº¤æ‰€è²¡å ± è«‹æ±‚ä¸­... (${stockId})`);
        
        try {
            const response = await fetch(`/.netlify/functions/fetch-twse?type=financials&stock_id=${stockId}`);
            
            if (!response.ok) {
                log(`è­‰äº¤æ‰€ä»£ç†è«‹æ±‚å¤±æ•—: ${response.status}`);
                return null;
            }
            
            const structuredData = await response.json();
            
            if (structuredData.error) {
                log(`è­‰äº¤æ‰€æ•¸æ“šéŒ¯èª¤: ${structuredData.error}`);
                return null;
            }
            
            financialCache = structuredData;
            
            log(`âœ… TWSE çµæ§‹åŒ–æ•¸æ“šè¼‰å…¥æˆåŠŸ`);
            return financialCache;
            
        } catch (err) {
            log(`è­‰äº¤æ‰€æ•¸æ“šè™•ç†å¤±æ•—: ${err.message}`);
            return null;
        }
    }

    async function fetchYahooFinanceFinancials(stockId) {
        try {
            const response = await fetch(`/.netlify/functions/fetch-financials?id=${stockId}`);
            if (!response.ok) return null;
            const result = await response.json(); 
            if (result && !result.error) {
                financialCache.eps.year = result.defaultKeyStatistics?.trailingEps?.raw || 'N/A';
                financialCache.roe.year = result.financialData?.returnOnEquity?.raw ? result.financialData.returnOnEquity.raw * 100 : 'N/A';
                if (financialCache.revenueGrowth.year === 'N/A') {
                    financialCache.revenueGrowth.year = result.financialData?.revenueGrowth?.raw ? (result.financialData.revenueGrowth.raw * 100).toFixed(2) : 'N/A';
                }
                financialCache.profitMargin.quarters['Q1'] = result.financialData?.grossMargins?.raw ? result.financialData.grossMargins.raw * 100 : 'N/A';
                return financialCache;
            }
            return null;
        } catch (err) { return null; }
    }

    // ================= è³‡æ–™è¼‰å…¥é‚è¼¯ =================

    async function loadStockData() {
        let isLoaded = false;
        if (TOKEN) {
            try {
                const finInfo = await fetchFinmind('TaiwanStockInfo');
                if (finInfo?.data && finInfo.data.length > 0) {
                    stockData = finInfo.data;
                    isLoaded = true;
                    log(`FinMind æˆåŠŸè¼‰å…¥ ${stockData.length} ç­†è‚¡ç¥¨è³‡æ–™`);
                }
            } catch (err) { console.error(err); }
        }

        if (!isLoaded) {
            log('åˆ‡æ›è‡³ TWSE è­‰äº¤æ‰€ä¾†æºç²å–è‚¡ç¥¨æ¸…å–®...');
            try {
                const response = await fetch('/.netlify/functions/fetch-twse?type=stocks');
                if (response.ok) {
                    const twseData = await response.json();
                    stockData = twseData.map(item => {
                        let category = item['ç”¢æ¥­åˆ¥'] || 'å…¶ä»–';
                        if (twseIndustryMap[category]) category = twseIndustryMap[category];
                        return {
                            stock_id: item['å…¬å¸ä»£è™Ÿ'] || item.Code,
                            stock_name: item['å…¬å¸åç¨±'] || item['å…¬å¸ç°¡ç¨±'] || item.Name,
                            industry_category: category
                        };
                    }).filter(s => s.stock_id && s.stock_name);
                    
                    const uniqueStocks = new Map();
                    stockData.forEach(s => uniqueStocks.set(s.stock_id, s));
                    stockData = Array.from(uniqueStocks.values());

                    if (stockData.length > 0) {
                        isLoaded = true;
                        log(`TWSE å‚™æ´æˆåŠŸè¼‰å…¥ ${stockData.length} ç­†è‚¡ç¥¨è³‡æ–™`);
                    }
                }
            } catch (err) { log(`TWSE å‚™æ´è¼‰å…¥å¤±æ•—: ${err.message}`); }
        }

        if (isLoaded) {
            industryCategories = new Set(stockData.map(stock => stock.industry_category).filter(Boolean));
            updateCategorySelect();
        } else {
            log('âŒ ç„¡æ³•è¼‰å…¥è‚¡ç¥¨æ¸…å–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
        }
    }

    function updateCategorySelect() {
        const categorySelect = document.getElementById('stockCategory');
        categorySelect.innerHTML = '<option value="all">å…¨éƒ¨é¡è‚¡</option>';
        industryCategories.forEach(category => {
            if (category) {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            }
        });
        updateStockSelect();
    }

    function updateStockSelect() {
        const category = document.getElementById('stockCategory').value;
        const stockSelect = document.getElementById('stockSelect');
        stockSelect.innerHTML = '';
        let filteredStocks = stockData;
        if (category !== 'all') filteredStocks = stockData.filter(stock => stock.industry_category === category);
        filteredStocks.sort((a, b) => a.stock_id.localeCompare(b.stock_id));
        filteredStocks.forEach(stock => {
            const option = document.createElement('option');
            option.value = stock.stock_id;
            option.textContent = `${stock.stock_id} ${stock.stock_name}`;
            stockSelect.appendChild(option);
        });
        if (filteredStocks.length === 0) stockSelect.appendChild(new Option('è©²é¡è‚¡ç„¡è‚¡ç¥¨è³‡æ–™', ''));
    }

    // ================= æ‰‹å‹•è‚¡ç¥¨ä»£ç¢¼æœå°‹ =================
    
    document.getElementById('searchStock').onclick = async () => {
        const manualCode = document.getElementById('manualStockCode').value.trim();
        if (!manualCode) {
            alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
            return;
        }

        log(`æ‰‹å‹•æœå°‹è‚¡ç¥¨ä»£ç¢¼: ${manualCode}`);
        
        // å¦‚æœå·²ç¶“æœ‰è‚¡ç¥¨æ•¸æ“šï¼Œç›´æ¥æœå°‹
        if (stockData.length > 0) {
            const foundStock = stockData.find(stock => 
                stock.stock_id === manualCode || 
                stock.stock_name.includes(manualCode)
            );
            
            if (foundStock) {
                // è¨­ç½®é¡è‚¡é¸æ“‡
                document.getElementById('stockCategory').value = foundStock.industry_category;
                updateStockSelect();
                
                // è¨­ç½®è‚¡ç¥¨é¸æ“‡
                document.getElementById('stockSelect').value = foundStock.stock_id;
                
                log(`æ‰¾åˆ°è‚¡ç¥¨: ${foundStock.stock_id} ${foundStock.stock_name}`);
                alert(`æ‰¾åˆ°è‚¡ç¥¨: ${foundStock.stock_id} ${foundStock.stock_name}`);
            } else {
                log(`æœªæ‰¾åˆ°è‚¡ç¥¨ä»£ç¢¼: ${manualCode}`);
                alert(`æœªæ‰¾åˆ°è‚¡ç¥¨ä»£ç¢¼: ${manualCode}`);
            }
        } else {
            log('è‚¡ç¥¨æ•¸æ“šå°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦');
            alert('è‚¡ç¥¨æ•¸æ“šå°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦');
        }
    };

    document.getElementById('stockCategory').addEventListener('change', updateStockSelect);

    document.getElementById('saveToken').onclick = async () => {
        TOKEN = document.getElementById('tokenInput').value.trim();
        if (TOKEN) {
            document.getElementById('tokenStatus').innerHTML = '<span style="color:#ffc107">æ­£åœ¨é€éä»£ç†é©—è­‰ Token...</span>';
            try {
                const testUrl = `/.netlify/functions/fetch-finmind?dataset=TaiwanStockInfo&token=${TOKEN}`;
                const response = await fetch(testUrl);
                const data = await response.json();
                if (data.status === 200 && data.data) {
                    try { localStorage.setItem('joseph_pai_token_2025', TOKEN); } catch(e) {}
                    document.getElementById('tokenStatus').innerHTML = '<span style="color:#28a745">âœ“ Token é©—è­‰æˆåŠŸï¼</span>';
                    loadStockData();
                    alert('Token é©—è­‰æˆåŠŸï¼');
                } else {
                    document.getElementById('tokenStatus').innerHTML = `<span style="color:#dc3545">âœ— é©—è­‰å¤±æ•—</span>`;
                    alert(`Token é©—è­‰å¤±æ•—ï¼\n${data.msg || 'è«‹æª¢æŸ¥ Token æ˜¯å¦æ­£ç¢º'}`);
                }
            } catch (err) {
                document.getElementById('tokenStatus').innerHTML = `<span style="color:#dc3545">âœ— é©—è­‰å¤±æ•—</span>`;
                console.error(err);
            }
        } else {
            try { localStorage.setItem('joseph_pai_token_2025', ''); } catch(e) {}
            document.getElementById('tokenStatus').innerHTML = '<span style="color:#ffc107">Token å·²æ¸…ç©º</span>';
            alert('Token å·²æ¸…ç©º');
        }
    };

    // ================= UI æ›´æ–°èˆ‡è©•åˆ†è¨ˆç®— =================

    function updateFinancialUI() {
        const getVal = (sel, key) => {
            const el = document.querySelector(`.period-select[data-type="${sel}"]`);
            if (!el) {
                console.warn(`æ‰¾ä¸åˆ°æœŸé–“é¸å–®: ${sel}`);
                return 'N/A';
            }
            
            const period = el.value;
            
            if (period === 'å¹´' || period === 'å¹´(ç´¯è¨ˆ)') {
                const val = financialCache[key]?.year;
                return (val === null || val === undefined || val === 'N/A') ? 'N/A' : val;
                
            } else if (period === 'å­£') {
                const quarters = financialCache[key]?.quarters || {};
                const quarterKeys = Object.keys(quarters).sort().reverse();
                
                if (quarterKeys.length === 0) return 'N/A';
                
                // EPS ç‰¹æ®Šè™•ç†ï¼šå–å‰ä¸€å­£æ•¸æ“šï¼ˆå› ç‚ºæœ¬å­£å¯èƒ½é‚„æœªçµæŸï¼‰
                let targetQuarter;
                if (sel === 'eps') {
                    // å–ç¬¬äºŒæ–°çš„å­£åº¦ï¼ˆå‰ä¸€å­£ï¼‰
                    targetQuarter = quarterKeys.length > 1 ? quarterKeys[1] : quarterKeys[0];
                    log(`EPS å­£åº¦ç‰¹æ®Šè™•ç†: ä½¿ç”¨ ${targetQuarter} è€Œé ${quarterKeys[0]}`);
                } else {
                    // å…¶ä»–æŒ‡æ¨™ä½¿ç”¨æœ€æ–°å­£åº¦
                    targetQuarter = quarterKeys[0];
                }
                
                const val = quarters[targetQuarter];
                log(`${sel} å­£åº¦æ•¸æ“š: ä½¿ç”¨ ${targetQuarter} = ${val}`);
                return (val === null || val === undefined) ? 'N/A' : val;
                
            } else if (period === 'æœˆ') {
                const months = financialCache[key]?.months || {};
                const monthKeys = Object.keys(months).sort().reverse();
                
                if (monthKeys.length === 0) return 'N/A';
                
                const latestMonth = monthKeys[0];
                const val = months[latestMonth];
                log(`${sel} æœˆåº¦æ•¸æ“š: ä½¿ç”¨ ${latestMonth} = ${val}`);
                return (val === null || val === undefined) ? 'N/A' : val;
            }
            
            return 'N/A';
        };

        const setUI = (id, val, suffix) => {
            const displayEl = document.getElementById(id);
            const inputEl = document.getElementById(id.replace('display', 'manual'));
            
            let displayVal;
            if (val === 'N/A') {
                displayVal = 'N/A';
            } else {
                const numVal = parseFloat(val);
                displayVal = isNaN(numVal) ? 'N/A' : `${numVal.toFixed(2)}${suffix}`;
            }
            
            if (displayEl) {
                displayEl.textContent = displayVal;
            }
            
            if (inputEl) {
                inputEl.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                inputEl.placeholder = ''; // çµ±ä¸€çš„placeholder
            }
        };

        const eps = getVal('eps', 'eps');
        setUI('displayEps', eps, ' å…ƒ');

        const roe = getVal('roe', 'roe');
        setUI('displayRoe', roe, '%');

        const rev = getVal('revenue', 'revenueGrowth');
        setUI('displayRevenue', rev, '%');

        const margin = getVal('margin', 'profitMargin');
        setUI('displayMargin', margin, '%');

        calculateBasicScoreFromManualInput();
    }
    
    function setupPeriodChangeListeners() {
        document.querySelectorAll('.period-select').forEach(select => {
            select.addEventListener('change', () => {
                log(`æœŸé–“åˆ‡æ›: ${select.dataset.type} â†’ ${select.value}`);
                updateFinancialUI();
            });
        });
    }
    
    function setupManualInputListeners() {
        document.querySelectorAll('.manual-input').forEach(input => {
            input.addEventListener('input', () => {
                log(`æ‰‹å‹•è¼¸å…¥: ${input.id} = ${input.value}`);
                calculateBasicScoreFromManualInput();
            });
        });
    }

    window.calculateBasicScoreFromManualInput = function() {
        const getNum = (id, sel, key) => {
            const manualInput = document.getElementById(id);
            if (manualInput && manualInput.value !== '') {
                const manualVal = parseFloat(manualInput.value);
                if (!isNaN(manualVal)) {
                    log(`${id}: ä½¿ç”¨æ‰‹å‹•è¼¸å…¥å€¼ ${manualVal}`);
                    return manualVal;
                }
            }

            const el = document.querySelector(`.period-select[data-type="${sel}"]`);
            if (!el) return NaN;
            
            const period = el.value;
            let val;
            
            if (period === 'å¹´' || period === 'å¹´(ç´¯è¨ˆ)') {
                val = financialCache[key]?.year;
            } else if (period === 'å­£') {
                const quarters = financialCache[key]?.quarters || {};
                const quarterKeys = Object.keys(quarters).sort().reverse();
                
                // EPS ç‰¹æ®Šè™•ç†ï¼šå–å‰ä¸€å­£æ•¸æ“š
                let targetQuarter;
                if (sel === 'eps') {
                    targetQuarter = quarterKeys.length > 1 ? quarterKeys[1] : quarterKeys[0];
                } else {
                    targetQuarter = quarterKeys[0];
                }
                
                val = quarterKeys.length > 0 ? quarters[targetQuarter] : null;
            } else if (period === 'æœˆ') {
                const months = financialCache[key]?.months || {};
                const monthKeys = Object.keys(months).sort().reverse();
                val = monthKeys.length > 0 ? months[monthKeys[0]] : null;
            }
            
            if (val === null || val === undefined || val === 'N/A') return NaN;
            
            const numVal = parseFloat(val);
            log(`${id}: ä½¿ç”¨å¿«å–å€¼ ${numVal} (æœŸé–“: ${period})`);
            return numVal;
        };

        const epsInput = getNum('manualEps', 'eps', 'eps');
        const roeInput = getNum('manualRoe', 'roe', 'roe');
        const revenueGrowthInput = getNum('manualRevenueGrowth', 'revenue', 'revenueGrowth');
        const profitMarginInput = getNum('manualProfitMargin', 'margin', 'profitMargin');
        
        let basicScore = 0;
        let reasons = [];
        
        if (!isNaN(epsInput)) {
            if (epsInput >= 8) { 
                basicScore += 30; 
                reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 8 (+30)`); 
            } else if (epsInput >= 5) { 
                basicScore += 25; 
                reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 5 (+25)`); 
            } else if (epsInput >= 3) { 
                basicScore += 18; 
                reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 3 (+18)`); 
            } else if (epsInput >= 0) { 
                basicScore += 5; 
                reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 0 (+5)`); 
            } else { 
                basicScore -= 15; 
                reasons.push(`EPS ${epsInput.toFixed(2)} < 0 (-15)`); 
            }
        } else { 
            reasons.push('EPS ç„¡æ•¸æ“š'); 
        }

        if (!isNaN(roeInput)) {
            if (roeInput >= 15) { 
                basicScore += 30; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¥ 15% (+30)`); 
            } else if (roeInput >= 10) { 
                basicScore += 20; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¥ 10% (+20)`); 
            } else if (roeInput >= 5) { 
                basicScore += 10; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¥ 5% (+10)`); 
            } else if (roeInput > 0) { 
                basicScore += 5; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% > 0% (+5)`); 
            } else { 
                basicScore -= 10; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¤ 0% (-10)`); 
            }
        } else { 
            reasons.push('ROE ç„¡æ•¸æ“š'); 
        }

        if (!isNaN(revenueGrowthInput)) {
            if (revenueGrowthInput >= 30) { 
                basicScore += 30; 
                reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% â‰¥ 30% (+30)`); 
            } else if (revenueGrowthInput >= 10) { 
                basicScore += 20; 
                reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% â‰¥ 10% (+20)`); 
            } else if (revenueGrowthInput > 0) { 
                basicScore += 10; 
                reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% > 0% (+10)`); 
            } else { 
                basicScore -= 10; 
                reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% â‰¤ 0% (-10)`); 
            }
        } else { 
            reasons.push('ç‡Ÿæ”¶å¢ç‡ ç„¡æ•¸æ“š'); 
        }

        if (!isNaN(profitMarginInput)) {
            if (profitMarginInput >= 50) { 
                basicScore += 10; 
                reasons.push(`æ¯›åˆ© ${profitMarginInput.toFixed(2)}% â‰¥ 50% (+10)`); 
            } else if (profitMarginInput >= 20) { 
                basicScore += 5; 
                reasons.push(`æ¯›åˆ© ${profitMarginInput.toFixed(2)}% â‰¥ 20% (+5)`); 
            } else { 
                reasons.push(`æ¯›åˆ© ${profitMarginInput.toFixed(2)}% < 20% (0)`); 
            }
        } else { 
            reasons.push('æ¯›åˆ© ç„¡æ•¸æ“š'); 
        }
        
        const weight = weights.basic || 35;
        const finalBasicScore = Math.max(-weight, Math.min(weight, Math.round(basicScore / 100 * weight)));
        
        const basicScoreEl = document.getElementById('score_basic');
        if (basicScoreEl) {
            basicScoreEl.textContent = `${finalBasicScore >= 0 ? '+' : ''}${finalBasicScore}`;
            basicScoreEl.className = `badge ${finalBasicScore >= 0 ? 'badge-pos' : 'badge-neg'} fs-5`;
        }
        
        const descEl = document.querySelector('#scoreTable tbody tr:nth-child(1) td:nth-child(4)');
        if (descEl) {
            descEl.innerHTML = `<small>${reasons.join('<br>')}</small>`;
        }
        
        log(`åŸºæœ¬é¢è©•åˆ†: ${finalBasicScore} (åŸå§‹: ${basicScore}, æ¬Šé‡: ${weight}%)`);
        
        updateTotalScore();
    };

    window.adjustWeights = function(changedField, newValue) {
        const oldValue = weights[changedField];
        const diff = newValue - oldValue;
        if (diff === 0) return;
        weights[changedField] = newValue;
        const otherFields = Object.keys(weights).filter(key => key !== changedField);
        const otherTotal = otherFields.reduce((sum, key) => sum + weights[key], 0);
        
        if (otherTotal === 0) {
            const avg = (100 - newValue) / otherFields.length;
            otherFields.forEach(key => weights[key] = avg);
        } else {
            const scale = (100 - newValue) / otherTotal;
            otherFields.forEach(key => weights[key] = Math.max(0, Math.round(weights[key] * scale * 10) / 10));
        }
        
        const total = Object.values(weights).reduce((sum, val) => sum + val, 0);
        if (total !== 100) {
            const diff = 100 - total;
            const maxField = Object.keys(weights).reduce((a, b) => weights[a] > weights[b] ? a : b);
            weights[maxField] += diff;
        }
        
        updateWeightInputs();
        calculateBasicScoreFromManualInput(); 
        updateTotalScore();
    };

    function updateWeightInputs() {
        Object.keys(weights).forEach(key => {
            const input = document.querySelector(`.weight-input[data-field="${key}"]`);
            if (input) input.value = Math.round(weights[key]);
        });
    }

    function updateTotalScore() {
        const sum = Object.values(weights).reduce((a,b) => a + +b, 0);
        const hintEl = document.getElementById('weightHint');
        if (hintEl) hintEl.textContent = Math.round(sum) === 100 ? '' : `(ç›®å‰ç¸½æ¬Šé‡ ${Math.round(sum)}%)`;

        const getScore = (id) => {
            const el = document.getElementById(id);
            return el ? parseFloat(el.innerText.replace('+','')) : 0;
        }

        const s = {
            basic: getScore('score_basic'),
            technical: getScore('score_technical'),
            market: getScore('score_market'),
            news: getScore('score_news'),
            risk: getScore('score_risk')
        };

        const total = s.basic + s.technical + s.market + s.news + s.risk;
        const final = Math.max(-30, Math.min(30, Math.round(total * 0.3))); 
        
        const color = final >= 0 ? 'text-success' : 'text-danger';
        const finalEl = document.getElementById('finalScore');
        if (finalEl) finalEl.innerHTML = `<h1 class="score-big ${color}">${final >= 0 ? '+' : ''}${final}%</h1>`;
    }

    // ================= ä¸»åˆ†æè¡¨å–®æäº¤ =================
    
    document.getElementById('analyzeForm').onsubmit = async e => {
        e.preventDefault();
        const symbol = document.getElementById('stockSelect').value.trim();
        if (!symbol) { alert('è«‹é¸æ“‡è‚¡ç¥¨'); return; }
        
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        log(`=== åˆ†æé–‹å§‹ï¼š${symbol} ===`);
        document.getElementById('loading').style.display = 'block';
        document.getElementById('result').style.display = 'none';
        document.getElementById('logContent').textContent = '';

        try {
            let name = symbol;
            let industry = 'æœªçŸ¥';
            if (stockData.length > 0) {
                const stock = stockData.find(s => s.stock_id === symbol);
                if (stock) { name = stock.stock_name; industry = stock.industry_category; }
            }

            let priceDataFinal = await fetchYahooWithProxy(`${symbol}.TW`, 'è‚¡åƒ¹');
            if (!priceDataFinal && !TOKEN) { 
                const twsePrice = await fetchTWSEPrice(symbol);
                if (twsePrice) {
                     priceDataFinal = { chart: { result: [{ timestamp: twsePrice.map(d => { const p=d.Date.split('/'); return new Date(`${+p[0]+1911}-${p[1]}-${p[2]}`).getTime()/1000; }), indicators: { quote: [{ close: twsePrice.map(d => parseFloat(d.Close.replace(/,/g, ''))) }] } }] } };
                }
            }
            if (!priceDataFinal) throw new Error('ç„¡æ³•å–å¾—è‚¡åƒ¹è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦');

            // ä½¿ç”¨æ–°çš„è²¡å‹™æ•¸æ“šç²å–å‡½æ•¸
            const financialResult = await fetchFinancialData(symbol);
            const finSource = financialResult?.source || 'ç„¡';
            
            let newsRaw = null;
            if (TOKEN) newsRaw = await fetchFinmind('TaiwanStockNews', symbol, startDate);

            let marketData = await fetchYahooWithProxy('%5ETWII', 'å¤§ç›¤');

            const allTimestamps = priceDataFinal.chart.result[0].timestamp;
            const allCloses = priceDataFinal.chart.result[0].indicators.quote[0].close;
            const startTs = new Date(startDate).getTime() / 1000;
            const endTs = new Date(endDate).getTime() / 1000;
            
            const filteredData = allTimestamps.map((ts, i) => ({ ts, close: allCloses[i] })).filter(d => d.ts >= startTs && d.ts <= endTs && d.close);
            const closes = filteredData.map(d => d.close);
            const timestamps = filteredData.map(d => d.ts);
            
            if (closes.length === 0) throw new Error('æŒ‡å®šæ—¥æœŸç¯„åœå…§ç„¡è‚¡åƒ¹è³‡æ–™');

            const price = closes.at(-1).toFixed(2);
            const risePercent = closes.length >= 2 ? ((closes.at(-1) - closes[0]) / closes[0] * 100).toFixed(2) : 0;
            
            const techW = weights.technical || 25;
            let techScore = 0;
            let techReason = 'å€é–“éœ‡ç›ª';
            if (risePercent >= 30) { 
                techScore = techW; 
                techReason = `å€é–“æ¼²å¹… ${risePercent}% (â‰¥30% ç²æ»¿åˆ†)`; 
            } else if (risePercent >= 15) { 
                techScore = Math.round(techW * 0.8); 
                techReason = `å€é–“æ¼²å¹… ${risePercent}% (â‰¥15% ç²80%åˆ†)`; 
            } else if (risePercent >= 5) { 
                techScore = Math.round(techW * 0.4); 
                techReason = `å€é–“æ¼²å¹… ${risePercent}% (â‰¥5% ç²40%åˆ†)`; 
            } else if (risePercent < -10) { 
                techScore = -Math.round(techW * 0.8); 
                techReason = `å€é–“è·Œå¹… ${risePercent}% (<-10% æ‰£åˆ†)`; 
            } else {
                techScore = 0; 
                techReason = `å€é–“æ¼²è·Œ ${risePercent}% (ç›¤æ•´ä¸è¨ˆåˆ†)`; 
            }

            const marketW = weights.market || 20;
            let marketScore = 0; 
            let marketReason = 'ç„¡è³‡æ–™';
            if (marketData) {
                const mCloses = marketData.chart.result[0].indicators.quote[0].close.filter(Boolean);
                const mStart = mCloses[mCloses.length - closes.length] || mCloses[0];
                const mEnd = mCloses[mCloses.length - 1];
                const mRise = ((mEnd - mStart) / mStart * 100).toFixed(2);
                const beat = (parseFloat(risePercent) - parseFloat(mRise)).toFixed(1);
                
                if (beat >= 20) { 
                    marketScore = marketW; 
                    marketReason = `å¼·æ–¼å¤§ç›¤ ${beat}% (â‰¥20% ç²æ»¿åˆ†)`; 
                } else if (beat >= 0) { 
                    marketScore = Math.round(marketW * 0.4); 
                    marketReason = `å¼·æ–¼å¤§ç›¤ ${beat}% (â‰¥0% ç²40%åˆ†)`; 
                } else { 
                    marketScore = -Math.round(marketW * 0.6); 
                    marketReason = `å¼±æ–¼å¤§ç›¤ ${beat}% (è½å¾Œæ‰£åˆ†)`; 
                }
            }

            const newsW = weights.news || 10;
            let newsScore = 0;
            let newsReason = 'ç„¡æ–°è';
            if (newsRaw?.data?.length > 0) {
                let sentiment = 0;
                newsRaw.data.slice(0,30).forEach(n => {
                    if (n.title.match(/ç²åˆ©|æˆé•·|æ–°é«˜|è¨‚å–®|å¤§æ¼²/)) sentiment++;
                    if (n.title.match(/è™§æ|è¡°é€€|è£å“¡|åˆ©ç©º|å¤§è·Œ/)) sentiment--;
                });
                if (sentiment >= 5) { 
                    newsScore = newsW; 
                    newsReason = `æƒ…ç·’æŒ‡æ•¸ ${sentiment} (â‰¥5 ç²æ»¿åˆ†)`; 
                } else if (sentiment > 0) { 
                    newsScore = Math.round(newsW * 0.5); 
                    newsReason = `æƒ…ç·’æŒ‡æ•¸ ${sentiment} (>0 ç²50%åˆ†)`; 
                } else { 
                    newsScore = -Math.round(newsW * 0.5); 
                    newsReason = `æƒ…ç·’æŒ‡æ•¸ ${sentiment} (â‰¤0 åç©ºæ‰£åˆ†)`; 
                }
            }
            
            const riskW = weights.risk || 10;
            let riskScore = 0;
            let riskReason = 'ç„¡é‡å¤§é¢¨éšª'; 

            const currentEPS = parseFloat(financialCache.eps.year); 
            const currentROE = parseFloat(financialCache.roe.year);
            
            if (!isNaN(currentEPS) && !isNaN(currentROE)) {
                if (currentEPS < 0 && currentROE < 0) {
                    riskScore = -riskW;
                    riskReason = `EPS(${currentEPS})èˆ‡ROE(${currentROE})é›™è™§æ (é‡æ‰£)`;
                } else if (currentEPS < 0) {
                    riskScore = -Math.round(riskW * 0.5);
                    riskReason = `EPS(${currentEPS}) ç‚ºè² å€¼ (æ‰£åˆ†)`;
                } else {
                    riskScore = 0;
                    riskReason = `EPS(${currentEPS})èˆ‡ROE(${currentROE})çš†ç‚ºæ­£ (ç„¡é¢¨éšª)`;
                }
            } else {
                 riskReason = "ç„¡å®Œæ•´è²¡å ±æ•¸æ“š (ä¸è¨ˆåˆ†)";
            }
            
            document.getElementById('result').innerHTML = `
                <div class="text-center mb-5">
                    <h2>${symbol} ${name} <small class="text-info">(${industry})</small></h2>
                    <div id="finalScore"><h1 class="score-big">--</h1></div>
                    <p class="lead">æ•´é«”å¸‚å ´è¶¨å‹¢è©•åˆ† <span id="weightHint" style="color:yellow"></span></p>
                    <p class="fs-5">ç¾åƒ¹ ${price} ï½œ æœŸé–“æ¼²è·Œ ${risePercent}%</p>
                    <p class="data-source">è³‡æ–™ä¾†æº: FinMind TWSEå°ç£è­‰å·äº¤æ˜“æ‰€</p>
                </div>

                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="card text-dark">
                            <div class="card-header bg-primary text-white"><strong>æœ€æ–°è²¡å ±æ•¸æ“š</strong></div>
                            <div class="financial-period"><small class="text-muted">è«‹ä½¿ç”¨ä¸‹æ–¹é¸å–®åˆ‡æ›åˆ†æç¶­åº¦</small></div>
                            <table class="table table-striped mb-0">
                                <thead><tr><th>é …ç›®</th><th>æœŸé–“</th><th>æ•¸å€¼</th><th class="manual-label">è¼¸å…¥</th></tr></thead>
                                <tbody>
                                    <tr>
                                        <td>EPS</td>
                                        <td><select class="form-select period-select" data-type="eps"><option value="å­£">å­£</option><option value="å¹´">å¹´</option></select></td>
                                        <td class="fw-bold fs-5" id="displayEps">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualEps" class="form-control manual-input" step="0.01"></td>
                                    </tr>
                                    <tr>
                                        <td>ROE</td>
                                        <td><select class="form-select period-select" data-type="roe"><option value="å­£">å­£</option><option value="å¹´">å¹´</option></select></td>
                                        <td class="fs-5" id="displayRoe">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualRoe" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                    <tr>
                                        <td>ç‡Ÿæ”¶å¢ç‡</td>
                                        <td><select class="form-select period-select" data-type="revenue"><option value="æœˆ">æœˆ</option><option value="å­£">å­£</option><option value="å¹´">å¹´(ç´¯è¨ˆ)</option></select></td>
                                        <td class="fs-5" id="displayRevenue">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualRevenueGrowth" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                    <tr>
                                        <td>æ¯›åˆ©ç‡</td>
                                        <td><select class="form-select period-select" data-type="margin"><option value="å­£">å­£</option></select></td>
                                        <td class="fs-5" id="displayMargin">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualProfitMargin" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- æ–°å¢æœ€æ–°è²¡å ±æ•¸æ“šèªªæ˜ -->
                            <div class="explanation mt-3">
                                <h6>ğŸ“ˆ è²¡å ±æ•¸æ“šèªªæ˜</h6>
                                <ul class="mb-0 small ps-3">
                                    <li><strong>EPS (æ¯è‚¡ç›ˆé¤˜):</strong> å…¬å¸æ¯è‚¡è‚¡ç¥¨è³ºå¤šå°‘éŒ¢ï¼Œå­£æ•¸æ“šä½¿ç”¨å‰ä¸€å­£ç¢ºä¿æº–ç¢ºæ€§</li>
                                    <li><strong>ROE (è‚¡æ±æ¬Šç›Šå ±é…¬ç‡):</strong> å…¬å¸é‹ç”¨è‚¡æ±è³‡é‡‘è³ºéŒ¢çš„æ•ˆç‡</li>
                                    <li><strong>ç‡Ÿæ”¶å¢ç‡:</strong> æœˆå¢ç‡ç‚ºæœ¬æœˆèˆ‡ä¸Šæœˆæ¯”è¼ƒï¼Œå­£/å¹´å¢ç‡ç‚ºèˆ‡å»å¹´åŒæœŸæ¯”è¼ƒ</li>
                                    <li><strong>æ¯›åˆ©ç‡:</strong> ç”¢å“æˆ–æœå‹™çš„ç²åˆ©èƒ½åŠ›ï¼Œåƒ…æä¾›å­£åº¦æ•¸æ“š</li>
                                    <li>å¯æ‰‹å‹•è¼¸å…¥æ•¸å€¼é€²è¡Œå³æ™‚è©•åˆ†èª¿æ•´</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-7">
                        <div class="card text-dark">
                            <div class="card-header bg-danger text-white table-header-red"><strong>å°ˆæ¥­è©•åˆ†</strong></div>
                            <table class="table table-striped mb-0" id="scoreTable">
                                <thead><tr><th>é …ç›®</th><th>æ¬Šé‡%</th><th>å¾—åˆ†</th><th>èªªæ˜</th></tr></thead>
                                <tbody>
                                    <tr><td>åŸºæœ¬é¢</td><td><input type="number" data-field="basic" class="form-control weight-input" value="${weights.basic}" onchange="adjustWeights('basic',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_basic">0</span></td><td>è²¡å ±</td></tr>
                                    <tr><td>æŠ€è¡“é¢</td><td><input type="number" data-field="technical" class="form-control weight-input" value="${weights.technical}" onchange="adjustWeights('technical',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_technical">${techScore}</span></td><td>${techReason}</td></tr>
                                    <tr><td>å¸‚å ´é¢</td><td><input type="number" data-field="market" class="form-control weight-input" value="${weights.market}" onchange="adjustWeights('market',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_market">${marketScore}</span></td><td>${marketReason}</td></tr>
                                    <tr><td>æ¶ˆæ¯é¢</td><td><input type="number" data-field="news" class="form-control weight-input" value="${weights.news}" onchange="adjustWeights('news',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_news">${newsScore}</span></td><td>${newsReason}</td></tr>
                                    <tr><td>é¢¨éšªé¢</td><td><input type="number" data-field="risk" class="form-control weight-input" value="${weights.risk}" onchange="adjustWeights('risk',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_risk">${riskScore}</span></td><td>${riskReason}</td></tr>
                                </tbody>
                            </table>
                            
                            <!-- ç§»å‹•å°ˆæ¥­è©•åˆ†é …ç›®èªªæ˜åˆ°é€™è£¡ -->
                            <div class="explanation mt-3">
                                <h6>ğŸ“Š å°ˆæ¥­è©•åˆ†é …ç›®èªªæ˜</h6>
                                <ul class="mb-0 small ps-3">
                                    <li><strong>1. åŸºæœ¬é¢ (35%):</strong> ä¾æ“šè²¡å ±æ•¸å€¼è©•åˆ† (EPS>8, ROE>15%, ç‡Ÿæ”¶æˆé•·>30% ç‚ºæ»¿åˆ†)ã€‚</li>
                                    <li><strong>2. æŠ€è¡“é¢ (25%):</strong> ä¾æ“šå€é–“è‚¡åƒ¹æ¼²è·Œå¹…åˆ¤æ–·å‹•èƒ½ (æ¼²å¹…>30%æ»¿åˆ†)ã€‚</li>
                                    <li><strong>3. å¸‚å ´é¢ (20%):</strong> èˆ‡å¤§ç›¤æŒ‡æ•¸åŒæœŸæ¼²è·Œå¹…æ¯”è¼ƒï¼Œå‹éå¤§ç›¤å³å¾—åˆ†ã€‚</li>
                                    <li><strong>4. æ¶ˆæ¯é¢ (10%):</strong> åˆ†æè¿‘æœŸæ–°èé—œéµå­— (ç‡Ÿæ”¶æ–°é«˜/æˆé•· vs è¡°é€€/è£å“¡)ã€‚</li>
                                    <li><strong>5. é¢¨éšªé¢ (10%):</strong> é‡å°è²¡å‹™èµ¤å­— (è² EPS/ROE) é€²è¡Œé¢¨éšªæ‰£åˆ†ã€‚</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-body"><canvas id="priceChart"></canvas></div>
                </div>
            `;

            setupPeriodChangeListeners();
            setupManualInputListeners();
            updateFinancialUI();

            new Chart(document.getElementById('priceChart'), {
                type: 'line',
                data: {
                    labels: timestamps.map(t => new Date(t*1000).toLocaleDateString('zh-TW',{month:'numeric',day:'numeric'})),
                    datasets: [
                        { label: name, data: closes, borderColor: '#00ff88', tension: 0.3, fill: false, pointRadius: 0 },
                        { label: 'å¤§ç›¤', data: marketData?.chart?.result[0].indicators.quote[0].close.slice(-closes.length) || [], borderColor: '#ff4444', tension: 0.3, fill: false, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, interaction: { mode: 'index', intersect: false }, plugins: { legend: { labels: { color: 'black' } } }, scales: { x: { ticks: { color: 'black' } }, y: { ticks: { color: 'black' } } } }
            });

            document.getElementById('result').style.display = 'block';

        } catch (err) {
            log(`éŒ¯èª¤: ${err.message}`);
            document.getElementById('result').innerHTML = `<div class="alert alert-danger text-center py-5"><h3>${err.message}</h3></div>`;
            document.getElementById('result').style.display = 'block';
        }
        document.getElementById('loading').style.display = 'none';
    };

    loadStockData();
});
</script>
</body>
</html>
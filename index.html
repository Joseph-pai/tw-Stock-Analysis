<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>台灣股市終極專業分析器 - Joseph PAI 2025 (Final v21)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; font-family: 'Microsoft JhengHei',sans-serif; }
        .container { max-width: 1350px; }
        .card { background: rgba(255,255,255,0.12); backdrop-filter: blur(12px); border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .score-big { font-size: 6.5rem; font-weight: 900; text-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        .badge-pos { background: #28a745; }
        .badge-neg { background: #dc3545; }
        .weight-input { width: 80px; text-align: center; font-weight: bold; background:#fff; color:#333; }
        .summary { background: rgba(0,0,0,0.4); padding: 30px; border-radius: 15px; margin: 30px 0; }
        footer { margin-top: 80px; padding: 30px; text-align: center; color: rgba(255,255,255,0.8); }
        .debug-log { max-height: 500px; overflow-y: auto; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; padding: 15px; border-radius: 8px; }
        .token-status { font-weight: bold; }
        .data-source { font-size: 0.8rem; color: #ffc107; margin-top: 10px; }
        .date-range-input { width: 120px; }
        .manual-input { width: 100%; text-align: center; font-size: 1rem; }
        .explanation { background: white; color: black; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .explanation h6 { color: #8B0000; margin-bottom: 5px; font-weight: bold; }
        .manual-input-cell { padding: 5px !important; width: 100px; }
        .manual-label { font-size: 1rem; color: #ffc107; font-weight: bold; }
        .table-header-red { background-color: #8B0000; color: white; }
        .period-select { width: 110px; font-size: 0.9rem; cursor: pointer; }
        .financial-period { background-color: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .basis-box { background: rgba(0,0,0,0.3); border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px; }
        td, th { vertical-align: middle; }
        .stock-search { max-width: 300px; }
    </style>
</head>
<body>
<div class="container py-5">

    <h1 class="text-center mb-2">台灣股市終極專業分析器</h1>
    <p class="text-center text-white-50 mb-5">Joseph PAI 2025 11/26 專業評分詳解版 • Netlify Functions + TWSE API</p>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text">FinMind Token（選填）</span>
                <input type="text" id="tokenInput" class="form-control bg-white text-dark" placeholder="貼上 Token 或留空使用公開資料">
                <button class="btn btn-warning fw-bold" id="saveToken">儲存</button>
            </div>
            <small class="text-white-50">免費註冊 → <a href="https://finmindtrade.com/analysis/#/account/register" target="_blank" class="text-warning">FinMind（30秒）</a> ｜ 或直接使用證交所+觀測站公開資料</small>
            <div id="tokenStatus" class="token-status mt-2"></div>
        </div>
    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="row g-2 mb-3">
                <div class="col-md-4">
                    <label class="form-label text-white-50">手動輸入股票代碼</label>
                    <div class="input-group stock-search">
                        <input type="text" id="manualStockCode" class="form-control" placeholder="例如: 2330">
                        <button class="btn btn-info text-white fw-bold" id="searchStock">搜尋</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white-50">選擇類股</label>
                    <select id="stockCategory" class="form-select">
                        <option value="all">全部類股</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white-50">選擇股票</label>
                    <select id="stockSelect" class="form-select" required>
                        <option value="">請先選擇類股</option>
                    </select>
                </div>
            </div>
            
            <form id="analyzeForm">
                <div class="row g-2">
                    <div class="col-auto">
                        <label class="text-white-50 small">分析時間範圍：</label>
                    </div>
                    <div class="col-auto">
                        <select id="dateRange" class="form-select form-select-sm date-range-input">
                            <option value="30">最近30天</option>
                            <option value="60" selected>最近60天</option>
                            <option value="90">最近90天</option>
                            <option value="180">最近半年</option>
                            <option value="365">最近一年</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small">或自訂：</span>
                    </div>
                    <div class="col-auto">
                        <input type="date" id="startDate" class="form-control form-control-sm date-range-input" placeholder="開始日期">
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small">到</span>
                    </div>
                    <div class="col-auto">
                        <input type="date" id="endDate" class="form-control form-control-sm date-range-input" placeholder="結束日期">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-warning text-dark fw-bold" type="submit">立即專業分析</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="text-center mb-4">
        <button class="btn btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#debugLog">
            顯示/隱藏 除錯日誌
        </button>
    </div>

    <div class="collapse" id="debugLog">
        <div class="card mb-4">
            <div class="card-body p-3">
                <pre id="logContent" class="debug-log"></pre>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('logContent').textContent = '';">清除日誌</button>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center my-5" style="display:none;">
        <div class="spinner-border text-warning" style="width:6rem;height:6rem;"></div>
        <h3 class="mt-4">正在抓取最新資料 (多維度分析中)…</h3>
    </div>

    <div id="result" style="display:none;"></div>

</div>

<footer>© 2025 Joseph PAI. All Rights Reserved. | 資料來源：台灣證券交易所 + FinMind + Yahoo Finance</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ================= 初始化與全域變數 =================
    let TOKEN = '';
    try { TOKEN = localStorage.getItem('joseph_pai_token_2025') || ''; } catch(e) {}

    // 財務數據緩存 - 結構化格式
    let financialCache = {
        eps: { quarters: {}, year: null },
        roe: { quarters: {}, year: null },
        revenueGrowth: { months: {}, quarters: {}, year: null },
        profitMargin: { quarters: {}, year: null }
    };

    const twseIndustryMap = {
        "01": "水泥工業", "02": "食品工業", "03": "塑膠工業", "04": "紡織纖維", "05": "電機機械",
        "06": "電器電纜", "07": "化學生技醫療", "08": "玻璃陶瓷", "09": "造紙工業", "10": "鋼鐵工業",
        "11": "橡膠工業", "12": "汽車工業", "13": "電子工業", "14": "建材營造", "15": "航運業",
        "16": "觀光事業", "17": "金融保險", "18": "貿易百貨", "19": "綜合", "20": "其他",
        "21": "化學工業", "22": "生技醫療業", "23": "油電燃氣業", "24": "半導體業", "25": "電腦及週邊設備業",
        "26": "光電業", "27": "通信網路業", "28": "電子零組件業", "29": "電子通路業", "30": "資訊服務業",
        "31": "其他電子業", "32": "文化創意業", "33": "農業科技業", "34": "電子商務業",
        "35": "綠能環保", "36": "數位雲端", "37": "運動休閒", "38": "居家生活", "91": "存託憑證"
    };

    // UI 初始化
    document.getElementById('tokenInput').value = TOKEN;
    document.getElementById('tokenStatus').innerHTML = TOKEN ? '<span style="color:#28a745">Token 已從記錄中載入 (下次免輸入)</span>' : '<span style="color:#ffc107">未設定 Token，將使用公開資料</span>';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('endDate').value = today;
    
    const dateRangeEl = document.getElementById('dateRange');
    dateRangeEl.onchange = function() {
        const days = parseInt(this.value);
        const end = new Date();
        const start = new Date(end.getTime() - days * 24 * 60 * 60 * 1000);
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
    };
    dateRangeEl.dispatchEvent(new Event('change'));

    let stockData = [];
    let industryCategories = new Set();
    window.weights = { basic:35, technical:25, market:20, news:10, risk:10 };

    window.log = function(msg) {
        const logEl = document.getElementById('logContent');
        if (logEl) {
            logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        console.log(msg);
    }

    // ================= 核心 API 函數 =================

    async function fetchFinmind(dataset, dataId = '', startDate = '', endDate = '', retries = 3) {
        if (!TOKEN && dataset !== 'TaiwanStockInfo') return null;
        let url = `/.netlify/functions/fetch-finmind?dataset=${dataset}`;
        if (dataId) url += `&data_id=${dataId}`;
        if (startDate) url += `&start_date=${startDate}`;
        if (endDate) url += `&end_date=${endDate}`;
        if (TOKEN) url += `&token=${TOKEN}`;
        
        for (let attempt = 1; attempt <= retries; attempt++) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    if (attempt < retries) { await new Promise(r => setTimeout(r, 1000 * attempt)); continue; }
                    return null;
                }
                const data = await response.json();
                if (data.status === 200 && data.data) return data;
            } catch (err) { if (attempt < retries) await new Promise(r => setTimeout(r, 1000 * attempt)); }
        }
        return null;
    }

    async function fetchYahooWithProxy(symbol, logName) {
        log(`${logName} 請求中 (透過 Netlify Price Function 代理)...`);
        try {
            const response = await fetch(`/.netlify/functions/fetch-price?id=${symbol}`);
            if (!response.ok) {
                log(`${logName} 代理失敗: ${response.status}`);
                return null;
            }
            const data = await response.json(); 
            if (data && data.chart?.result?.[0]) {
                log(`${logName} 成功！`);
                return data;
            }
            log(`${logName} 失敗: 格式錯誤`);
            return null;
        } catch (err) {
            log(`${logName} 失敗: ${err.message}`);
            return null;
        }
    }

    async function fetchTWSEPrice(stockId) {
        try {
            const response = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY?stockNo=${stockId}`);
            if (!response.ok) return null;
            const data = await response.json();
            return (data && Array.isArray(data) && data.length > 0) ? data : null;
        } catch (err) { return null; }
    }

    // ================= 財務數據獲取 - 優先 FinMind =================
    
    async function fetchFinancialData(stockId) {
        log(`開始獲取財務數據: ${stockId}`);
        
        // 重置財務快取
        financialCache = {
            eps: { quarters: {}, year: null },
            roe: { quarters: {}, year: null },
            revenueGrowth: { months: {}, quarters: {}, year: null },
            profitMargin: { quarters: {}, year: null }
        };
        
        let source = 'Unknown';
        
        // 1. 優先從 FinMind 獲取數據
        if (TOKEN) {
            log('嘗試從 FinMind 獲取財務數據...');
            const finmindData = await fetchFinmindFinancials(stockId);
            if (finmindData) {
                source = 'FinMind';
                log('✅ FinMind 財務數據載入成功');
                return { source, data: finmindData };
            }
        }
        
        // 2. 備援：證交所財報
        log('FinMind 失敗，嘗試證交所財報...');
        const twseData = await fetchTWSEFinancials(stockId);
        if (twseData) {
            source = 'TWSE';
            log('✅ 證交所財務數據載入成功');
            return { source, data: twseData };
        }
        
        // 3. 最終備援：Yahoo Finance
        log('證交所失敗，嘗試 Yahoo Finance...');
        const yahooData = await fetchYahooFinanceFinancials(stockId);
        if (yahooData) {
            source = 'Yahoo Finance';
            log('✅ Yahoo Finance 財務數據載入成功');
            return { source, data: yahooData };
        }
        
        log('❌ 所有財務數據來源都失敗');
        return null;
    }

    async function fetchFinmindFinancials(stockId) {
        try {
            // 獲取多個財務數據集
            const [balanceSheet, incomeStatement, revenueData, perData] = await Promise.all([
                fetchFinmind('TaiwanStockBalanceSheet', stockId, '2020-01-01'),
                fetchFinmind('TaiwanStockIncomeStatement', stockId, '2020-01-01'),
                fetchFinmind('TaiwanStockMonthRevenue', stockId, '2020-01-01'),
                fetchFinmind('TaiwanStockPER', stockId, '2020-01-01')
            ]);

            if (!balanceSheet && !incomeStatement && !revenueData) return null;

            // 處理 EPS 數據
            if (perData?.data) {
                perData.data.forEach(item => {
                    const date = new Date(item.date);
                    const quarter = Math.floor((date.getMonth() + 3) / 3);
                    const eps = parseFloat(item.EPS);
                    
                    if (!isNaN(eps)) {
                        // 季度數據
                        financialCache.eps.quarters[`Q${quarter}`] = eps;
                        
                        // 年度數據（使用最新季度）
                        if (!financialCache.eps.year || date > new Date(financialCache.eps._latestDate || 0)) {
                            financialCache.eps.year = eps * 4; // 估算年度 EPS
                            financialCache.eps._latestDate = item.date;
                        }
                    }
                });
            }

            // 處理 ROE 數據
            if (incomeStatement?.data && balanceSheet?.data) {
                incomeStatement.data.forEach(income => {
                    const date = new Date(income.date);
                    const quarter = Math.floor((date.getMonth() + 3) / 3);
                    
                    const netIncome = parseFloat(income.net_income);
                    const balance = balanceSheet.data.find(b => b.date === income.date);
                    
                    if (balance && !isNaN(netIncome)) {
                        const equity = parseFloat(balance.equity);
                        if (equity > 0) {
                            const roe = (netIncome / equity) * 100;
                            
                            // 季度數據
                            financialCache.roe.quarters[`Q${quarter}`] = parseFloat(roe.toFixed(2));
                            
                            // 年度數據
                            if (!financialCache.roe.year || date > new Date(financialCache.roe._latestDate || 0)) {
                                financialCache.roe.year = parseFloat(roe.toFixed(2));
                                financialCache.roe._latestDate = income.date;
                            }
                        }
                    }
                });
            }

            // 處理營收成長率
            if (revenueData?.data) {
                const sortedRevenue = revenueData.data.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // 月度營收成長率
                sortedRevenue.slice(0, 12).forEach(item => {
                    const date = new Date(item.date);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    const rocYear = (year - 1911).toString();
                    const monthKey = `${rocYear}${month.toString().padStart(2, '0')}`;
                    
                    const revenue = parseFloat(item.revenue);
                    const lastYearRevenue = parseFloat(item.revenue_last_year);
                    
                    if (!isNaN(revenue) && !isNaN(lastYearRevenue) && lastYearRevenue > 0) {
                        const growth = ((revenue - lastYearRevenue) / lastYearRevenue) * 100;
                        financialCache.revenueGrowth.months[monthKey] = parseFloat(growth.toFixed(2));
                    }
                });

                // 季度營收成長率
                const quarters = {};
                sortedRevenue.forEach(item => {
                    const date = new Date(item.date);
                    const year = date.getFullYear();
                    const quarter = Math.floor((date.getMonth() + 3) / 3);
                    const key = `${year}Q${quarter}`;
                    
                    if (!quarters[key]) quarters[key] = 0;
                    quarters[key] += parseFloat(item.revenue) || 0;
                });

                // 計算季度成長率
                const quarterKeys = Object.keys(quarters).sort();
                for (let i = 1; i < quarterKeys.length; i++) {
                    const current = quarters[quarterKeys[i]];
                    const previous = quarters[quarterKeys[i - 1]];
                    
                    if (previous > 0) {
                        const growth = ((current - previous) / previous) * 100;
                        financialCache.revenueGrowth.quarters[quarterKeys[i].slice(-2)] = parseFloat(growth.toFixed(2));
                    }
                }

                // 年度營收成長率
                if (sortedRevenue.length >= 2) {
                    const currentYear = sortedRevenue[0].revenue * 12; // 估算年度
                    const lastYear = sortedRevenue[12]?.revenue * 12 || currentYear * 0.8; // 估算
                    
                    if (lastYear > 0) {
                        const growth = ((currentYear - lastYear) / lastYear) * 100;
                        financialCache.revenueGrowth.year = parseFloat(growth.toFixed(2));
                    }
                }
            }

            // 處理毛利率
            if (incomeStatement?.data) {
                incomeStatement.data.forEach(income => {
                    const date = new Date(income.date);
                    const quarter = Math.floor((date.getMonth() + 3) / 3);
                    
                    const revenue = parseFloat(income.operating_revenue);
                    const cost = parseFloat(income.operating_costs);
                    
                    if (!isNaN(revenue) && !isNaN(cost) && revenue > 0) {
                        const grossProfit = revenue - cost;
                        const margin = (grossProfit / revenue) * 100;
                        
                        // 季度數據
                        financialCache.profitMargin.quarters[`Q${quarter}`] = parseFloat(margin.toFixed(2));
                        
                        // 年度數據
                        if (!financialCache.profitMargin.year || date > new Date(financialCache.profitMargin._latestDate || 0)) {
                            financialCache.profitMargin.year = parseFloat(margin.toFixed(2));
                            financialCache.profitMargin._latestDate = income.date;
                        }
                    }
                });
            }

            return financialCache;

        } catch (err) {
            log(`FinMind 財務數據獲取失敗: ${err.message}`);
            return null;
        }
    }

    async function fetchTWSEFinancials(stockId) {
        log(`證交所財報 請求中... (${stockId})`);
        
        try {
            const response = await fetch(`/.netlify/functions/fetch-twse?type=financials&stock_id=${stockId}`);
            
            if (!response.ok) {
                log(`證交所代理請求失敗: ${response.status}`);
                return null;
            }
            
            const structuredData = await response.json();
            
            if (structuredData.error) {
                log(`證交所數據錯誤: ${structuredData.error}`);
                return null;
            }
            
            financialCache = structuredData;
            
            log(`✅ TWSE 結構化數據載入成功`);
            return financialCache;
            
        } catch (err) {
            log(`證交所數據處理失敗: ${err.message}`);
            return null;
        }
    }

    async function fetchYahooFinanceFinancials(stockId) {
        try {
            const response = await fetch(`/.netlify/functions/fetch-financials?id=${stockId}`);
            if (!response.ok) return null;
            const result = await response.json(); 
            if (result && !result.error) {
                financialCache.eps.year = result.defaultKeyStatistics?.trailingEps?.raw || 'N/A';
                financialCache.roe.year = result.financialData?.returnOnEquity?.raw ? result.financialData.returnOnEquity.raw * 100 : 'N/A';
                if (financialCache.revenueGrowth.year === 'N/A') {
                    financialCache.revenueGrowth.year = result.financialData?.revenueGrowth?.raw ? (result.financialData.revenueGrowth.raw * 100).toFixed(2) : 'N/A';
                }
                financialCache.profitMargin.quarters['Q1'] = result.financialData?.grossMargins?.raw ? result.financialData.grossMargins.raw * 100 : 'N/A';
                return financialCache;
            }
            return null;
        } catch (err) { return null; }
    }

    // ================= 資料載入邏輯 =================

    async function loadStockData() {
        let isLoaded = false;
        if (TOKEN) {
            try {
                const finInfo = await fetchFinmind('TaiwanStockInfo');
                if (finInfo?.data && finInfo.data.length > 0) {
                    stockData = finInfo.data;
                    isLoaded = true;
                    log(`FinMind 成功載入 ${stockData.length} 筆股票資料`);
                }
            } catch (err) { console.error(err); }
        }

        if (!isLoaded) {
            log('切換至 TWSE 證交所來源獲取股票清單...');
            try {
                const response = await fetch('/.netlify/functions/fetch-twse?type=stocks');
                if (response.ok) {
                    const twseData = await response.json();
                    stockData = twseData.map(item => {
                        let category = item['產業別'] || '其他';
                        if (twseIndustryMap[category]) category = twseIndustryMap[category];
                        return {
                            stock_id: item['公司代號'] || item.Code,
                            stock_name: item['公司名稱'] || item['公司簡稱'] || item.Name,
                            industry_category: category
                        };
                    }).filter(s => s.stock_id && s.stock_name);
                    
                    const uniqueStocks = new Map();
                    stockData.forEach(s => uniqueStocks.set(s.stock_id, s));
                    stockData = Array.from(uniqueStocks.values());

                    if (stockData.length > 0) {
                        isLoaded = true;
                        log(`TWSE 備援成功載入 ${stockData.length} 筆股票資料`);
                    }
                }
            } catch (err) { log(`TWSE 備援載入失敗: ${err.message}`); }
        }

        if (isLoaded) {
            industryCategories = new Set(stockData.map(stock => stock.industry_category).filter(Boolean));
            updateCategorySelect();
        } else {
            log('❌ 無法載入股票清單，請檢查網路連線');
        }
    }

    function updateCategorySelect() {
        const categorySelect = document.getElementById('stockCategory');
        categorySelect.innerHTML = '<option value="all">全部類股</option>';
        industryCategories.forEach(category => {
            if (category) {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            }
        });
        updateStockSelect();
    }

    function updateStockSelect() {
        const category = document.getElementById('stockCategory').value;
        const stockSelect = document.getElementById('stockSelect');
        stockSelect.innerHTML = '';
        let filteredStocks = stockData;
        if (category !== 'all') filteredStocks = stockData.filter(stock => stock.industry_category === category);
        filteredStocks.sort((a, b) => a.stock_id.localeCompare(b.stock_id));
        filteredStocks.forEach(stock => {
            const option = document.createElement('option');
            option.value = stock.stock_id;
            option.textContent = `${stock.stock_id} ${stock.stock_name}`;
            stockSelect.appendChild(option);
        });
        if (filteredStocks.length === 0) stockSelect.appendChild(new Option('該類股無股票資料', ''));
    }

    // ================= 手動股票代碼搜尋 =================
    
    document.getElementById('searchStock').onclick = async () => {
        const manualCode = document.getElementById('manualStockCode').value.trim();
        if (!manualCode) {
            alert('請輸入股票代碼');
            return;
        }

        log(`手動搜尋股票代碼: ${manualCode}`);
        
        // 如果已經有股票數據，直接搜尋
        if (stockData.length > 0) {
            const foundStock = stockData.find(stock => 
                stock.stock_id === manualCode || 
                stock.stock_name.includes(manualCode)
            );
            
            if (foundStock) {
                // 設置類股選擇
                document.getElementById('stockCategory').value = foundStock.industry_category;
                updateStockSelect();
                
                // 設置股票選擇
                document.getElementById('stockSelect').value = foundStock.stock_id;
                
                log(`找到股票: ${foundStock.stock_id} ${foundStock.stock_name}`);
                alert(`找到股票: ${foundStock.stock_id} ${foundStock.stock_name}`);
            } else {
                log(`未找到股票代碼: ${manualCode}`);
                alert(`未找到股票代碼: ${manualCode}`);
            }
        } else {
            log('股票數據尚未載入完成，請稍後再試');
            alert('股票數據尚未載入完成，請稍後再試');
        }
    };

    document.getElementById('stockCategory').addEventListener('change', updateStockSelect);

    document.getElementById('saveToken').onclick = async () => {
        TOKEN = document.getElementById('tokenInput').value.trim();
        if (TOKEN) {
            document.getElementById('tokenStatus').innerHTML = '<span style="color:#ffc107">正在透過代理驗證 Token...</span>';
            try {
                const testUrl = `/.netlify/functions/fetch-finmind?dataset=TaiwanStockInfo&token=${TOKEN}`;
                const response = await fetch(testUrl);
                const data = await response.json();
                if (data.status === 200 && data.data) {
                    try { localStorage.setItem('joseph_pai_token_2025', TOKEN); } catch(e) {}
                    document.getElementById('tokenStatus').innerHTML = '<span style="color:#28a745">✓ Token 驗證成功！</span>';
                    loadStockData();
                    alert('Token 驗證成功！');
                } else {
                    document.getElementById('tokenStatus').innerHTML = `<span style="color:#dc3545">✗ 驗證失敗</span>`;
                    alert(`Token 驗證失敗！\n${data.msg || '請檢查 Token 是否正確'}`);
                }
            } catch (err) {
                document.getElementById('tokenStatus').innerHTML = `<span style="color:#dc3545">✗ 驗證失敗</span>`;
                console.error(err);
            }
        } else {
            try { localStorage.setItem('joseph_pai_token_2025', ''); } catch(e) {}
            document.getElementById('tokenStatus').innerHTML = '<span style="color:#ffc107">Token 已清空</span>';
            alert('Token 已清空');
        }
    };

    // ================= UI 更新與評分計算 =================

    function updateFinancialUI() {
        const getVal = (sel, key) => {
            const el = document.querySelector(`.period-select[data-type="${sel}"]`);
            if (!el) {
                console.warn(`找不到期間選單: ${sel}`);
                return 'N/A';
            }
            
            const period = el.value;
            
            if (period === '年' || period === '年(累計)') {
                const val = financialCache[key]?.year;
                return (val === null || val === undefined || val === 'N/A') ? 'N/A' : val;
                
            } else if (period === '季') {
                const quarters = financialCache[key]?.quarters || {};
                const quarterKeys = Object.keys(quarters).sort().reverse();
                
                if (quarterKeys.length === 0) return 'N/A';
                
                const latestQuarter = quarterKeys[0];
                const val = quarters[latestQuarter];
                log(`${sel} 季度數據: 使用 ${latestQuarter} = ${val}`);
                return (val === null || val === undefined) ? 'N/A' : val;
                
            } else if (period === '月') {
                const months = financialCache[key]?.months || {};
                const monthKeys = Object.keys(months).sort().reverse();
                
                if (monthKeys.length === 0) return 'N/A';
                
                const latestMonth = monthKeys[0];
                const val = months[latestMonth];
                log(`${sel} 月度數據: 使用 ${latestMonth} = ${val}`);
                return (val === null || val === undefined) ? 'N/A' : val;
            }
            
            return 'N/A';
        };

        const setUI = (id, val, suffix) => {
            const displayEl = document.getElementById(id);
            const inputEl = document.getElementById(id.replace('display', 'manual'));
            
            let displayVal;
            if (val === 'N/A') {
                displayVal = 'N/A';
            } else {
                const numVal = parseFloat(val);
                displayVal = isNaN(numVal) ? 'N/A' : `${numVal.toFixed(2)}${suffix}`;
            }
            
            if (displayEl) {
                displayEl.textContent = displayVal;
            }
            
            if (inputEl && inputEl.value === '') {
                inputEl.placeholder = displayVal !== 'N/A' ? displayVal : '手動輸入';
            }
        };

        const eps = getVal('eps', 'eps');
        setUI('displayEps', eps, ' 元');

        const roe = getVal('roe', 'roe');
        setUI('displayRoe', roe, '%');

        const rev = getVal('revenue', 'revenueGrowth');
        setUI('displayRevenue', rev, '%');

        const margin = getVal('margin', 'profitMargin');
        setUI('displayMargin', margin, '%');

        calculateBasicScoreFromManualInput();
    }
    
    function setupPeriodChangeListeners() {
        document.querySelectorAll('.period-select').forEach(select => {
            select.addEventListener('change', () => {
                log(`期間切換: ${select.dataset.type} → ${select.value}`);
                updateFinancialUI();
            });
        });
    }
    
    function setupManualInputListeners() {
        document.querySelectorAll('.manual-input').forEach(input => {
            input.addEventListener('input', () => {
                log(`手動輸入: ${input.id} = ${input.value}`);
                calculateBasicScoreFromManualInput();
            });
        });
    }

    window.calculateBasicScoreFromManualInput = function() {
        const getNum = (id, sel, key) => {
            const manualInput = document.getElementById(id);
            if (manualInput && manualInput.value !== '') {
                const manualVal = parseFloat(manualInput.value);
                if (!isNaN(manualVal)) {
                    log(`${id}: 使用手動輸入值 ${manualVal}`);
                    return manualVal;
                }
            }

            const el = document.querySelector(`.period-select[data-type="${sel}"]`);
            if (!el) return NaN;
            
            const period = el.value;
            let val;
            
            if (period === '年' || period === '年(累計)') {
                val = financialCache[key]?.year;
            } else if (period === '季') {
                const quarters = financialCache[key]?.quarters || {};
                const quarterKeys = Object.keys(quarters).sort().reverse();
                val = quarterKeys.length > 0 ? quarters[quarterKeys[0]] : null;
            } else if (period === '月') {
                const months = financialCache[key]?.months || {};
                const monthKeys = Object.keys(months).sort().reverse();
                val = monthKeys.length > 0 ? months[monthKeys[0]] : null;
            }
            
            if (val === null || val === undefined || val === 'N/A') return NaN;
            
            const numVal = parseFloat(val);
            log(`${id}: 使用快取值 ${numVal} (期間: ${period})`);
            return numVal;
        };

        const epsInput = getNum('manualEps', 'eps', 'eps');
        const roeInput = getNum('manualRoe', 'roe', 'roe');
        const revenueGrowthInput = getNum('manualRevenueGrowth', 'revenue', 'revenueGrowth');
        const profitMarginInput = getNum('manualProfitMargin', 'margin', 'profitMargin');
        
        let basicScore = 0;
        let reasons = [];
        
        if (!isNaN(epsInput)) {
            if (epsInput >= 8) { 
                basicScore += 30; 
                reasons.push(`EPS ${epsInput.toFixed(2)} ≥ 8 (+30)`); 
            } else if (epsInput >= 5) { 
                basicScore += 25; 
                reasons.push(`EPS ${epsInput.toFixed(2)} ≥ 5 (+25)`); 
            } else if (epsInput >= 3) { 
                basicScore += 18; 
                reasons.push(`EPS ${epsInput.toFixed(2)} ≥ 3 (+18)`); 
            } else if (epsInput >= 0) { 
                basicScore += 5; 
                reasons.push(`EPS ${epsInput.toFixed(2)} ≥ 0 (+5)`); 
            } else { 
                basicScore -= 15; 
                reasons.push(`EPS ${epsInput.toFixed(2)} < 0 (-15)`); 
            }
        } else { 
            reasons.push('EPS 無數據'); 
        }

        if (!isNaN(roeInput)) {
            if (roeInput >= 15) { 
                basicScore += 30; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% ≥ 15% (+30)`); 
            } else if (roeInput >= 10) { 
                basicScore += 20; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% ≥ 10% (+20)`); 
            } else if (roeInput >= 5) { 
                basicScore += 10; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% ≥ 5% (+10)`); 
            } else if (roeInput > 0) { 
                basicScore += 5; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% > 0% (+5)`); 
            } else { 
                basicScore -= 10; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% ≤ 0% (-10)`); 
            }
        } else { 
            reasons.push('ROE 無數據'); 
        }

        if (!isNaN(revenueGrowthInput)) {
            if (revenueGrowthInput >= 30) { 
                basicScore += 30; 
                reasons.push(`營收增率 ${revenueGrowthInput.toFixed(2)}% ≥ 30% (+30)`); 
            } else if (revenueGrowthInput >= 10) { 
                basicScore += 20; 
                reasons.push(`營收增率 ${revenueGrowthInput.toFixed(2)}% ≥ 10% (+20)`); 
            } else if (revenueGrowthInput > 0) { 
                basicScore += 10; 
                reasons.push(`營收增率 ${revenueGrowthInput.toFixed(2)}% > 0% (+10)`); 
            } else { 
                basicScore -= 10; 
                reasons.push(`營收增率 ${revenueGrowthInput.toFixed(2)}% ≤ 0% (-10)`); 
            }
        } else { 
            reasons.push('營收增率 無數據'); 
        }

        if (!isNaN(profitMarginInput)) {
            if (profitMarginInput >= 50) { 
                basicScore += 10; 
                reasons.push(`毛利 ${profitMarginInput.toFixed(2)}% ≥ 50% (+10)`); 
            } else if (profitMarginInput >= 20) { 
                basicScore += 5; 
                reasons.push(`毛利 ${profitMarginInput.toFixed(2)}% ≥ 20% (+5)`); 
            } else { 
                reasons.push(`毛利 ${profitMarginInput.toFixed(2)}% < 20% (0)`); 
            }
        } else { 
            reasons.push('毛利 無數據'); 
        }
        
        const weight = weights.basic || 35;
        const finalBasicScore = Math.max(-weight, Math.min(weight, Math.round(basicScore / 100 * weight)));
        
        const basicScoreEl = document.getElementById('score_basic');
        if (basicScoreEl) {
            basicScoreEl.textContent = `${finalBasicScore >= 0 ? '+' : ''}${finalBasicScore}`;
            basicScoreEl.className = `badge ${finalBasicScore >= 0 ? 'badge-pos' : 'badge-neg'} fs-5`;
        }
        
        const descEl = document.querySelector('#scoreTable tbody tr:nth-child(1) td:nth-child(4)');
        if (descEl) {
            descEl.innerHTML = `<small>${reasons.join('<br>')}</small>`;
        }
        
        log(`基本面評分: ${finalBasicScore} (原始: ${basicScore}, 權重: ${weight}%)`);
        
        updateTotalScore();
    };

    window.adjustWeights = function(changedField, newValue) {
        const oldValue = weights[changedField];
        const diff = newValue - oldValue;
        if (diff === 0) return;
        weights[changedField] = newValue;
        const otherFields = Object.keys(weights).filter(key => key !== changedField);
        const otherTotal = otherFields.reduce((sum, key) => sum + weights[key], 0);
        
        if (otherTotal === 0) {
            const avg = (100 - newValue) / otherFields.length;
            otherFields.forEach(key => weights[key] = avg);
        } else {
            const scale = (100 - newValue) / otherTotal;
            otherFields.forEach(key => weights[key] = Math.max(0, Math.round(weights[key] * scale * 10) / 10));
        }
        
        const total = Object.values(weights).reduce((sum, val) => sum + val, 0);
        if (total !== 100) {
            const diff = 100 - total;
            const maxField = Object.keys(weights).reduce((a, b) => weights[a] > weights[b] ? a : b);
            weights[maxField] += diff;
        }
        
        updateWeightInputs();
        calculateBasicScoreFromManualInput(); 
        updateTotalScore();
    };

    function updateWeightInputs() {
        Object.keys(weights).forEach(key => {
            const input = document.querySelector(`.weight-input[data-field="${key}"]`);
            if (input) input.value = Math.round(weights[key]);
        });
    }

    function updateTotalScore() {
        const sum = Object.values(weights).reduce((a,b) => a + +b, 0);
        const hintEl = document.getElementById('weightHint');
        if (hintEl) hintEl.textContent = Math.round(sum) === 100 ? '' : `(目前總權重 ${Math.round(sum)}%)`;

        const getScore = (id) => {
            const el = document.getElementById(id);
            return el ? parseFloat(el.innerText.replace('+','')) : 0;
        }

        const s = {
            basic: getScore('score_basic'),
            technical: getScore('score_technical'),
            market: getScore('score_market'),
            news: getScore('score_news'),
            risk: getScore('score_risk')
        };

        const total = s.basic + s.technical + s.market + s.news + s.risk;
        const final = Math.max(-30, Math.min(30, Math.round(total * 0.3))); 
        
        const color = final >= 0 ? 'text-success' : 'text-danger';
        const finalEl = document.getElementById('finalScore');
        if (finalEl) finalEl.innerHTML = `<h1 class="score-big ${color}">${final >= 0 ? '+' : ''}${final}%</h1>`;
    }

    // ================= 主分析表單提交 =================
    
    document.getElementById('analyzeForm').onsubmit = async e => {
        e.preventDefault();
        const symbol = document.getElementById('stockSelect').value.trim();
        if (!symbol) { alert('請選擇股票'); return; }
        
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        log(`=== 分析開始：${symbol} ===`);
        document.getElementById('loading').style.display = 'block';
        document.getElementById('result').style.display = 'none';
        document.getElementById('logContent').textContent = '';

        try {
            let name = symbol;
            let industry = '未知';
            if (stockData.length > 0) {
                const stock = stockData.find(s => s.stock_id === symbol);
                if (stock) { name = stock.stock_name; industry = stock.industry_category; }
            }

            let priceDataFinal = await fetchYahooWithProxy(`${symbol}.TW`, '股價');
            if (!priceDataFinal && !TOKEN) { 
                const twsePrice = await fetchTWSEPrice(symbol);
                if (twsePrice) {
                     priceDataFinal = { chart: { result: [{ timestamp: twsePrice.map(d => { const p=d.Date.split('/'); return new Date(`${+p[0]+1911}-${p[1]}-${p[2]}`).getTime()/1000; }), indicators: { quote: [{ close: twsePrice.map(d => parseFloat(d.Close.replace(/,/g, ''))) }] } }] } };
                }
            }
            if (!priceDataFinal) throw new Error('無法取得股價資料，請稍後再試');

            // 使用新的財務數據獲取函數
            const financialResult = await fetchFinancialData(symbol);
            const finSource = financialResult?.source || '無';
            
            let newsRaw = null;
            if (TOKEN) newsRaw = await fetchFinmind('TaiwanStockNews', symbol, startDate);

            let marketData = await fetchYahooWithProxy('%5ETWII', '大盤');

            const allTimestamps = priceDataFinal.chart.result[0].timestamp;
            const allCloses = priceDataFinal.chart.result[0].indicators.quote[0].close;
            const startTs = new Date(startDate).getTime() / 1000;
            const endTs = new Date(endDate).getTime() / 1000;
            
            const filteredData = allTimestamps.map((ts, i) => ({ ts, close: allCloses[i] })).filter(d => d.ts >= startTs && d.ts <= endTs && d.close);
            const closes = filteredData.map(d => d.close);
            const timestamps = filteredData.map(d => d.ts);
            
            if (closes.length === 0) throw new Error('指定日期範圍內無股價資料');

            const price = closes.at(-1).toFixed(2);
            const risePercent = closes.length >= 2 ? ((closes.at(-1) - closes[0]) / closes[0] * 100).toFixed(2) : 0;
            
            const techW = weights.technical || 25;
            let techScore = 0;
            let techReason = '區間震盪';
            if (risePercent >= 30) { 
                techScore = techW; 
                techReason = `區間漲幅 ${risePercent}% (≥30% 獲滿分)`; 
            } else if (risePercent >= 15) { 
                techScore = Math.round(techW * 0.8); 
                techReason = `區間漲幅 ${risePercent}% (≥15% 獲80%分)`; 
            } else if (risePercent >= 5) { 
                techScore = Math.round(techW * 0.4); 
                techReason = `區間漲幅 ${risePercent}% (≥5% 獲40%分)`; 
            } else if (risePercent < -10) { 
                techScore = -Math.round(techW * 0.8); 
                techReason = `區間跌幅 ${risePercent}% (<-10% 扣分)`; 
            } else {
                techScore = 0; 
                techReason = `區間漲跌 ${risePercent}% (盤整不計分)`; 
            }

            const marketW = weights.market || 20;
            let marketScore = 0; 
            let marketReason = '無資料';
            if (marketData) {
                const mCloses = marketData.chart.result[0].indicators.quote[0].close.filter(Boolean);
                const mStart = mCloses[mCloses.length - closes.length] || mCloses[0];
                const mEnd = mCloses[mCloses.length - 1];
                const mRise = ((mEnd - mStart) / mStart * 100).toFixed(2);
                const beat = (parseFloat(risePercent) - parseFloat(mRise)).toFixed(1);
                
                if (beat >= 20) { 
                    marketScore = marketW; 
                    marketReason = `強於大盤 ${beat}% (≥20% 獲滿分)`; 
                } else if (beat >= 0) { 
                    marketScore = Math.round(marketW * 0.4); 
                    marketReason = `強於大盤 ${beat}% (≥0% 獲40%分)`; 
                } else { 
                    marketScore = -Math.round(marketW * 0.6); 
                    marketReason = `弱於大盤 ${beat}% (落後扣分)`; 
                }
            }

            const newsW = weights.news || 10;
            let newsScore = 0;
            let newsReason = '無新聞';
            if (newsRaw?.data?.length > 0) {
                let sentiment = 0;
                newsRaw.data.slice(0,30).forEach(n => {
                    if (n.title.match(/獲利|成長|新高|訂單|大漲/)) sentiment++;
                    if (n.title.match(/虧損|衰退|裁員|利空|大跌/)) sentiment--;
                });
                if (sentiment >= 5) { 
                    newsScore = newsW; 
                    newsReason = `情緒指數 ${sentiment} (≥5 獲滿分)`; 
                } else if (sentiment > 0) { 
                    newsScore = Math.round(newsW * 0.5); 
                    newsReason = `情緒指數 ${sentiment} (>0 獲50%分)`; 
                } else { 
                    newsScore = -Math.round(newsW * 0.5); 
                    newsReason = `情緒指數 ${sentiment} (≤0 偏空扣分)`; 
                }
            }
            
            const riskW = weights.risk || 10;
            let riskScore = 0;
            let riskReason = '無重大風險'; 

            const currentEPS = parseFloat(financialCache.eps.year); 
            const currentROE = parseFloat(financialCache.roe.year);
            
            if (!isNaN(currentEPS) && !isNaN(currentROE)) {
                if (currentEPS < 0 && currentROE < 0) {
                    riskScore = -riskW;
                    riskReason = `EPS(${currentEPS})與ROE(${currentROE})雙虧損 (重扣)`;
                } else if (currentEPS < 0) {
                    riskScore = -Math.round(riskW * 0.5);
                    riskReason = `EPS(${currentEPS}) 為負值 (扣分)`;
                } else {
                    riskScore = 0;
                    riskReason = `EPS(${currentEPS})與ROE(${currentROE})皆為正 (無風險)`;
                }
            } else {
                 riskReason = "無完整財報數據 (不計分)";
            }
            
            document.getElementById('result').innerHTML = `
                <div class="text-center mb-5">
                    <h2>${symbol} ${name} <small class="text-info">(${industry})</small></h2>
                    <div id="finalScore"><h1 class="score-big">--</h1></div>
                    <p class="lead">整體市場趨勢評分 <span id="weightHint" style="color:yellow"></span></p>
                    <p class="fs-5">現價 ${price} ｜ 期間漲跌 ${risePercent}%</p>
                    <p class="data-source">資料來源: 股價(Yahoo) 財報(${finSource})</p>
                </div>

                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="card text-dark">
                            <div class="card-header bg-primary text-white"><strong>最新財報數據</strong></div>
                            <div class="financial-period"><small class="text-muted">請使用下方選單切換分析維度</small></div>
                            <table class="table table-striped mb-0">
                                <thead><tr><th>項目</th><th>期間</th><th>數值</th><th class="manual-label">輸入</th></tr></thead>
                                <tbody>
                                    <tr>
                                        <td>EPS</td>
                                        <td><select class="form-select period-select" data-type="eps"><option value="季">季</option><option value="年">年</option></select></td>
                                        <td class="fw-bold fs-5" id="displayEps">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualEps" class="form-control manual-input" step="0.01"></td>
                                    </tr>
                                    <tr>
                                        <td>ROE</td>
                                        <td><select class="form-select period-select" data-type="roe"><option value="季">季</option><option value="年">年</option></select></td>
                                        <td class="fs-5" id="displayRoe">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualRoe" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                    <tr>
                                        <td>營收增率</td>
                                        <td><select class="form-select period-select" data-type="revenue"><option value="月">月</option><option value="季">季</option><option value="年">年(累計)</option></select></td>
                                        <td class="fs-5" id="displayRevenue">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualRevenueGrowth" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                    <tr>
                                        <td>毛利率</td>
                                        <td><select class="form-select period-select" data-type="margin"><option value="季">季</option><option value="年">年</option></select></td>
                                        <td class="fs-5" id="displayMargin">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualProfitMargin" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div class="explanation mt-3">
                                <h6>📊 專業評分項目說明</h6>
                                <ul class="mb-0 small ps-3">
                                    <li><strong>1. 基本面 (35%):</strong> 依據財報數值評分 (EPS>8, ROE>15%, 營收成長>30% 為滿分)。</li>
                                    <li><strong>2. 技術面 (25%):</strong> 依據區間股價漲跌幅判斷動能 (漲幅>30%滿分)。</li>
                                    <li><strong>3. 市場面 (20%):</strong> 與大盤指數同期漲跌幅比較，勝過大盤即得分。</li>
                                    <li><strong>4. 消息面 (10%):</strong> 分析近期新聞關鍵字 (營收新高/成長 vs 衰退/裁員)。</li>
                                    <li><strong>5. 風險面 (10%):</strong> 針對財務赤字 (負EPS/ROE) 進行風險扣分。</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-7">
                        <div class="card text-dark">
                            <div class="card-header bg-danger text-white table-header-red"><strong>專業評分</strong></div>
                            <table class="table table-striped mb-0" id="scoreTable">
                                <thead><tr><th>項目</th><th>權重%</th><th>得分</th><th>說明</th></tr></thead>
                                <tbody>
                                    <tr><td>基本面</td><td><input type="number" data-field="basic" class="form-control weight-input" value="${weights.basic}" onchange="adjustWeights('basic',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_basic">0</span></td><td>財報</td></tr>
                                    <tr><td>技術面</td><td><input type="number" data-field="technical" class="form-control weight-input" value="${weights.technical}" onchange="adjustWeights('technical',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_technical">${techScore}</span></td><td>${techReason}</td></tr>
                                    <tr><td>市場面</td><td><input type="number" data-field="market" class="form-control weight-input" value="${weights.market}" onchange="adjustWeights('market',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_market">${marketScore}</span></td><td>${marketReason}</td></tr>
                                    <tr><td>消息面</td><td><input type="number" data-field="news" class="form-control weight-input" value="${weights.news}" onchange="adjustWeights('news',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_news">${newsScore}</span></td><td>${newsReason}</td></tr>
                                    <tr><td>風險面</td><td><input type="number" data-field="risk" class="form-control weight-input" value="${weights.risk}" onchange="adjustWeights('risk',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_risk">${riskScore}</span></td><td>${riskReason}</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-body"><canvas id="priceChart"></canvas></div>
                </div>
            `;

            setupPeriodChangeListeners();
            setupManualInputListeners();
            updateFinancialUI();

            new Chart(document.getElementById('priceChart'), {
                type: 'line',
                data: {
                    labels: timestamps.map(t => new Date(t*1000).toLocaleDateString('zh-TW',{month:'numeric',day:'numeric'})),
                    datasets: [
                        { label: name, data: closes, borderColor: '#00ff88', tension: 0.3, fill: false, pointRadius: 0 },
                        { label: '大盤', data: marketData?.chart?.result[0].indicators.quote[0].close.slice(-closes.length) || [], borderColor: '#ff4444', tension: 0.3, fill: false, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, interaction: { mode: 'index', intersect: false }, plugins: { legend: { labels: { color: 'black' } } }, scales: { x: { ticks: { color: 'black' } }, y: { ticks: { color: 'black' } } } }
            });

            document.getElementById('result').style.display = 'block';

        } catch (err) {
            log(`錯誤: ${err.message}`);
            document.getElementById('result').innerHTML = `<div class="alert alert-danger text-center py-5"><h3>${err.message}</h3></div>`;
            document.getElementById('result').style.display = 'block';
        }
        document.getElementById('loading').style.display = 'none';
    };

    loadStockData();
});
</script>
</body>
</html>
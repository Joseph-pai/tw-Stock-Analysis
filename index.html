<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>台灣股市終極專業分析器 - Joseph PAI 2025 (Final Fix v19)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> 
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; font-family: 'Microsoft JhengHei',sans-serif; }
        .container { max-width: 1350px; }
        .card { background: rgba(255,255,255,0.12); backdrop-filter: blur(12px); border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .score-big { font-size: 6.5rem; font-weight: 900; text-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        .badge-pos { background: #28a745; }
        .badge-neg { background: #dc3545; }
        .weight-input { width: 80px; text-align: center; font-weight: bold; background:#fff; color:#333; }
        .summary { background: rgba(0,0,0,0.4); padding: 30px; border-radius: 15px; margin: 30px 0; }
        footer { margin-top: 80px; padding: 30px; text-align: center; color: rgba(255,255,255,0.8); }
        .debug-log { max-height: 500px; overflow-y: auto; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; padding: 15px; border-radius: 8px; }
        .token-status { font-weight: bold; }
        .data-source { font-size: 0.8rem; color: #ffc107; margin-top: 10px; }
        .date-range-input { width: 120px; }
        .manual-input { width: 100%; text-align: center; font-size: 1rem; }
        .explanation { background: white; color: black; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .explanation h6 { color: #8B0000; margin-bottom: 5px; font-weight: bold; }
        .manual-input-cell { padding: 5px !important; width: 100px; }
        .manual-label { font-size: 1rem; color: #ffc107; font-weight: bold; }
        .table-header-red { background-color: #8B0000; color: white; }
        .period-select { width: 110px; font-size: 0.9rem; cursor: pointer; }
        .financial-period { background-color: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .basis-box { background: rgba(0,0,0,0.3); border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px; }
        td, th { vertical-align: middle; }
    </style>
</head>
<body>
<div class="container py-5">

    <h1 class="text-center mb-2">台灣股市終極專業分析器</h1>
    <p class="text-center text-white-50 mb-5">Joseph PAI 2025 11/22 專業評分詳解版 • Netlify Functions</p>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text">FinMind Token（選填）</span>
                <input type="text" id="tokenInput" class="form-control bg-white text-dark" placeholder="貼上 Token 或留空使用公開資料">
                <button class="btn btn-warning fw-bold" id="saveToken">儲存</button>
            </div>
            <small class="text-white-50">免費註冊 → <a href="https://finmindtrade.com/analysis/#/account/register" target="_blank" class="text-warning">FinMind（30秒）</a> ｜ 或直接使用證交所+觀測站公開資料</small>
            <div id="tokenStatus" class="token-status mt-2"></div>
        </div>
    </div>
    
    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="card p-3 bg-transparent border-warning">
                <h5 class="text-warning">最新財報數據期間選擇與刷新</h5>
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label for="stockCodeFinancial" class="form-label text-white-50">股票代碼</label>
                        <input type="text" class="form-control" id="stockCodeFinancial" value="2330" placeholder="例如: 2330">
                    </div>
                    <div class="col-md-3">
                        <label for="yearSelectFinancial" class="form-label text-white-50">年度</label>
                        <select class="form-select" id="yearSelectFinancial">
                            </select>
                    </div>
                    <div class="col-md-3">
                        <label for="quarterSelectFinancial" class="form-label text-white-50">季度</label>
                        <select class="form-select" id="quarterSelectFinancial">
                            <option value="Q1">Q1</option>
                            <option value="Q2">Q2</option>
                            <option value="Q3">Q3</option>
                            <option value="Q4">Q4</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning text-dark fw-bold w-100" type="button" id="refreshFinancialsButton" style="height: 38px;">
                            <i class="fas fa-sync-alt"></i> 刷新財報數據
                        </button>
                    </div>
                </div>
                <small class="text-white-50 mt-2">此選擇用於獲取並計算最新的 ROE, EPS, **季營收增率** 等數據。</small>
            </div>
        </div>
    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <form id="analyzeForm">
                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-white-50">選擇類股</label>
                        <select id="stockCategory" class="form-select">
                            <option value="all">全部類股</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white-50">選擇股票</label>
                        <select id="stockSelect" class="form-select" required>
                            <option value="">請先選擇類股</option>
                        </select>
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-auto">
                        <label class="text-white-50 small">分析時間範圍：</label>
                    </div>
                    <div class="col-auto">
                        <select id="dateRange" class="form-select form-select-sm date-range-input">
                            <option value="30">最近30天</option>
                            <option value="60" selected>最近60天</option>
                            <option value="90">最近90天</option>
                            <option value="180">最近半年</option>
                            <option value="365">最近一年</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small">或自訂：</span>
                    </div>
                    <div class="col-auto">
                        <input type="date" id="startDate" class="form-control form-control-sm date-range-input" placeholder="開始日期">
                    </div>
                    <div class="col-auto">
                        <span class="text-white-50 small">到</span>
                    </div>
                    <div class="col-auto">
                        <input type="date" id="endDate" class="form-control form-control-sm date-range-input" placeholder="結束日期">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-warning text-dark fw-bold" type="submit">立即專業分析</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="text-center mb-4">
        <button class="btn btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#debugLog">
            顯示/隱藏 除錯日誌
        </button>
    </div>

    <div class="collapse" id="debugLog">
        <div class="card mb-4">
            <div class="card-body p-3">
                <pre id="logContent" class="debug-log"></pre>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('logContent').textContent = '';">清除日誌</button>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center my-5" style="display:none;">
        <div class="spinner-border text-warning" style="width:6rem;height:6rem;"></div>
        <h3 class="mt-4">正在抓取最新資料 (多維度分析中)…</h3>
    </div>

    <div id="result" style="display:none;"></div>

</div> <footer>© 2025 Joseph PAI. All Rights Reserved. | 資料來源：台灣證券交易所 + FinMind + Yahoo Finance</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ================= 初始化與全域變數 =================
    let TOKEN = '';
    try { TOKEN = localStorage.getItem('joseph_pai_token_2025') || ''; } catch(e) {}

    // 財務數據緩存
    let financialCache = {
        eps: { quarter: 'N/A', year: 'N/A' },
        roe: { quarter: 'N/A', year: 'N/A' },
        revenueGrowth: { month: 'N/A', quarter: 'N/A', year: 'N/A' },
        profitMargin: { quarter: 'N/A', year: 'N/A' }
    };

    const twseIndustryMap = {
        "01": "水泥工業", "02": "食品工業", "03": "塑膠工業", "04": "紡織纖維", "05": "電機機械",
        "06": "電器電纜", "07": "化學生技醫療", "08": "玻璃陶瓷", "09": "造紙工業", "10": "鋼鐵工業",
        "11": "橡膠工業", "12": "汽車工業", "13": "電子工業", "14": "建材營造", "15": "航運業",
        "16": "觀光事業", "17": "金融保險", "18": "貿易百貨", "19": "綜合", "20": "其他",
        "21": "化學工業", "22": "生技醫療業", "23": "油電燃氣業", "24": "半導體業", "25": "電腦及週邊設備業",
        "26": "光電業", "27": "通信網路業", "28": "電子零組件業", "29": "電子通路業", "30": "資訊服務業",
        "31": "其他電子業", "32": "文化創意業", "33": "農業科技業", "34": "電子商務業",
        "35": "綠能環保", "36": "數位雲端", "37": "運動休閒", "38": "居家生活", "91": "存託憑證"
    };

    // UI 初始化 (Token 自動載入)
    document.getElementById('tokenInput').value = TOKEN;
    document.getElementById('tokenStatus').innerHTML = TOKEN ? '<span style="color:#28a745">Token 已從記錄中載入 (下次免輸入)</span>' : '<span style="color:#ffc107">未設定 Token，將使用公開資料</span>';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('endDate').value = today;
    
    const dateRangeEl = document.getElementById('dateRange');
    dateRangeEl.onchange = function() {
        const days = parseInt(this.value);
        const end = new Date();
        const start = new Date(end.getTime() - days * 24 * 60 * 60 * 1000);
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
    };
    dateRangeEl.dispatchEvent(new Event('change'));

    let stockData = [];
    let industryCategories = new Set();
    window.weights = { basic:35, technical:25, market:20, news:10, risk:10 };

    window.log = function(msg) {
        const logEl = document.getElementById('logContent');
        if (logEl) {
            logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        console.log(msg);
    }

    // ================= 核心 API 函數 (原有的 fetchTWSEFinancials 變更為 fetchFullTWSEFinancials) =================
    
    // 原始的 TWSE 財報抓取函數，用於全部分析 (僅用於獲取所有原始數據)
    async function fetchFullTWSEFinancials(stockId) {
        // ... (保持原始的 FinMind 和 Yahoo 邏輯，但不再是核心季度數據來源)
        // ...
        log(`證交所財報 請求中... (${stockId})`);
        
        // 僅清除年報相關的緩存
        financialCache.eps.year = 'N/A';
        financialCache.roe.year = 'N/A';
        financialCache.profitMargin.year = 'N/A';
        financialCache.revenueGrowth.year = 'N/A';


        try {
            // [原碼的 TWSE 數據獲取邏輯 - 保持不變，用於獲取年報及歷史數據]
            const [reportRes, ratioRes, monthlyRes] = await Promise.all([
                fetch(`/.netlify/functions/fetch-twse?type=quarterly`), 
                fetch(`/.netlify/functions/fetch-twse?type=annual`),    
                fetch(`/.netlify/functions/fetch-twse?type=monthly`)    
            ]);

            if (!reportRes.ok || !ratioRes.ok || !monthlyRes.ok) {
                log(`證交所代理請求失敗`);
                return null;
            }

            const reportData = await reportRes.json();
            const ratioData = await ratioRes.json(); 
            const monthlyData = await monthlyRes.json(); 

            const findStocks = (data) => data ? data.filter(item => (String(item.Code) === stockId || String(item.公司代號) === stockId)) : [];
            
            const findValue = (obj, keywords) => {
                if (!obj) return null;
                const keys = Object.keys(obj);
                for (const kw of keywords) {
                    const match = keys.find(k => k.includes(kw));
                    if (match) {
                        const val = obj[match];
                        if (val !== null && val !== undefined && val !== '' && !isNaN(parseFloat(String(val).replace(/,/g, '')))) {
                            return val;
                        }
                    }
                }
                return null;
            };

            const stockReportList = findStocks(reportData);
            const stockRatioList = findStocks(ratioData); 
            const stockMonthly = findStocks(monthlyData)[0]; 

            const findValueInList = (list, keywords) => {
                for (const item of list) {
                    const val = findValue(item, keywords);
                    if (val) return val;
                }
                return null;
            };

            if (stockReportList.length > 0 || stockRatioList.length > 0 || stockMonthly) {
                // EPS (年)
                financialCache.eps.year = findValueInList(stockReportList, ['基本每股盈餘', 'EPS', '每股盈餘']) || 'N/A';
                
                // ROE (年)
                financialCache.roe.year = findValueInList(stockRatioList, ['權益報酬率', 'ROE', '股東權益報酬率', '純益率']) || 'N/A';

                // 毛利率 (年)
                financialCache.profitMargin.year = findValueInList(stockRatioList, ['毛利率', '營業毛利率']) || 'N/A';
                
                // === 累計營收成長率 (年) ===
                let calculatedGrowth = 'N/A';
                
                const currentCumRaw = findValueInList(stockReportList, ['累計營業收入-當月累計營收', '本期累計營業收入']);
                const prevCumRaw = findValueInList(stockReportList, ['累計營業收入-去年累計營收', '累計營業收入-去年同期累計營收', '去年同期累計營業收入']);

                if (currentCumRaw && prevCumRaw) {
                    const current = parseFloat(String(currentCumRaw).replace(/,/g, ''));
                    const previous = parseFloat(String(prevCumRaw).replace(/,/g, ''));
                    
                    if (!isNaN(current) && !isNaN(previous) && previous !== 0) {
                        calculatedGrowth = (((current - previous) / previous) * 100).toFixed(2);
                    }
                } else if (stockMonthly) {
                    const mCurr = findValue(stockMonthly, ['累計營業收入-當月累計營收', '當月累計營收']);
                    const mPrev = findValue(stockMonthly, ['累計營業收入-去年累計營收', '去年累計營收']);
                    if (mCurr && mPrev) {
                        const current = parseFloat(String(mCurr).replace(/,/g, ''));
                        const previous = parseFloat(String(mPrev).replace(/,/g, ''));
                        if (!isNaN(current) && !isNaN(previous) && previous !== 0) {
                            calculatedGrowth = (((current - previous) / previous) * 100).toFixed(2);
                        }
                    }
                }
                
                financialCache.revenueGrowth.year = calculatedGrowth;

                // 月營收與季營收 (短期數據 - 這裡暫不更新，由 loadQuarterlyFinancials 處理)
                
                log(`TWSE (年) 數據更新: EPS=${financialCache.eps.year}, ROE=${financialCache.roe.year}, 累計營收成長=${financialCache.revenueGrowth.year}%`);
                return { source: 'TWSE (Multi-period)', ...financialCache }; 
            } else {
                log(`TWSE 代理成功但未找到 ${stockId} 資料`);
                return null;
            }
        } catch (err) {
            log(`證交所數據處理失敗: ${err.message}`);
            return null;
        }
    }

    async function fetchYahooFinanceFinancials(stockId) {
        // [保持不變]
        try {
            const response = await fetch(`/.netlify/functions/fetch-financials?id=${stockId}`);
            if (!response.ok) return null;
            const result = await response.json(); 
            if (result && !result.error) {
                // 僅更新年報數據，季度數據由 TWSE 函數處理
                financialCache.eps.year = result.defaultKeyStatistics?.trailingEps?.raw || 'N/A';
                financialCache.roe.year = result.financialData?.returnOnEquity?.raw ? result.financialData.returnOnEquity.raw * 100 : 'N/A';
                if (financialCache.revenueGrowth.year === 'N/A') {
                    financialCache.revenueGrowth.year = result.financialData?.revenueGrowth?.raw ? (result.financialData.revenueGrowth.raw * 100).toFixed(2) : 'N/A';
                }
                financialCache.profitMargin.year = result.financialData?.grossMargins?.raw ? result.financialData.grossMargins.raw * 100 : 'N/A';
                return { source: 'Yahoo Finance' };
            }
            return null;
        } catch (err) { return null; }
    }


    // ================= ⚠️ NEW: A+B 方案核心邏輯 ⚠️ =================

    // 負責從 Netlify 函數獲取特定期間的財報數據並更新緩存
    async function fetchAndCacheSpecificFinancials(stockId, year, quarter) {
        log(`正在獲取並計算 [${stockId}] ${year}${quarter} 財報數據 (fetch-twse.js)...`);
        
        // 為了避免重複的 loading 顯示，我們只在 main form 沒在跑的時候顯示
        const loadingIndicator = document.getElementById('loading');
        if (loadingIndicator.style.display === 'none') {
             loadingIndicator.style.display = 'block';
        }

        try {
            const twseApiUrl = `/.netlify/functions/fetch-twse?type=quarterly&stockCode=${stockId}&year=${year}&quarter=${quarter}`;
            const response = await fetch(twseApiUrl);

            if (!response.ok) throw new Error(`TWSE 財報 API 請求失敗: ${response.statusText}`);
            
            const processedData = await response.json(); 
            
            if (processedData && processedData.data) {
                const data = processedData.data;
                
                // 更新 financialCache 的季度數據
                financialCache.eps.quarter = data.EPS !== undefined ? data.EPS : 'N/A';
                financialCache.roe.quarter = data.ROE !== undefined ? data.ROE : 'N/A';
                // 這是最關鍵的部分：使用人工計算的季營收增率
                financialCache.revenueGrowth.quarter = data.QuarterlyRevenueGrowth !== undefined ? data.QuarterlyRevenueGrowth : 'N/A'; 
                financialCache.profitMargin.quarter = data.GrossMarginRate !== undefined ? data.GrossMarginRate : 'N/A';
                
                // 月增率和累積年增率也一併更新
                financialCache.revenueGrowth.month = data.MonthlyRevenueGrowth !== undefined ? data.MonthlyRevenueGrowth : 'N/A';
                if (financialCache.revenueGrowth.year === 'N/A' && data.AnnualRevenueGrowth !== undefined) {
                    // 如果年報數據還沒有，則先用累積年增率填補
                    financialCache.revenueGrowth.year = data.AnnualRevenueGrowth;
                }


                log(`[${stockId}] ${year}${quarter} 財報數據 (含季營收增率) 更新成功。`);
                updateFinancialUI(); // 更新顯示
                calculateBasicScoreFromManualInput(); // 重新計算基本面得分

                return true;
            } else {
                log('TWSE 代理成功但未找到計算後的資料。');
                return false;
            }
        } catch (err) {
            log(`季財報數據獲取失敗: ${err.message}`);
            return false;
        } finally {
             // 只有當主分析沒有在跑時，才隱藏 loading
             if (document.getElementById('analyzeForm').dataset.isSubmitting !== 'true') {
                 loadingIndicator.style.display = 'none';
             }
        }
    }


    // A/B 觸發調用的主函數 (觸發獲取與更新)
    const loadQuarterlyFinancials = async () => {
        const stockCode = document.getElementById('stockCodeFinancial').value.trim();
        const year = document.getElementById('yearSelectFinancial').value;
        const quarter = document.getElementById('quarterSelectFinancial').value;
        
        if (!stockCode || !year || !quarter) {
            log("請輸入股票代碼並選擇完整的期間，才能刷新財報數據。");
            return;
        }
        
        // 清空手動輸入欄位，避免覆蓋自動計算結果
        document.getElementById('manualEps').value = '';
        document.getElementById('manualRoe').value = '';
        document.getElementById('manualRevenueGrowth').value = '';
        document.getElementById('manualProfitMargin').value = '';

        await fetchAndCacheSpecificFinancials(stockCode, year, quarter);
    }

    // ================= 資料載入邏輯 (略過與金融無關的部分) =================
    
    // (loadStockData 函數保持原樣，用於載入股票清單)
    async function loadStockData() {
        let isLoaded = false;
        // ... (FinMind/TWSE 股票清單載入邏輯，保持原樣)
        if (TOKEN) {
             // ... FinMind 邏輯
        }

        if (!isLoaded) {
             // ... TWSE 邏輯
        }

        if (isLoaded) {
            industryCategories = new Set(stockData.map(stock => stock.industry_category).filter(Boolean));
            updateCategorySelect();
        } else {
            log('❌ 無法載入股票清單，請檢查網路連線');
        }
    }
    
    // updateCategorySelect, updateStockSelect (保持原樣)
    // ...

    // ================= UI 更新與評分計算 =================

    function initYearSelectFinancial() {
        // 確保為新的財報選擇器初始化年份
        const currentYear = new Date().getFullYear();
        const yearSelect = document.getElementById('yearSelectFinancial');
        if (!yearSelect) return;
        
        for (let i = 0; i < 5; i++) {
            const year = currentYear - i;
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }
        yearSelect.value = currentYear;
    }
    
    // (updateFinancialUI 保持原樣)
    function updateFinancialUI() {
        // ... (保持原樣，它會根據 financialCache 的內容和結果表格的 period-select 來顯示數據)
        const getVal = (sel, key) => {
            const el = document.querySelector(`.period-select[data-type="${sel}"]`);
            if (!el) return 0;
            const period = el.value;
            
            let dataKey = 'year'; 
            if (period === '季') dataKey = 'quarter';
            if (period === '月') dataKey = 'month';
            if (period === '年' || period === '年(累計)') dataKey = 'year';

            const val = financialCache[key][dataKey];
            return (val === 'N/A' || val === undefined) ? 'N/A' : parseFloat(val);
        };

        const setUI = (id, val, suffix) => {
            const displayEl = document.getElementById(id);
            const inputEl = document.getElementById(id.replace('display', 'manual'));
            const displayVal = (val === 'N/A') ? 'N/A' : `${val.toFixed(2)}${suffix}`;
            if (displayEl) displayEl.textContent = displayVal;
            // 由於我們新增了自動觸發，清空手動輸入框的邏輯應該在 loadQuarterlyFinancials 執行
            // 這裡不再清空 manual input
        };

        const eps = getVal('eps', 'eps');
        setUI('displayEps', eps, ' 元');

        const roe = getVal('roe', 'roe');
        setUI('displayRoe', roe, '%');

        const rev = getVal('revenue', 'revenueGrowth');
        setUI('displayRevenue', rev, '%');

        const margin = getVal('margin', 'profitMargin');
        setUI('displayMargin', margin, '%');

        calculateBasicScoreFromManualInput();
    }

    // ⚠️ NEW: A 方案：設置期間變更監聽器 (自動觸發)
    function setupFinancialChangeListeners() {
        const stockInput = document.getElementById('stockCodeFinancial');
        const yearSelect = document.getElementById('yearSelectFinancial');
        const quarterSelect = document.getElementById('quarterSelectFinancial');
        
        if (stockInput && yearSelect && quarterSelect) {
            stockInput.addEventListener('change', loadQuarterlyFinancials); 
            yearSelect.addEventListener('change', loadQuarterlyFinancials);
            quarterSelect.addEventListener('change', loadQuarterlyFinancials);
            log("A 方案 (財報期間自動更新) 監聽器已啟用。");
        }
    }
    
    // ⚠️ NEW: B 方案：設置手動刷新按鈕監聽器 (手動觸發)
    function setupManualRefreshListener() {
        const refreshButton = document.getElementById('refreshFinancialsButton');
        if (refreshButton) {
            refreshButton.addEventListener('click', loadQuarterlyFinancials);
            log("B 方案 (手動刷新按鈕) 監聽器已啟用。");
        }
    }
    
    // setupPeriodChangeListeners (原始邏輯 - 保持原樣，用於結果表格內的切換)
    function setupPeriodChangeListeners() {
        document.querySelectorAll('.period-select').forEach(select => {
            select.addEventListener('change', updateFinancialUI);
        });
    }
    
    // setupManualInputListeners (保持原樣)
    function setupManualInputListeners() {
        document.querySelectorAll('.manual-input').forEach(input => {
            input.addEventListener('change', calculateBasicScoreFromManualInput);
        });
    }

    // calculateBasicScoreFromManualInput (保持原樣)
    // ...

    // analyzeForm.onsubmit (主分析流程 - 需調整其財報獲取邏輯)
    document.getElementById('analyzeForm').onsubmit = async e => {
        e.preventDefault();
        const symbol = document.getElementById('stockSelect').value.trim();
        if (!symbol) { alert('請選擇股票'); return; }
        
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        log(`=== 分析開始：${symbol} ===`);
        document.getElementById('loading').style.display = 'block';
        document.getElementById('result').style.display = 'none';
        document.getElementById('logContent').textContent = '';
        
        // 標記表單正在提交
        document.getElementById('analyzeForm').dataset.isSubmitting = 'true';

        try {
            // ... (股票名稱、行業信息獲取 - 保持原樣)
            let name = symbol;
            let industry = '未知';
            if (stockData.length > 0) {
                const stock = stockData.find(s => s.stock_id === symbol);
                if (stock) { name = stock.stock_name; industry = stock.industry_category; }
            }

            // 股價數據獲取 (保持原樣)
            let priceDataFinal = await fetchYahooWithProxy(`${symbol}.TW`, '股價');
            if (!priceDataFinal && !TOKEN) { 
                const twsePrice = await fetchTWSEPrice(symbol);
                // ... (TWSE 股價轉換邏輯)
            }
            if (!priceDataFinal) throw new Error('無法取得股價資料，請稍後再試');

            // ⚠️ 調整財報數據獲取邏輯：優先使用新的期間選擇來更新緩存
            const financialStock = document.getElementById('stockCodeFinancial').value.trim();
            const financialYear = document.getElementById('yearSelectFinancial').value;
            const financialQuarter = document.getElementById('quarterSelectFinancial').value;

            // 1. 如果股票代碼或期間有變動，或緩存缺失，則強制刷新財報數據
            if (financialStock !== symbol || financialCache.eps.quarter === 'N/A' || financialCache.roe.quarter === 'N/A') {
                document.getElementById('stockCodeFinancial').value = symbol; // 同步股票代碼
                await fetchAndCacheSpecificFinancials(symbol, financialYear, financialQuarter);
            }
            
            // 2. 獲取年報數據 (作為基本面評分的備用和補充)
            let financialData = await fetchFullTWSEFinancials(symbol); // 獲取年報
            if (!financialData || financialCache.eps.year === 'N/A' || financialCache.revenueGrowth.year === 'N/A') {
                 financialData = await fetchYahooFinanceFinancials(symbol);
            }
            
            // ... (新聞、大盤數據獲取 - 保持原樣)
            let newsRaw = null;
            if (TOKEN) newsRaw = await fetchFinmind('TaiwanStockNews', symbol, startDate);
            let marketData = await fetchYahooWithProxy('%5ETWII', '大盤');
            
            // ... (技術面、市場面、新聞面、風險面評分計算 - 保持原樣，它會使用更新後的 financialCache)

            const finSource = financialData?.source || '無';
            
            document.getElementById('result').innerHTML = `
                <div class="text-center mb-5">
                    <h2>${symbol} ${name} <small class="text-info">(${industry})</small></h2>
                    <div id="finalScore"><h1 class="score-big">--</h1></div>
                    <p class="lead">整體市場趨勢評分 <span id="weightHint" style="color:yellow"></span></p>
                    <p class="fs-5">現價 ${price} ｜ 期間漲跌 ${risePercent}%</p>
                    <p class="data-source">資料來源: 股價(Yahoo) 財報(${finSource})</p>
                </div>

                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="card text-dark">
                            <div class="card-header bg-primary text-white"><strong>最新財報數據</strong></div>
                            <div class="financial-period"><small class="text-muted">請使用下方選單切換分析維度</small></div>
                            <table class="table table-striped mb-0">
                                <thead><tr><th>面向</th><th>期間</th><th>數值</th><th class="manual-label">輸入</th></tr></thead>
                                <tbody>
                                    <tr>
                                        <td>EPS</td>
                                        <td><select class="form-select period-select" data-type="eps"><option value="季">季</option><option value="年">年</option></select></td>
                                        <td class="fw-bold fs-5" id="displayEps">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualEps" class="form-control manual-input" step="0.01"></td>
                                    </tr>
                                    <tr>
                                        <td>ROE</td>
                                        <td><select class="form-select period-select" data-type="roe"><option value="季">季</option><option value="年">年</option></select></td>
                                        <td class="fs-5" id="displayRoe">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualRoe" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                    <tr>
                                        <td>營收增率</td>
                                        <td><select class="form-select period-select" data-type="revenue"><option value="月">月</option><option value="季">季</option><option value="年">年(累計)</option></select></td>
                                        <td class="fs-5" id="displayRevenue">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualRevenueGrowth" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                    <tr>
                                        <td>毛利率</td>
                                        <td><select class="form-select period-select" data-type="margin"><option value="季">季</option><option value="年">年</option></select></td>
                                        <td class="fs-5" id="displayMargin">N/A</td>
                                        <td class="manual-input-cell"><input type="number" id="manualProfitMargin" class="form-control manual-input" step="0.1"></td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            </div>
                    </div>

                    <div class="col-lg-7">
                        </div>
                </div>

                <div class="card mt-4">
                    <div class="card-body"><canvas id="priceChart"></canvas></div>
                </div>
            `;

            setupPeriodChangeListeners();
            setupManualInputListeners();
            updateFinancialUI(); 

            // ... (圖表渲染邏輯 - 保持原樣) ...
            
            document.getElementById('result').style.display = 'block';

        } catch (err) {
            log(`錯誤: ${err.message}`);
            document.getElementById('result').innerHTML = `<div class="alert alert-danger text-center py-5"><h3>${err.message}</h3></div>`;
            document.getElementById('result').style.display = 'block';
        }
        
        // 結束提交標記並隱藏 loading
        document.getElementById('analyzeForm').dataset.isSubmitting = 'false';
        document.getElementById('loading').style.display = 'none';
    };

    loadStockData();
    document.addEventListener('DOMContentLoaded', () => {
        initYearSelectFinancial(); // ⚠️ NEW: 初始化財報期間選擇器
        setupFinancialChangeListeners(); // ⚠️ NEW: A 方案
        setupManualRefreshListener(); // ⚠️ NEW: B 方案
        setupPeriodChangeListeners();
        setupManualInputListeners();
        
        // 初始載入時，嘗試使用默認值載入財報數據
        loadQuarterlyFinancials();
    });
});
</script>
</body>
</html>
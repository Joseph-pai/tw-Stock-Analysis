<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ç£è‚¡å¸‚çµ‚æ¥µå°ˆæ¥­åˆ†æå™¨ - Joseph PAI 2025 (Final Structured v21)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        body { background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%); min-height: 100vh; color: white; font-family: 'Microsoft JhengHei',sans-serif; }
        .container { max-width: 1350px; }
        .card { background: rgba(255,255,255,0.12); backdrop-filter: blur(12px); border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .score-big { font-size: 6.5rem; font-weight: 900; text-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        .badge-pos { background: #28a745; }
        .badge-neg { background: #dc3545; }
        .weight-input { width: 80px; text-align: center; font-weight: bold; background:#fff; color:#333; }
        footer { margin-top: 80px; padding: 30px; text-align: center; color: rgba(255,255,255,0.8); }
        .debug-log { max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; padding: 15px; border-radius: 8px; font-size: 0.8rem; }
        .token-status { font-weight: bold; margin-top: 5px; }
        .data-source { font-size: 0.8rem; color: #ffc107; margin-top: 10px; }
        .date-range-input { width: 130px; }
        .manual-input { width: 100%; text-align: center; font-size: 1rem; color: #000; }
        .explanation { background: white; color: black; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .explanation h6 { color: #8B0000; margin-bottom: 5px; font-weight: bold; }
        .manual-input-cell { padding: 5px !important; width: 100px; }
        .manual-label { font-size: 1rem; color: #ffc107; font-weight: bold; }
        .table-header-red { background-color: #8B0000; color: white; }
        .period-select { width: 110px; font-size: 0.9rem; cursor: pointer; color: #000; }
        .financial-period { background-color: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .metric-explanation { background: rgba(255,255,255,0.95); color: #333; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .metric-explanation h6 { color: #8B0000; font-weight: bold; margin-bottom: 10px; }
        .metric-item { margin-bottom: 8px; font-size: 0.85rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        td, th { vertical-align: middle; }
    </style>
</head>
<body>
<div class="container py-5">

    <h1 class="text-center mb-2">å°ç£è‚¡å¸‚çµ‚æ¥µå°ˆæ¥­åˆ†æå™¨</h1>
    <p class="text-center text-white-50 mb-5">Joseph PAI 2025 Structured Edition â€¢ å¤šé€±æœŸè²¡å ±è‡ªå‹•é‹ç®—</p>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text">FinMind Token</span>
                <input type="text" id="tokenInput" class="form-control" placeholder="é¸å¡«ï¼šè²¼ä¸Š Token ä»¥ç²å–æ›´è©³ç´°æ–°èæ•¸æ“š">
                <button class="btn btn-warning fw-bold" id="saveToken">å„²å­˜</button>
            </div>
            <div id="tokenStatus" class="token-status"></div>
        </div>
    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-10">
            <form id="analyzeForm" class="card p-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label text-white-50">é¸æ“‡é¡è‚¡</label>
                        <select id="stockCategory" class="form-select">
                            <option value="all">å…¨éƒ¨é¡è‚¡</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label text-white-50">é¸æ“‡è‚¡ç¥¨</label>
                        <select id="stockSelect" class="form-select" required>
                            <option value="">è«‹å…ˆé¸æ“‡é¡è‚¡</option>
                        </select>
                    </div>
                    <div class="col-md-12 d-flex align-items-center flex-wrap gap-2">
                        <span class="text-white-50">æœŸé–“ï¼š</span>
                        <select id="dateRange" class="form-select form-select-sm date-range-input">
                            <option value="60" selected>è¿‘ 60 å¤©</option>
                            <option value="180">è¿‘åŠå¹´</option>
                            <option value="365">è¿‘ä¸€å¹´</option>
                        </select>
                        <span class="text-white-50 ms-2">è‡ªè¨‚ï¼š</span>
                        <input type="date" id="startDate" class="form-control form-control-sm date-range-input">
                        <span class="text-white-50">è‡³</span>
                        <input type="date" id="endDate" class="form-control form-control-sm date-range-input">
                        <button class="btn btn-warning text-dark fw-bold ms-auto" type="submit">ç«‹å³å°ˆæ¥­åˆ†æ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="text-center mb-4">
        <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#debugLog">
            é¡¯ç¤º/éš±è— ç³»çµ±æ—¥èªŒ
        </button>
    </div>

    <div class="collapse" id="debugLog">
        <div class="card mb-4">
            <div class="card-body p-2">
                <pre id="logContent" class="debug-log"></pre>
                <div class="text-end">
                    <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('logContent').textContent = '';">æ¸…é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center my-5" style="display:none;">
        <div class="spinner-border text-warning" style="width:4rem;height:4rem;"></div>
        <h4 class="mt-3">æ­£åœ¨é€²è¡Œå¤šç¶­åº¦æ•¸æ“šåˆ†æ...</h4>
        <small class="text-white-50">æ•´åˆæç›Šè¡¨ã€è³‡ç”¢è² å‚µè¡¨èˆ‡æœˆç‡Ÿæ”¶æ•¸æ“š</small>
    </div>

    <div id="result" style="display:none;"></div>

</div>

<footer>Â© 2025 Joseph PAI. All Rights Reserved. | è³‡æ–™ä¾†æºï¼šå°ç£è­‰åˆ¸äº¤æ˜“æ‰€ (TWSE) + FinMind + Yahoo Finance</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ================= å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– =================
    let TOKEN = '';
    try { TOKEN = localStorage.getItem('joseph_pai_token_2025') || ''; } catch(e) {}

    // è²¡å‹™æ•¸æ“šå¿«å– (çµæ§‹åŒ–)
    // é€™è£¡å„²å­˜å¾å¾Œç«¯ç²å–çš„æ‰€æœ‰åŸå§‹æ•¸æ“šï¼Œè®“ UI å¯ä»¥éš¨æ™‚åˆ‡æ›è€Œä¸éœ€é‡æ–°è«‹æ±‚
    let financialCache = {
        eps: { quarters: {}, year: 'N/A' },
        roe: { quarters: {}, year: 'N/A' },
        revenueGrowth: { months: {}, quarters: {}, year: 'N/A' },
        profitMargin: { quarters: {}, year: 'N/A' },
        source: 'N/A'
    };

    let stockData = [];
    let industryCategories = new Set();
    window.weights = { basic:35, technical:25, market:20, news:10, risk:10 };

    // ç”¢æ¥­åˆ¥ä»£ç¢¼å°ç…§è¡¨
    const twseIndustryMap = {
        "01": "æ°´æ³¥å·¥æ¥­", "02": "é£Ÿå“å·¥æ¥­", "03": "å¡‘è† å·¥æ¥­", "04": "ç´¡ç¹”çº–ç¶­", "05": "é›»æ©Ÿæ©Ÿæ¢°",
        "06": "é›»å™¨é›»çºœ", "07": "åŒ–å­¸ç”ŸæŠ€é†«ç™‚", "08": "ç»ç’ƒé™¶ç“·", "09": "é€ ç´™å·¥æ¥­", "10": "é‹¼éµå·¥æ¥­",
        "11": "æ©¡è† å·¥æ¥­", "12": "æ±½è»Šå·¥æ¥­", "13": "é›»å­å·¥æ¥­", "14": "å»ºæç‡Ÿé€ ", "15": "èˆªé‹æ¥­",
        "16": "è§€å…‰äº‹æ¥­", "17": "é‡‘èä¿éšª", "18": "è²¿æ˜“ç™¾è²¨", "20": "å…¶ä»–", "21": "åŒ–å­¸å·¥æ¥­",
        "22": "ç”ŸæŠ€é†«ç™‚æ¥­", "23": "æ²¹é›»ç‡ƒæ°£æ¥­", "24": "åŠå°é«”æ¥­", "25": "é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­",
        "26": "å…‰é›»æ¥­", "27": "é€šä¿¡ç¶²è·¯æ¥­", "28": "é›»å­é›¶çµ„ä»¶æ¥­", "29": "é›»å­é€šè·¯æ¥­", "30": "è³‡è¨Šæœå‹™æ¥­",
        "31": "å…¶ä»–é›»å­æ¥­"
    };

    // UI è¨­å®š
    document.getElementById('tokenInput').value = TOKEN;
    document.getElementById('tokenStatus').innerHTML = TOKEN ? '<span class="text-success">Token å·²è¼‰å…¥</span>' : '<span class="text-warning">æœªè¨­å®š Token (ä½¿ç”¨åŸºæœ¬åŠŸèƒ½)</span>';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('endDate').value = today;
    
    const dateRangeEl = document.getElementById('dateRange');
    dateRangeEl.onchange = function() {
        const days = parseInt(this.value);
        const end = new Date();
        const start = new Date(end.getTime() - days * 24 * 60 * 60 * 1000);
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
    };
    dateRangeEl.dispatchEvent(new Event('change'));

    window.log = function(msg) {
        const logEl = document.getElementById('logContent');
        if (logEl) {
            logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        console.log(msg);
    }

    // ================= æ ¸å¿ƒï¼šæ•¸æ“šç²å–èˆ‡è™•ç† =================

    // 1. ç²å–ä¸¦ç·©å­˜çµæ§‹åŒ–è²¡å‹™æ•¸æ“š
    async function fetchTWSEFinancials(stockId) {
        log(`æ­£åœ¨å¾ TWSE ç²å– ${stockId} çš„å®Œæ•´è²¡å ±æ•¸æ“š...`);
        
        // é‡ç½®å¿«å–
        financialCache = {
            eps: { quarters: {}, year: 'N/A' },
            roe: { quarters: {}, year: 'N/A' },
            revenueGrowth: { months: {}, quarters: {}, year: 'N/A' },
            profitMargin: { quarters: {}, year: 'N/A' },
            source: 'Pending'
        };

        try {
            // å‘¼å«å¾Œç«¯ (fetch-twse.js) åŸ·è¡Œå¤šç¶­åº¦ç²å–èˆ‡è¨ˆç®—
            // å¾Œç«¯æœƒè‡ªå‹•è™•ç† 404 éŒ¯èª¤ä¸¦é€²è¡Œå‚™æ´è¨ˆç®— (å¦‚æ¯›åˆ©ç‡)
            const response = await fetch(`/.netlify/functions/fetch-twse?type=financials&stock_id=${stockId}`);
            
            if (!response.ok) throw new Error(`API å›æ‡‰éŒ¯èª¤: ${response.status}`);
            
            const data = await response.json();
            
            if (data.error) throw new Error(data.error);

            // æ›´æ–°å¿«å–
            financialCache = {
                eps: data.eps || { quarters: {}, year: 'N/A' },
                roe: data.roe || { quarters: {}, year: 'N/A' },
                revenueGrowth: data.revenueGrowth || { months: {}, quarters: {}, year: 'N/A' },
                profitMargin: data.profitMargin || { quarters: {}, year: 'N/A' },
                source: 'TWSE (è­‰äº¤æ‰€)'
            };

            log(`âœ… è²¡å ±æ•¸æ“šç²å–æˆåŠŸ (ä¾†æº: ${financialCache.source})`);
            log(`  - å­£å ±è³‡æ–™: ${Object.keys(financialCache.eps.quarters).length > 0 ? 'æœ‰' : 'ç„¡'}`);
            log(`  - å¹´å ±è³‡æ–™: ${financialCache.eps.year !== 'N/A' ? 'æœ‰' : 'ç„¡'}`);
            log(`  - æœˆç‡Ÿæ”¶: ${Object.keys(financialCache.revenueGrowth.months).length} ç­†`);

            return data;

        } catch (err) {
            log(`âš ï¸ TWSE æ•¸æ“šç²å–å¤±æ•— (${err.message})ï¼Œåˆ‡æ›è‡³ Yahoo Finance å‚™æ´...`);
            return await fetchYahooFinanceFinancials(stockId);
        }
    }

    // 2. Yahoo Finance å‚™æ´
    async function fetchYahooFinanceFinancials(stockId) {
        try {
            const response = await fetch(`/.netlify/functions/fetch-financials?id=${stockId}`);
            if (!response.ok) return null;
            const res = await response.json();
            if (res && !res.error) {
                // å°‡ Yahoo æ•¸æ“šæ˜ å°„åˆ°çµæ§‹åŒ–å¿«å–
                financialCache.eps.year = res.defaultKeyStatistics?.trailingEps?.raw || 'N/A';
                financialCache.roe.year = res.financialData?.returnOnEquity?.raw ? (res.financialData.returnOnEquity.raw * 100).toFixed(2) : 'N/A';
                financialCache.revenueGrowth.year = res.financialData?.revenueGrowth?.raw ? (res.financialData.revenueGrowth.raw * 100).toFixed(2) : 'N/A';
                financialCache.profitMargin.year = res.financialData?.grossMargins?.raw ? (res.financialData.grossMargins.raw * 100).toFixed(2) : 'N/A';
                financialCache.source = 'Yahoo Finance (å‚™æ´)';
                return financialCache;
            }
        } catch (e) { log(`Yahoo å‚™æ´å¤±æ•—: ${e.message}`); }
        return null;
    }

    // 3. ç²å–è‚¡åƒ¹ (Yahoo Proxy / TWSE)
    async function fetchYahooWithProxy(symbol, logName) {
        log(`${logName} è«‹æ±‚ä¸­...`);
        try {
            const response = await fetch(`/.netlify/functions/fetch-price?id=${symbol}`);
            if (!response.ok) return null;
            const data = await response.json();
            return (data && data.chart?.result?.[0]) ? data : null;
        } catch (err) { return null; }
    }

    async function fetchTWSEPrice(stockId) {
        try {
            const response = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY?stockNo=${stockId}`);
            if (!response.ok) return null;
            const data = await response.json();
            return (Array.isArray(data) && data.length > 0) ? data : null;
        } catch (err) { return null; }
    }

    // 4. æ–°è (FinMind)
    async function fetchFinmindNews(stockId, startDate) {
        if (!TOKEN) return null;
        try {
            const url = `/.netlify/functions/fetch-finmind?dataset=TaiwanStockNews&data_id=${stockId}&start_date=${startDate}&token=${TOKEN}`;
            const res = await fetch(url);
            const data = await res.json();
            return (data.status === 200) ? data : null;
        } catch (e) { return null; }
    }

    // ================= UI æ›´æ–°é‚è¼¯ =================

    // æ›´æ–°è²¡å‹™æ•¸æ“š UI (æ ¹æ“šé¸æ“‡çš„æœŸé–“)
    function updateFinancialUI() {
        const getVal = (type, key) => {
            const select = document.querySelector(`.period-select[data-type="${type}"]`);
            if (!select) return 'N/A';
            
            const period = select.value; // "å­£", "å¹´", "æœˆ"
            const dataObj = financialCache[key];

            if (!dataObj) return 'N/A';

            let val = 'N/A';
            
            if (period === 'å¹´' || period === 'å¹´(ç´¯è¨ˆ)') {
                val = dataObj.year;
            } else if (period === 'å­£') {
                // è‡ªå‹•å–ã€Œæœ€æ–°ã€çš„ä¸€å­£æ•¸æ“š
                const qs = Object.keys(dataObj.quarters || {}).sort(); // Q1, Q2, Q3, Q4...
                if (qs.length > 0) {
                    const latestQ = qs[qs.length - 1]; // å–æœ€å¾Œä¸€å€‹
                    val = dataObj.quarters[latestQ];
                    // å¯é¸ï¼šæ›´æ–° Label é¡¯ç¤ºå…·é«”å­£åº¦ (e.g. 2024Q3)
                    // log(`é¡¯ç¤º ${key} å­£åº¦æ•¸æ“š: ${latestQ} = ${val}`);
                }
            } else if (period === 'æœˆ') {
                // è‡ªå‹•å–ã€Œæœ€æ–°ã€çš„ä¸€å€‹æœˆæ•¸æ“š
                // æ³¨æ„ï¼šé€™è£¡å‡è¨­ key æ˜¯ "Latest" (å¾Œç«¯è™•ç†é) æˆ– "YYYYMM"
                if (dataObj.months) {
                     // å¦‚æœæœ‰ "Latest" key (å¾Œç«¯è¨ˆç®—å¥½çš„)
                     if (dataObj.months['Latest']) val = dataObj.months['Latest'];
                     else {
                         // å¦å‰‡å– key æœ€å¤§çš„
                         const ms = Object.keys(dataObj.months).sort();
                         if (ms.length > 0) val = dataObj.months[ms[ms.length - 1]];
                     }
                }
            }
            return (val === null || val === undefined) ? 'N/A' : val;
        };

        const updateField = (id, val, suffix) => {
            const el = document.getElementById(id);
            const input = document.getElementById(id.replace('display', 'manual'));
            
            const displayVal = (val === 'N/A') ? 'N/A' : `${parseFloat(val).toFixed(2)}${suffix}`;
            if (el) el.textContent = displayVal;
            
            // åªæœ‰ç•¶è¼¸å…¥æ¡†ç‚ºç©ºæ™‚ï¼Œæ‰æ›´æ–° placeholder
            if (input && input.value === '') {
                input.placeholder = (val !== 'N/A') ? parseFloat(val).toFixed(2) : 'æ‰‹å‹•è¼¸å…¥';
            }
        };

        updateField('displayEps', getVal('eps', 'eps'), ' å…ƒ');
        updateField('displayRoe', getVal('roe', 'roe'), '%');
        updateField('displayRevenue', getVal('revenue', 'revenueGrowth'), '%');
        updateField('displayMargin', getVal('margin', 'profitMargin'), '%');

        calculateBasicScoreFromManualInput();
    }

    // è¨ˆç®—åŸºæœ¬é¢è©•åˆ†
    window.calculateBasicScoreFromManualInput = function() {
        const getScoreVal = (manualId, type, key) => {
            // 1. å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥
            const manual = document.getElementById(manualId);
            if (manual && manual.value !== '') return parseFloat(manual.value);

            // 2. å˜—è©¦å¾ç•¶å‰ UI é¸å®šçš„æœŸé–“ç²å–
            const select = document.querySelector(`.period-select[data-type="${type}"]`);
            const period = select ? select.value : 'å¹´';
            
            let val = 'N/A';
            const dataObj = financialCache[key];

            if (period === 'å¹´') val = dataObj.year;
            else if (period === 'å­£') {
                const qs = Object.keys(dataObj.quarters || {}).sort();
                if (qs.length > 0) val = dataObj.quarters[qs[qs.length - 1]];
            } else if (period === 'æœˆ') {
                if (dataObj.months && dataObj.months['Latest']) val = dataObj.months['Latest'];
                else {
                    const ms = Object.keys(dataObj.months || {}).sort();
                    if (ms.length > 0) val = dataObj.months[ms[ms.length - 1]];
                }
            }

            // 3. å‚™æ´æ©Ÿåˆ¶ï¼šå¦‚æœé¸å®šæœŸé–“ç„¡æ•¸æ“šï¼Œå˜—è©¦é€€å›åˆ° "Year" æ•¸æ“š (é¿å…åˆ†æ•¸æ­¸é›¶)
            if ((val === 'N/A' || val === null) && dataObj.year !== 'N/A' && dataObj.year !== null) {
                // log(`${key} ç•¶å‰æœŸé–“ç„¡æ•¸æ“šï¼Œä½¿ç”¨å¹´åº¦æ•¸æ“šå‚™æ´`);
                val = dataObj.year;
            }

            return (val === 'N/A' || val === null) ? NaN : parseFloat(val);
        };

        const eps = getScoreVal('manualEps', 'eps', 'eps');
        const roe = getScoreVal('manualRoe', 'roe', 'roe');
        const rev = getScoreVal('manualRevenueGrowth', 'revenue', 'revenueGrowth');
        const margin = getScoreVal('manualProfitMargin', 'margin', 'profitMargin');

        let score = 0;
        let reasons = [];

        // EPS (30%)
        if (!isNaN(eps)) {
            if (eps >= 8) { score += 30; reasons.push(`EPS ${eps} â‰¥ 8 (+30)`); }
            else if (eps >= 5) { score += 25; reasons.push(`EPS ${eps} â‰¥ 5 (+25)`); }
            else if (eps >= 3) { score += 18; reasons.push(`EPS ${eps} â‰¥ 3 (+18)`); }
            else if (eps >= 0) { score += 5; reasons.push(`EPS ${eps} â‰¥ 0 (+5)`); }
            else { score -= 15; reasons.push(`EPS ${eps} < 0 (-15)`); }
        } else reasons.push('EPS ç„¡æ•¸æ“š');

        // ROE (30%)
        if (!isNaN(roe)) {
            if (roe >= 15) { score += 30; reasons.push(`ROE ${roe}% â‰¥ 15 (+30)`); }
            else if (roe >= 10) { score += 20; reasons.push(`ROE ${roe}% â‰¥ 10 (+20)`); }
            else if (roe >= 5) { score += 10; reasons.push(`ROE ${roe}% â‰¥ 5 (+10)`); }
            else if (roe > 0) { score += 5; reasons.push(`ROE ${roe}% > 0 (+5)`); }
            else { score -= 10; reasons.push(`ROE ${roe}% â‰¤ 0 (-10)`); }
        } else reasons.push('ROE ç„¡æ•¸æ“š');

        // ç‡Ÿæ”¶æˆé•· (30%)
        if (!isNaN(rev)) {
            if (rev >= 30) { score += 30; reasons.push(`ç‡Ÿæ”¶å¢ ${rev}% â‰¥ 30 (+30)`); }
            else if (rev >= 10) { score += 20; reasons.push(`ç‡Ÿæ”¶å¢ ${rev}% â‰¥ 10 (+20)`); }
            else if (rev > 0) { score += 10; reasons.push(`ç‡Ÿæ”¶å¢ ${rev}% > 0 (+10)`); }
            else { score -= 10; reasons.push(`ç‡Ÿæ”¶å¢ ${rev}% â‰¤ 0 (-10)`); }
        } else reasons.push('ç‡Ÿæ”¶å¢ç‡ ç„¡æ•¸æ“š');

        // æ¯›åˆ©ç‡ (10%)
        if (!isNaN(margin)) {
            if (margin >= 50) { score += 10; reasons.push(`æ¯›åˆ© ${margin}% â‰¥ 50 (+10)`); }
            else if (margin >= 20) { score += 5; reasons.push(`æ¯›åˆ© ${margin}% â‰¥ 20 (+5)`); }
            else reasons.push(`æ¯›åˆ© ${margin}% < 20 (0)`);
        } else reasons.push('æ¯›åˆ© ç„¡æ•¸æ“š');

        // åŠ æ¬Š
        const weight = window.weights.basic || 35;
        const finalScore = Math.max(-weight, Math.min(weight, Math.round(score / 100 * weight)));

        // é¡¯ç¤º
        const badge = document.getElementById('score_basic');
        if (badge) {
            badge.textContent = `${finalScore > 0 ? '+' : ''}${finalScore}`;
            badge.className = `badge ${finalScore >= 0 ? 'badge-pos' : 'badge-neg'} fs-5`;
        }
        
        const desc = document.querySelector('#scoreTable tbody tr:nth-child(1) td:nth-child(4)');
        if (desc) desc.innerHTML = `<small>${reasons.join('<br>')}</small>`;
        
        updateTotalScore();
    };

    window.adjustWeights = function(field, val) {
        window.weights[field] = parseFloat(val);
        // ç°¡å–®çš„æ¬Šé‡è‡ªå‹•å¹³è¡¡é‚è¼¯ (å¯é¸)
        const total = Object.values(window.weights).reduce((a,b)=>a+b,0);
        document.getElementById('weightHint').textContent = total !== 100 ? `(ç¸½æ¬Šé‡: ${total}%)` : '';
        calculateBasicScoreFromManualInput();
    };

    function updateTotalScore() {
        const getScore = (id) => {
            const el = document.getElementById(id);
            return el ? parseFloat(el.innerText.replace('+','')) : 0;
        }
        const s = {
            basic: getScore('score_basic'),
            technical: getScore('score_technical'),
            market: getScore('score_market'),
            news: getScore('score_news'),
            risk: getScore('score_risk')
        };
        const total = s.basic + s.technical + s.market + s.news + s.risk;
        const final = Math.max(-100, Math.min(100, total)); // ç¸½åˆ†ç¯„åœå‡è¨­ 0-100 æˆ– -100-100
        
        const finalEl = document.getElementById('finalScore');
        const color = final >= 60 ? 'text-success' : (final >= 0 ? 'text-warning' : 'text-danger');
        if (finalEl) finalEl.innerHTML = `<h1 class="score-big ${color}">${final}</h1>`;
    }

    // ================= è‚¡ç¥¨æ¸…å–®è¼‰å…¥ =================
    async function loadStockData() {
        // å…ˆå˜—è©¦ FinMind
        if (TOKEN) {
            try {
                const url = `/.netlify/functions/fetch-finmind?dataset=TaiwanStockInfo&token=${TOKEN}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.status === 200 && data.data) {
                    stockData = data.data;
                    updateCategories();
                    return;
                }
            } catch(e) {}
        }
        
        // å‚™æ´ï¼šTWSE
        log('è¼‰å…¥è‚¡ç¥¨æ¸…å–®ä¸­...');
        try {
            const res = await fetch('/.netlify/functions/fetch-twse?type=stocks');
            if (res.ok) {
                const data = await res.json();
                stockData = data.map(item => ({
                    stock_id: item.Code || item['å…¬å¸ä»£è™Ÿ'],
                    stock_name: item.Name || item['å…¬å¸ç°¡ç¨±'],
                    industry_category: twseIndustryMap[item['ç”¢æ¥­åˆ¥']] || item['ç”¢æ¥­åˆ¥'] || 'å…¶ä»–'
                })).filter(s => s.stock_id && s.stock_name);
                
                // å»é‡
                const seen = new Set();
                stockData = stockData.filter(el => {
                    const duplicate = seen.has(el.stock_id);
                    seen.add(el.stock_id);
                    return !duplicate;
                });
                
                updateCategories();
                log(`è‚¡ç¥¨æ¸…å–®è¼‰å…¥å®Œæˆ (${stockData.length} æª”)`);
            }
        } catch (e) { log('è‚¡ç¥¨æ¸…å–®è¼‰å…¥å¤±æ•—'); }
    }

    function updateCategories() {
        const cats = new Set(stockData.map(s => s.industry_category).filter(Boolean));
        const sel = document.getElementById('stockCategory');
        sel.innerHTML = '<option value="all">å…¨éƒ¨é¡è‚¡</option>';
        Array.from(cats).sort().forEach(c => {
            sel.add(new Option(c, c));
        });
        updateStocks();
    }

    function updateStocks() {
        const cat = document.getElementById('stockCategory').value;
        const sel = document.getElementById('stockSelect');
        sel.innerHTML = '';
        
        const filtered = (cat === 'all') ? stockData : stockData.filter(s => s.industry_category === cat);
        filtered.sort((a,b) => a.stock_id.localeCompare(b.stock_id));
        
        if (filtered.length === 0) sel.add(new Option('ç„¡è³‡æ–™', ''));
        
        // ç‚ºäº†æ•ˆèƒ½ï¼Œè‹¥å…¨éƒ¨é¡è‚¡å¤ªå¤šï¼Œå¯åªé¡¯ç¤ºå‰ 100 ç­†æˆ–æç¤ºæœå°‹
        // é€™è£¡ç›´æ¥å…¨éƒ¨åŠ å…¥
        filtered.forEach(s => {
            sel.add(new Option(`${s.stock_id} ${s.stock_name}`, s.stock_id));
        });
    }

    document.getElementById('stockCategory').addEventListener('change', updateStocks);
    document.getElementById('saveToken').addEventListener('click', () => {
        const t = document.getElementById('tokenInput').value.trim();
        if(t) { localStorage.setItem('joseph_pai_token_2025', t); alert('Token å·²å„²å­˜'); location.reload(); }
    });

    // ================= ä¸»åˆ†ææµç¨‹ =================
    document.getElementById('analyzeForm').onsubmit = async (e) => {
        e.preventDefault();
        const symbol = document.getElementById('stockSelect').value;
        if (!symbol) return alert('è«‹é¸æ“‡è‚¡ç¥¨');

        document.getElementById('loading').style.display = 'block';
        document.getElementById('result').style.display = 'none';
        document.getElementById('logContent').textContent = '';
        
        log(`=== é–‹å§‹åˆ†æ ${symbol} ===`);

        try {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // 1. å–å¾—åŸºæœ¬è³‡æ–™ (åç¨±/ç”¢æ¥­)
            const info = stockData.find(s => s.stock_id === symbol);
            const name = info ? info.stock_name : symbol;
            const industry = info ? info.industry_category : 'æœªçŸ¥';

            // 2. ç²å–è‚¡åƒ¹
            let priceData = await fetchYahooWithProxy(`${symbol}.TW`, 'è‚¡åƒ¹');
            if (!priceData) {
                log('Yahoo è‚¡åƒ¹å¤±æ•—ï¼Œå˜—è©¦ TWSE...');
                const twseData = await fetchTWSEPrice(symbol);
                if (twseData) {
                    // è½‰æ› TWSE æ ¼å¼ç‚º Chart æ ¼å¼
                    const closes = twseData.map(d => parseFloat(d.Close.replace(/,/g,'')));
                    const times = twseData.map(d => {
                        const parts = d.Date.split('/');
                        return new Date(parseInt(parts[0])+1911, parseInt(parts[1])-1, parseInt(parts[2])).getTime()/1000;
                    });
                    priceData = { chart: { result: [{ timestamp: times, indicators: { quote: [{ close: closes }] } }] } };
                }
            }
            if (!priceData) throw new Error('ç„¡æ³•å–å¾—è‚¡åƒ¹è³‡æ–™');

            // 3. ç²å–è²¡å‹™æ•¸æ“š (å‘¼å«æ–°çš„çµæ§‹åŒ– API)
            await fetchTWSEFinancials(symbol);

            // 4. ç²å–æ–°è (é¸å¡«)
            const newsData = await fetchFinmindNews(symbol, startDate);

            // 5. ç²å–å¤§ç›¤ (ç”¨æ–¼æ¯”è¼ƒ)
            const marketData = await fetchYahooWithProxy('%5ETWII', 'å¤§ç›¤');

            // --- æ•¸æ“šè™•ç†èˆ‡æ¸²æŸ“ ---
            
            // è‚¡åƒ¹è¨ˆç®—
            const quotes = priceData.chart.result[0].indicators.quote[0].close;
            const times = priceData.chart.result[0].timestamp;
            const startTs = new Date(startDate).getTime() / 1000;
            
            // éæ¿¾æ™‚é–“ç¯„åœ
            const validData = times.map((t, i) => ({ t, p: quotes[i] })).filter(d => d.t >= startTs && d.p);
            if (validData.length === 0) throw new Error('æ­¤æœŸé–“ç„¡è‚¡åƒ¹è³‡æ–™');
            
            const closes = validData.map(d => d.p);
            const dates = validData.map(d => new Date(d.t*1000).toLocaleDateString());
            const currentPrice = closes[closes.length-1];
            const startPrice = closes[0];
            const risePct = ((currentPrice - startPrice) / startPrice * 100).toFixed(2);

            // æŠ€è¡“é¢è©•åˆ†
            let techScore = 0, techReason = '';
            const techW = window.weights.technical;
            if (risePct >= 30) { techScore = techW; techReason = `æ¼²å¹… ${risePct}% å¼·å‹¢`; }
            else if (risePct >= 10) { techScore = techW * 0.6; techReason = `æ¼²å¹… ${risePct}% åå¤š`; }
            else if (risePct <= -10) { techScore = -techW * 0.5; techReason = `è·Œå¹… ${risePct}% å¼±å‹¢`; }
            else { techScore = 0; techReason = `æ¼²å¹… ${risePct}% ç›¤æ•´`; }

            // å¸‚å ´é¢è©•åˆ†
            let marketScore = 0, marketReason = 'ç„¡è³‡æ–™';
            if (marketData) {
                const mQuotes = marketData.chart.result[0].indicators.quote[0].close;
                // ç°¡åŒ–ï¼šå–æœ€å¾Œä¸€æ®µæ¼²å¹…æ¯”è¼ƒ
                const mStart = mQuotes[mQuotes.length - closes.length] || mQuotes[0];
                const mEnd = mQuotes[mQuotes.length - 1];
                const mRise = ((mEnd - mStart) / mStart * 100);
                const beat = parseFloat(risePct) - mRise;
                
                if (beat > 5) { marketScore = window.weights.market; marketReason = `å¼·æ–¼å¤§ç›¤ ${beat.toFixed(1)}%`; }
                else if (beat < -5) { marketScore = -window.weights.market * 0.5; marketReason = `å¼±æ–¼å¤§ç›¤ ${beat.toFixed(1)}%`; }
                else { marketScore = window.weights.market * 0.3; marketReason = `èˆ‡å¤§ç›¤åŒæ­¥`; }
            }

            // æ¶ˆæ¯é¢è©•åˆ†
            let newsScore = 0, newsReason = 'ç„¡é‡å¤§æ–°è';
            if (newsData && newsData.data.length > 0) {
                let pos = 0, neg = 0;
                newsData.data.forEach(n => {
                    if (n.title.match(/ç‡Ÿæ”¶|æ–°é«˜|å¤§æ¼²|ç²åˆ©|æˆé•·/)) pos++;
                    if (n.title.match(/è™§æ|è£å“¡|å¤§è·Œ|è¡°é€€/)) neg++;
                });
                if (pos > neg) { newsScore = window.weights.news; newsReason = `åˆ©å¤šæ–°è (${pos} vs ${neg})`; }
                else if (neg > pos) { newsScore = -window.weights.news; newsReason = `åˆ©ç©ºæ–°è (${pos} vs ${neg})`; }
            }

            // é¢¨éšªé¢ (åŸºæ–¼è²¡å ±)
            let riskScore = 0, riskReason = 'è²¡å‹™ç©©å¥';
            const epsYear = parseFloat(financialCache.eps.year);
            if (!isNaN(epsYear) && epsYear < 0) {
                riskScore = -window.weights.risk;
                riskReason = `å¹´åº¦ EPS ${epsYear} ç‚ºè™§æç‹€æ…‹`;
            }

            // æ¸²æŸ“ HTML
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="text-center mb-5">
                    <h2>${symbol} ${name} <span class="badge bg-secondary fs-6">${industry}</span></h2>
                    <div id="finalScore"><h1 class="score-big">--</h1></div>
                    <p class="lead">æ•´é«”è©•åˆ† <span id="weightHint" style="font-size:0.8em;color:#aaa"></span></p>
                    <p class="fs-5">ç¾åƒ¹ ${currentPrice} <small class="${risePct>=0?'text-danger':'text-success'}">(${risePct}%)</small></p>
                    <p class="data-source">è²¡å ±ä¾†æº: ${financialCache.source}</p>
                </div>

                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="card text-white">
                            <div class="card-header bg-primary"><strong>æœ€æ–°è²¡å ±æ•¸æ“š</strong></div>
                            <div class="p-3">
                                <div class="financial-period d-flex align-items-center justify-content-between">
                                    <small class="text-white-50">æ•¸æ“šæœŸé–“ï¼š</small>
                                    <small class="text-warning">ç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨æœ€æ–°æ•¸æ“šé€²è¡Œè©•åˆ†</small>
                                </div>
                                <table class="table table-dark table-striped mb-0">
                                    <thead><tr><th>é …ç›®</th><th>æœŸé–“</th><th>æ•¸å€¼</th><th>æ‰‹å‹•ä¿®æ­£</th></tr></thead>
                                    <tbody>
                                        <tr>
                                            <td>EPS</td>
                                            <td><select class="form-select form-select-sm period-select" data-type="eps"><option value="å­£">å­£</option><option value="å¹´">å¹´</option></select></td>
                                            <td class="fw-bold fs-5 text-warning" id="displayEps">N/A</td>
                                            <td class="manual-input-cell"><input type="number" id="manualEps" class="form-control form-control-sm manual-input" step="0.01"></td>
                                        </tr>
                                        <tr>
                                            <td>ROE</td>
                                            <td><select class="form-select form-select-sm period-select" data-type="roe"><option value="å­£">å­£</option><option value="å¹´">å¹´</option></select></td>
                                            <td class="fs-5" id="displayRoe">N/A</td>
                                            <td class="manual-input-cell"><input type="number" id="manualRoe" class="form-control form-control-sm manual-input" step="0.1"></td>
                                        </tr>
                                        <tr>
                                            <td>ç‡Ÿæ”¶å¢ç‡</td>
                                            <td><select class="form-select form-select-sm period-select" data-type="revenue"><option value="æœˆ">æœˆ</option><option value="å­£">å­£</option><option value="å¹´">å¹´(ç´¯è¨ˆ)</option></select></td>
                                            <td class="fs-5" id="displayRevenue">N/A</td>
                                            <td class="manual-input-cell"><input type="number" id="manualRevenueGrowth" class="form-control form-control-sm manual-input" step="0.1"></td>
                                        </tr>
                                        <tr>
                                            <td>æ¯›åˆ©ç‡</td>
                                            <td><select class="form-select form-select-sm period-select" data-type="margin"><option value="å­£">å­£</option><option value="å¹´">å¹´</option></select></td>
                                            <td class="fs-5" id="displayMargin">N/A</td>
                                            <td class="manual-input-cell"><input type="number" id="manualProfitMargin" class="form-control form-control-sm manual-input" step="0.1"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="metric-explanation mt-3">
                                    <h6>ğŸ“ˆ æŒ‡æ¨™èªªæ˜</h6>
                                    <div class="metric-item"><strong>EPS:</strong> æ¯è‚¡ç›ˆé¤˜ï¼Œå…¬å¸ç²åˆ©èƒ½åŠ›çš„çµ•å°æŒ‡æ¨™ã€‚</div>
                                    <div class="metric-item"><strong>ROE:</strong> è‚¡æ±æ¬Šç›Šå ±é…¬ç‡ï¼Œè³‡é‡‘é‹ç”¨çš„æ•ˆç‡ã€‚</div>
                                    <div class="metric-item"><strong>ç‡Ÿæ”¶å¢ç‡:</strong> åæ˜ å…¬å¸æˆé•·å‹•èƒ½ (æœˆ/å­£/å¹´)ã€‚</div>
                                    <div class="metric-item"><strong>æ¯›åˆ©ç‡:</strong> (ç‡Ÿæ”¶-æˆæœ¬)/ç‡Ÿæ”¶ï¼Œåæ˜ ç”¢å“ç«¶çˆ­åŠ›ã€‚</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-7">
                        <div class="card text-white">
                            <div class="card-header bg-danger table-header-red"><strong>AI ç¶œåˆè©•åˆ†</strong></div>
                            <table class="table table-dark table-striped mb-0" id="scoreTable">
                                <thead><tr><th>é¢å‘</th><th>æ¬Šé‡%</th><th>å¾—åˆ†</th><th>è©•èª</th></tr></thead>
                                <tbody>
                                    <tr>
                                        <td>åŸºæœ¬é¢</td>
                                        <td><input type="number" class="form-control form-control-sm weight-input" value="${window.weights.basic}" onchange="adjustWeights('basic',this.value)"></td>
                                        <td><span class="badge badge-pos fs-6" id="score_basic">0</span></td>
                                        <td><small>åˆ†æä¸­...</small></td>
                                    </tr>
                                    <tr>
                                        <td>æŠ€è¡“é¢</td>
                                        <td><input type="number" class="form-control form-control-sm weight-input" value="${window.weights.technical}" onchange="adjustWeights('technical',this.value)"></td>
                                        <td><span class="badge ${techScore>=0?'badge-pos':'badge-neg'} fs-6" id="score_technical">${techScore}</span></td>
                                        <td>${techReason}</td>
                                    </tr>
                                    <tr>
                                        <td>å¸‚å ´é¢</td>
                                        <td><input type="number" class="form-control form-control-sm weight-input" value="${window.weights.market}" onchange="adjustWeights('market',this.value)"></td>
                                        <td><span class="badge ${marketScore>=0?'badge-pos':'badge-neg'} fs-6" id="score_market">${marketScore}</span></td>
                                        <td>${marketReason}</td>
                                    </tr>
                                    <tr>
                                        <td>æ¶ˆæ¯é¢</td>
                                        <td><input type="number" class="form-control form-control-sm weight-input" value="${window.weights.news}" onchange="adjustWeights('news',this.value)"></td>
                                        <td><span class="badge ${newsScore>=0?'badge-pos':'badge-neg'} fs-6" id="score_news">${newsScore}</span></td>
                                        <td>${newsReason}</td>
                                    </tr>
                                    <tr>
                                        <td>é¢¨éšªé¢</td>
                                        <td><input type="number" class="form-control form-control-sm weight-input" value="${window.weights.risk}" onchange="adjustWeights('risk',this.value)"></td>
                                        <td><span class="badge ${riskScore>=0?'badge-pos':'badge-neg'} fs-6" id="score_risk">${riskScore}</span></td>
                                        <td>${riskReason}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card mt-3">
                             <div class="card-body p-2"><canvas id="priceChart" height="200"></canvas></div>
                        </div>
                    </div>
                </div>
            `;

            // è¨­å®šç›£è½å™¨
            document.querySelectorAll('.period-select').forEach(s => s.addEventListener('change', updateFinancialUI));
            document.querySelectorAll('.manual-input').forEach(i => i.addEventListener('input', calculateBasicScoreFromManualInput));
            
            // ç¹ªåœ–
            new Chart(document.getElementById('priceChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        { label: name, data: closes, borderColor: '#0d6efd', tension: 0.1, pointRadius: 0 },
                        { label: 'å¤§ç›¤(åƒè€ƒ)', data: marketData?.chart.result[0].indicators.quote[0].close.slice(-closes.length) || [], borderColor: '#dc3545', tension: 0.1, pointRadius: 0, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: 'white' } } },
                    scales: {
                        x: { ticks: { color: '#ccc' } },
                        y: { ticks: { color: '#ccc' } },
                        y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { display: false } }
                    }
                }
            });

            // åˆå§‹åŒ–æ•¸å€¼é¡¯ç¤º
            updateFinancialUI();
            
            document.getElementById('result').style.display = 'block';

        } catch (err) {
            log(`âŒ éŒ¯èª¤: ${err.message}`);
            document.getElementById('result').innerHTML = `<div class="alert alert-danger text-center">åˆ†æå¤±æ•—: ${err.message}</div>`;
            document.getElementById('result').style.display = 'block';
        }
        document.getElementById('loading').style.display = 'none';
    };

    // å•Ÿå‹•
    loadStockData();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­‰äº¤æ‰€ API æ ¼å¼æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        .endpoint {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .endpoint h3 {
            margin-top: 0;
            color: #667eea;
        }
        .info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .result {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #667eea;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-card h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 14px;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .field-list {
            columns: 2;
            column-gap: 20px;
            font-size: 13px;
            line-height: 1.8;
        }
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .download-link {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            margin: 10px 0;
            font-weight: bold;
        }
        .download-link:hover {
            background: #218838;
        }
        .raw-data {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è­‰äº¤æ‰€ API æ–‡ä»¶ä¸‹è¼‰æ¸¬è©¦å·¥å…·</h1>
        
        <div class="note">
            <strong>ğŸ“ Base URL:</strong> <code>https://openapi.twse.com.tw/v1</code><br>
            <strong>ğŸ“ èªªæ˜:</strong> é€™äº› API ç«¯é»è¿”å›æ–‡ä»¶ä¸‹è¼‰ï¼Œæ¸¬è©¦å…§å®¹é¡å‹å’Œæ–‡ä»¶æ ¼å¼<br>
            <strong>âš ï¸ æ³¨æ„:</strong> ç”±æ–¼ CORS é™åˆ¶ï¼Œç›´æ¥ä¸‹è¼‰å¯èƒ½å—é™ï¼Œå»ºè­°åœ¨ä¼ºæœå™¨ç«¯ä½¿ç”¨
        </div>

        <div style="text-align: center; margin-bottom: 30px;">
            <button onclick="runAllTests()" id="testBtn">é–‹å§‹æ¸¬è©¦æ‰€æœ‰ API</button>
            <button onclick="testFinancialAPIs()" style="background: #28a745;">æ¸¬è©¦è²¡å‹™å ±è¡¨ API</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            â³ æ­£åœ¨æ¸¬è©¦ API æ–‡ä»¶ä¸‹è¼‰ï¼Œè«‹ç¨å€™...
        </div>

        <div id="results"></div>
    </div>

    <script>
        // TWSE æ–‡ä»¶ä¸‹è¼‰ API ç«¯é»
        const endpoints = [
            {
                name: 'ä¸Šå¸‚å…¬å¸æ¯æœˆç‡Ÿæ¥­æ”¶å…¥å½™ç¸½è¡¨',
                path: '/opendata/t187ap05_L',
                category: 'financial',
                description: 'CSV/JSON æ ¼å¼çš„æœˆç‡Ÿæ”¶æ•¸æ“š',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å…¬å¸ç¶œåˆæç›Šè¡¨(ä¸€èˆ¬æ¥­)',
                path: '/opendata/t187ap06_L_ci',
                category: 'financial',
                description: 'ç¶œåˆæç›Šè¡¨æ•¸æ“šæ–‡ä»¶',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å…¬å¸è³‡ç”¢è² å‚µè¡¨(ä¸€èˆ¬æ¥­)',
                path: '/opendata/t187ap07_L_ci',
                category: 'financial',
                description: 'è³‡ç”¢è² å‚µè¡¨æ•¸æ“šæ–‡ä»¶',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å…¬å¸å„ç”¢æ¥­EPSçµ±è¨ˆè³‡è¨Š',
                path: '/opendata/t187ap14_L',
                category: 'financial',
                description: 'å„ç”¢æ¥­EPSçµ±è¨ˆæ•¸æ“š',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å…¬å¸ç‡Ÿç›Šåˆ†ææŸ¥è©¢å½™ç¸½è¡¨',
                path: '/opendata/t187ap17_L',
                category: 'financial',
                description: 'ç‡Ÿç›Šåˆ†ææ•¸æ“šæ–‡ä»¶',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å€‹è‚¡æ—¥æœ¬ç›Šæ¯”ã€æ®–åˆ©ç‡åŠè‚¡åƒ¹æ·¨å€¼æ¯”',
                path: '/exchangeReport/BMTBBU_ALL',
                category: 'trading',
                description: 'å€‹è‚¡è©•åƒ¹æŒ‡æ¨™æ•¸æ“š',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å€‹è‚¡æ—¥æˆäº¤è³‡è¨Š',
                path: '/exchangeReport/STOCK_DAY_ALL',
                category: 'trading',
                description: 'æ¯æ—¥æˆäº¤æ•¸æ“šæ–‡ä»¶',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å€‹è‚¡æœˆæˆäº¤è³‡è¨Š',
                path: '/exchangeReport/FMSRFK_ALL',
                category: 'trading',
                description: 'æ¯æœˆæˆäº¤çµ±è¨ˆæ–‡ä»¶',
                expectedType: 'application/json'
            },
            {
                name: 'æ¯æ—¥æ”¶ç›¤è¡Œæƒ…-å¤§ç›¤çµ±è¨ˆè³‡è¨Š',
                path: '/exchangeReport/WL_INDEX',
                category: 'trading',
                description: 'å¤§ç›¤çµ±è¨ˆæ•¸æ“šæ–‡ä»¶',
                expectedType: 'application/json'
            },
            {
                name: 'é›†ä¸­å¸‚å ´å¤–è³‡åŠé™¸è³‡æŒè‚¡å‰20å',
                path: '/fund/WL_0FIIS_sort_20',
                category: 'trading',
                description: 'å¤–è³‡æŒè‚¡æ’åæ•¸æ“š',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å…¬å¸åŸºæœ¬è³‡æ–™',
                path: '/opendata/t187ap03_L',
                category: 'governance',
                description: 'å…¬å¸åŸºæœ¬è³‡æ–™æ–‡ä»¶',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å…¬å¸è‚¡åˆ©åˆ†æ´¾æƒ…å½¢',
                path: '/opendata/t187ap45_L',
                category: 'governance',
                description: 'è‚¡åˆ©åˆ†æ´¾æ•¸æ“šæ–‡ä»¶',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å…¬å¸è‘£äº‹é…¬é‡‘ç›¸é—œè³‡è¨Š',
                path: '/opendata/t187ap29_A_L',
                category: 'governance',
                description: 'è‘£äº‹é…¬é‡‘æ•¸æ“šæ–‡ä»¶',
                expectedType: 'application/json'
            },
            {
                name: 'ä¸Šå¸‚å…¬å¸æ¯æ—¥é‡å¤§è¨Šæ¯',
                path: '/opendata/t187ap04_L',
                category: 'governance',
                description: 'é‡å¤§è¨Šæ¯æ•¸æ“šæ–‡ä»¶',
                expectedType: 'application/json'
            },
            {
                name: 'ç™¼è¡Œé‡åŠ æ¬Šè‚¡åƒ¹æŒ‡æ•¸æ­·å²è³‡æ–™',
                path: '/indicesReport/MI_5MINS_HIST',
                category: 'indices',
                description: 'åŠ æ¬ŠæŒ‡æ•¸æ­·å²æ•¸æ“š',
                expectedType: 'application/json'
            },
            {
                name: 'è‡ºç£50æŒ‡æ•¸æ­·å²è³‡æ–™',
                path: '/indicesReport/TAI501',
                category: 'indices',
                description: 'å°ç£50æŒ‡æ•¸æ•¸æ“š',
                expectedType: 'application/json'
            },
            {
                name: 'å¯¶å³¶è‚¡åƒ¹æŒ‡æ•¸æ­·å²è³‡æ–™',
                path: '/indicesReport/FRMSA',
                category: 'indices',
                description: 'å¯¶å³¶è‚¡åƒ¹æŒ‡æ•¸æ•¸æ“š',
                expectedType: 'application/json'
            }
        ];

        async function runAllTests() {
            const btn = document.getElementById('testBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            btn.disabled = true;
            loading.style.display = 'block';
            results.innerHTML = '';

            for (const endpoint of endpoints) {
                await testFileDownload(endpoint);
                // æ·»åŠ å»¶é²é¿å…éåº¦é »ç¹è«‹æ±‚
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            loading.style.display = 'none';
            btn.disabled = false;
        }

        async function testFinancialAPIs() {
            const btn = document.getElementById('testBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            btn.disabled = true;
            loading.style.display = 'block';
            results.innerHTML = '';

            const financialEndpoints = endpoints.filter(ep => ep.category === 'financial');

            for (const endpoint of financialEndpoints) {
                await testFileDownload(endpoint);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            loading.style.display = 'none';
            btn.disabled = false;
        }

        async function testFileDownload(endpoint) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'endpoint';
            
            const apiUrl = `https://openapi.twse.com.tw/v1${endpoint.path}`;
            
            let html = `
                <h3>${endpoint.name}</h3>
                <div class="info">
                    <strong>ğŸ“ API ç«¯é»:</strong> ${endpoint.path}<br>
                    <strong>ğŸ“ æè¿°:</strong> ${endpoint.description}<br>
                    <strong>ğŸ”— å®Œæ•´ URL:</strong> <code>${apiUrl}</code>
                </div>
            `;

            try {
                console.log(`æ¸¬è©¦æ–‡ä»¶ä¸‹è¼‰: ${endpoint.name} - ${apiUrl}`);
                
                // ä½¿ç”¨ HEAD è«‹æ±‚å…ˆæª¢æŸ¥å…§å®¹é¡å‹
                const headResponse = await fetch(apiUrl, { 
                    method: 'HEAD',
                    mode: 'no-cors'
                }).catch(e => null);

                // å˜—è©¦ç²å–æ–‡ä»¶å…§å®¹
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json, text/csv, */*'
                    }
                });
                
                if (!response.ok) {
                    html += `<p class="error">âŒ HTTP éŒ¯èª¤: ${response.status} ${response.statusText}</p>`;
                    resultDiv.innerHTML = html;
                    document.getElementById('results').appendChild(resultDiv);
                    return;
                }

                // æª¢æŸ¥å…§å®¹é¡å‹
                const contentType = response.headers.get('content-type') || 'unknown';
                const contentLength = response.headers.get('content-length') || 'unknown';
                
                html += `
                    <div class="stats">
                        <div class="stat-card">
                            <h4>å…§å®¹é¡å‹</h4>
                            <div class="value">${contentType.includes('json') ? 'JSON âœ…' : contentType.includes('csv') ? 'CSV âœ…' : contentType}</div>
                        </div>
                        <div class="stat-card">
                            <h4>æ–‡ä»¶å¤§å°</h4>
                            <div class="value">${contentLength !== 'unknown' ? (contentLength / 1024).toFixed(2) + ' KB' : 'æœªçŸ¥'}</div>
                        </div>
                        <div class="stat-card">
                            <h4>ç‹€æ…‹</h4>
                            <div class="value">${response.ok ? 'æˆåŠŸ âœ…' : 'å¤±æ•— âŒ'}</div>
                        </div>
                    </div>
                `;

                // ç›´æ¥ä¸‹è¼‰é€£çµ
                html += `
                    <div>
                        <a href="${apiUrl}" class="download-link" target="_blank" download>
                            ğŸ“¥ ç›´æ¥ä¸‹è¼‰æ–‡ä»¶
                        </a>
                    </div>
                `;

                // å˜—è©¦è®€å–å…§å®¹
                try {
                    if (contentType.includes('json')) {
                        const data = await response.json();
                        html += `
                            <p class="success">âœ… æˆåŠŸè§£æ JSON æ•¸æ“š</p>
                            <details open>
                                <summary><strong>ğŸ“Š JSON æ•¸æ“šé è¦½ (å‰3ç­†):</strong></summary>
                                <div class="result">${JSON.stringify(Array.isArray(data) ? data.slice(0, 3) : data, null, 2)}</div>
                            </details>
                        `;
                    } else if (contentType.includes('csv') || contentType.includes('text')) {
                        const text = await response.text();
                        const lines = text.split('\n').slice(0, 10); // åªé¡¯ç¤ºå‰10è¡Œ
                        html += `
                            <p class="success">âœ… æˆåŠŸè®€å–æ–‡æœ¬æ•¸æ“š</p>
                            <details open>
                                <summary><strong>ğŸ“Š æ–‡ä»¶å…§å®¹é è¦½ (å‰10è¡Œ):</strong></summary>
                                <div class="raw-data">${lines.join('\n')}</div>
                            </details>
                        `;
                    } else {
                        // äºŒé€²åˆ¶æ–‡ä»¶æˆ–å…¶ä»–æ ¼å¼
                        const blob = await response.blob();
                        html += `
                            <p class="warning">âš ï¸ äºŒé€²åˆ¶æ–‡ä»¶æ ¼å¼: ${contentType}</p>
                            <p>æ–‡ä»¶å¤§å°: ${(blob.size / 1024).toFixed(2)} KB</p>
                        `;
                    }
                } catch (parseError) {
                    html += `<p class="warning">âš ï¸ ç„¡æ³•è§£æå…§å®¹: ${parseError.message}</p>`;
                }

            } catch (error) {
                html += `<p class="error">âŒ è«‹æ±‚å¤±æ•—: ${error.message}</p>`;
                
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    html += `
                        <div class="note">
                            <strong>ğŸ”§ è§£æ±ºæ–¹æ¡ˆ:</strong><br>
                            1. ä½¿ç”¨ä¼ºæœå™¨ç«¯ä»£ç†ç¹é CORS é™åˆ¶<br>
                            2. ç›´æ¥é»æ“Šä¸Šæ–¹"ç›´æ¥ä¸‹è¼‰æ–‡ä»¶"é€£çµ<br>
                            3. åœ¨å¾Œç«¯ç¨‹å¼ç¢¼ä¸­èª¿ç”¨æ­¤ API
                        </div>
                    `;
                }
                
                console.error('æ¸¬è©¦éŒ¯èª¤:', error);
            }

            resultDiv.innerHTML = html;
            document.getElementById('results').appendChild(resultDiv);
        }

        // é é¢è¼‰å…¥æ™‚çš„æç¤º
        window.onload = function() {
            console.log('%cğŸ” è­‰äº¤æ‰€æ–‡ä»¶ä¸‹è¼‰ API æ¸¬è©¦å·¥å…·å·²å°±ç·’', 'color: #667eea; font-size: 16px; font-weight: bold;');
            console.log('Base URL: https://openapi.twse.com.tw/v1');
            console.log('é€™äº› API è¿”å›æ–‡ä»¶ä¸‹è¼‰ï¼Œè€Œéç›´æ¥ JSON éŸ¿æ‡‰');
            
            // é¡¯ç¤ºä½¿ç”¨èªªæ˜
            const note = document.querySelector('.note');
            note.innerHTML += `
                <br><strong>ğŸ¯ æ¸¬è©¦é‡é»:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li>æª¢æŸ¥æ–‡ä»¶å…§å®¹é¡å‹ (JSON/CSV)</li>
                    <li>é©—è­‰æ–‡ä»¶å¯è¨ªå•æ€§</li>
                    <li>æ¸¬è©¦ç›´æ¥ä¸‹è¼‰åŠŸèƒ½</li>
                    <li>é è¦½æ–‡ä»¶å…§å®¹æ ¼å¼</li>
                </ul>
            `;
        };
    </script>
</body>
</html>
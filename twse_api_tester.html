<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­‰äº¤æ‰€ API æ ¼å¼æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        .endpoint {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .endpoint h3 {
            margin-top: 0;
            color: #667eea;
        }
        .info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .result {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #667eea;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-card h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 14px;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .field-list {
            columns: 2;
            column-gap: 20px;
            font-size: 13px;
            line-height: 1.8;
        }
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è­‰äº¤æ‰€ API æ ¼å¼æ¸¬è©¦å·¥å…·</h1>
        
        <div class="note">
            <strong>âš ï¸ æ³¨æ„ï¼š</strong> æ­¤å·¥å…·éœ€è¦ä¸Šå‚³åˆ° Netlify æ‰èƒ½ä½¿ç”¨ï¼ˆé€é Netlify Functions ä»£ç†ï¼‰<br>
            <strong>ğŸ“ ä½¿ç”¨æ–¹å¼ï¼š</strong> å°‡æ­¤æª”æ¡ˆæ”¾åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼Œä¸Šå‚³å¾Œè¨ªå• <code>https://twstock-analysis.netlify.app/test-api.html</code>
        </div>

        <div style="text-align: center; margin-bottom: 30px;">
            <button onclick="runAllTests()" id="testBtn">é–‹å§‹æ¸¬è©¦æ‰€æœ‰ API</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            â³ æ­£åœ¨æ¸¬è©¦ APIï¼Œè«‹ç¨å€™...
        </div>

        <div id="results"></div>
    </div>

    <script>
        // ä½¿ç”¨ Netlify Functions ä»£ç†
        const endpoints = [
            {
                name: 'ç¶œåˆæç›Šè¡¨ (å­£åº¦/å¹´åº¦)',
                proxyUrl: '/.netlify/functions/fetch-twse?type=quarterly',
                usage: 'ç”¨æ–¼: å¹´åº¦/å­£åº¦ EPS, æ¯›åˆ©ç‡, æ·¨åˆ©',
                searchKey: '2330'
            },
            {
                name: 'è²¡å‹™æ¯”ç‡ (å¹´åº¦)',
                proxyUrl: '/.netlify/functions/fetch-twse?type=annual',
                usage: 'ç”¨æ–¼: ROE ç­‰è²¡å‹™æ¯”ç‡',
                searchKey: '2330'
            },
            {
                name: 'æœˆç‡Ÿæ”¶è¡¨',
                proxyUrl: '/.netlify/functions/fetch-twse?type=monthly',
                usage: 'ç”¨æ–¼: æœˆç‡Ÿæ”¶å¢ç‡, å¹´ç‡Ÿæ”¶å¢ç‡',
                searchKey: '2330'
            },
            {
                name: 'è‚¡ç¥¨æ¸…å–®',
                proxyUrl: '/.netlify/functions/fetch-twse?type=stocks',
                usage: 'ç”¨æ–¼: ç²å–è‚¡ç¥¨ä»£ç¢¼å’Œåç¨±',
                searchKey: '2330'
            }
        ];

        async function runAllTests() {
            const btn = document.getElementById('testBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            btn.disabled = true;
            loading.style.display = 'block';
            results.innerHTML = '';

            for (const endpoint of endpoints) {
                await testEndpoint(endpoint);
            }

            loading.style.display = 'none';
            btn.disabled = false;
        }

        async function testEndpoint(endpoint) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'endpoint';
            
            let html = `
                <h3>${endpoint.name}</h3>
                <div class="info">
                    <strong>ğŸ“ ä»£ç†ç«¯é»:</strong> ${endpoint.proxyUrl}<br>
                    <strong>ğŸ“ ç”¨é€”:</strong> ${endpoint.usage}
                </div>
            `;

            try {
                const response = await fetch(endpoint.proxyUrl);
                
                if (!response.ok) {
                    html += `<p class="error">âŒ HTTP éŒ¯èª¤: ${response.status} ${response.statusText}</p>`;
                    resultDiv.innerHTML = html;
                    document.getElementById('results').appendChild(resultDiv);
                    return;
                }

                const data = await response.json();

                if (!Array.isArray(data)) {
                    html += `<p class="error">âŒ æ ¼å¼éŒ¯èª¤: ä¸æ˜¯é™£åˆ—æ ¼å¼</p>`;
                    html += `<div class="result">${JSON.stringify(data, null, 2)}</div>`;
                    resultDiv.innerHTML = html;
                    document.getElementById('results').appendChild(resultDiv);
                    return;
                }

                const totalRows = data.length;
                
                if (totalRows === 0) {
                    html += `<p class="warning">âš ï¸ ç„¡æ•¸æ“šè¿”å›</p>`;
                    resultDiv.innerHTML = html;
                    document.getElementById('results').appendChild(resultDiv);
                    return;
                }

                const firstRow = data[0];
                const isObject = typeof firstRow === 'object' && !Array.isArray(firstRow);
                const isArray = Array.isArray(firstRow);

                html += `
                    <div class="stats">
                        <div class="stat-card">
                            <h4>è³‡æ–™æ ¼å¼</h4>
                            <div class="value">${isObject ? 'ç‰©ä»¶ âœ…' : isArray ? 'é™£åˆ— âš ï¸' : 'æœªçŸ¥'}</div>
                        </div>
                        <div class="stat-card">
                            <h4>ç¸½ç­†æ•¸</h4>
                            <div class="value">${totalRows}</div>
                        </div>
                        <div class="stat-card">
                            <h4>æ¬„ä½æ•¸é‡</h4>
                            <div class="value">${isObject ? Object.keys(firstRow).length : isArray ? firstRow.length : '?'}</div>
                        </div>
                    </div>
                `;

                if (isObject) {
                    const fields = Object.keys(firstRow);
                    html += `
                        <p class="success">âœ… æ ¼å¼: ç‰©ä»¶ (å¯ç”¨æ¬„ä½åç¨±å­˜å–)</p>
                        <details open>
                            <summary><strong>ğŸ“‹ å¯ç”¨æ¬„ä½ (${fields.length} å€‹):</strong></summary>
                            <div class="field-list">
                                ${fields.map(f => `â€¢ <code>${f}</code>`).join('<br>')}
                            </div>
                        </details>
                    `;

                    // æœå°‹ç¯„ä¾‹è‚¡ç¥¨
                    const sample = data.find(row => 
                        row['å…¬å¸ä»£ç¢¼'] === endpoint.searchKey || 
                        row['Code'] === endpoint.searchKey ||
                        row['stock_id'] === endpoint.searchKey
                    );

                    if (sample) {
                        // é«˜äº®é—œéµæ¬„ä½
                        const keyFields = ['å…¬å¸ä»£ç¢¼', 'Code', 'stock_id', 'è³‡æ–™å¹´æœˆ', 'EPS', 'ROE', 'ç‡Ÿæ¥­æ¯›åˆ©ç‡(%)', 'ç‡Ÿæ¥­æ”¶å…¥-å»å¹´åŒæœˆå¢æ¸›(%)'];
                        const highlightedSample = {};
                        
                        Object.keys(sample).forEach(key => {
                            if (keyFields.some(kf => key.includes(kf))) {
                                highlightedSample[`â­ ${key}`] = sample[key];
                            } else {
                                highlightedSample[key] = sample[key];
                            }
                        });

                        html += `
                            <details open>
                                <summary><strong>ğŸ¯ ç¯„ä¾‹æ•¸æ“š (è‚¡ç¥¨ä»£ç¢¼: ${endpoint.searchKey}) - é—œéµæ¬„ä½å·²æ¨™è¨˜ â­</strong></summary>
                                <div class="result">${JSON.stringify(highlightedSample, null, 2)}</div>
                            </details>
                        `;
                    } else {
                        html += `<p class="warning">âš ï¸ æœªæ‰¾åˆ°è‚¡ç¥¨ä»£ç¢¼ ${endpoint.searchKey} çš„æ•¸æ“š</p>`;
                    }

                } else if (isArray) {
                    html += `
                        <p class="warning">âš ï¸ æ ¼å¼: é™£åˆ— (éœ€ç”¨ç´¢å¼•å­˜å–ï¼Œè¼ƒä¸æ–¹ä¾¿)</p>
                        <p><strong>ğŸ“Š ç¬¬ä¸€ç­†æ•¸æ“š (ç”¨æ–¼åˆ¤æ–·æ¬„ä½é †åº):</strong></p>
                        <div class="result">${JSON.stringify(firstRow, null, 2)}</div>
                    `;

                    const sampleIdx = data.findIndex(row => 
                        (Array.isArray(row) && row[0] === endpoint.searchKey) ||
                        row.å…¬å¸ä»£ç¢¼ === endpoint.searchKey
                    );
                    
                    if (sampleIdx >= 0) {
                        html += `
                            <p><strong>ğŸ¯ ç¯„ä¾‹æ•¸æ“š (è‚¡ç¥¨ä»£ç¢¼: ${endpoint.searchKey}, ç´¢å¼•: ${sampleIdx}):</strong></p>
                            <div class="result">${JSON.stringify(data[sampleIdx], null, 2)}</div>
                        `;
                    }
                }

                html += `
                    <details>
                        <summary><strong>ğŸ“„ å‰ 3 ç­†åŸå§‹æ•¸æ“š:</strong></summary>
                        <div class="result">${JSON.stringify(data.slice(0, 3), null, 2)}</div>
                    </details>
                `;

            } catch (error) {
                html += `<p class="error">âŒ éŒ¯èª¤: ${error.message}</p>`;
                console.error('æ¸¬è©¦éŒ¯èª¤:', error);
            }

            resultDiv.innerHTML = html;
            document.getElementById('results').appendChild(resultDiv);
        }

        // é é¢è¼‰å…¥æ™‚çš„æç¤º
        window.onload = function() {
            console.log('%cğŸ” è­‰äº¤æ‰€ API æ¸¬è©¦å·¥å…·å·²å°±ç·’', 'color: #667eea; font-size: 16px; font-weight: bold;');
            console.log('æ­¤å·¥å…·é€é Netlify Functions ä»£ç†è¨ªå•è­‰äº¤æ‰€ API');
            
            // æª¢æŸ¥æ˜¯å¦åœ¨æœ¬åœ°æ‰“é–‹
            if (window.location.protocol === 'file:') {
                const note = document.querySelector('.note');
                note.style.background = '#f8d7da';
                note.style.borderColor = '#dc3545';
                note.innerHTML = `
                    <strong>âŒ éŒ¯èª¤ï¼š</strong> æª¢æ¸¬åˆ°å¾æœ¬åœ°æª”æ¡ˆç³»çµ±é–‹å•Ÿ<br>
                    <strong>è§£æ±ºæ–¹å¼ï¼š</strong><br>
                    1. å°‡æ­¤ HTML æª”æ¡ˆä¸Šå‚³åˆ°ä½ çš„ Netlify å°ˆæ¡ˆæ ¹ç›®éŒ„<br>
                    2. è¨ªå• <code>https://twstock-analysis.netlify.app/test-api.html</code><br>
                    3. æˆ–ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨ï¼ˆå¦‚ Live Server æ’ä»¶ï¼‰é–‹å•Ÿ
                `;
            }
        };
    </script>
</body>
</html>